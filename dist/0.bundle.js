webpackJsonp([0],{2053:function(e,t,r){!function(t,r){e.exports=r()}(0,function(){return function(e){function t(n){if(r[n])return r[n].exports;var l=r[n]={exports:{},id:n,loaded:!1};return e[n].call(l.exports,l,l.exports,t),l.loaded=!0,l.exports}var r={};return t.m=e,t.c=r,t.p="/dist/",t(0)}([function(e,t,r){e.exports=r(1)},function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),l=r(2),o=r(3),i=r(4),a=(r(5),r(6)),s=r(14),c=(function(e){e&&e.__esModule}(r(15)),r(8)),u=r(16);o.globals.canYoutube=!1,o.globals.canSetHTMLColors=!1;var h=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return n(e,[{key:"start",value:function(e,t){this.node=e,i.globals.onWinGame||(i.globals.onWinGame=function(){}),i.globals.curlevel=0,i.globals.curlevelTarget=null,this._load(),(0,c.addListeners)(this.node),(0,u.addListeners)(this.node),(0,u.startGameLoop)(),(0,l.setCanvas)(this.node),(0,a.init)(),(0,s.compile)(["restart"],t)}},{key:"pause",value:function(){(0,u.stopGameLoop)(),(0,u.removeListeners)(this.node)}},{key:"resume",value:function(){(0,u.startGameLoop)(),(0,u.addListeners)(this.node)}},{key:"stop",value:function(){(0,c.removeListeners)(this.node),(0,u.removeListeners)(this.node),(0,u.stopGameLoop)(),i.globals.curlevel=0,i.globals.curlevelTarget=null}},{key:"setSaver",value:function(e){i.globals.stateSaver=e}},{key:"setLoader",value:function(e){this._loader=e}},{key:"setOnWinGame",value:function(e){i.globals.onWinGame=e}},{key:"_load",value:function(){var e=this._loader(),t=e.level,r=e.checkpoint;if(i.globals.curlevel=t,r){var n=[];for(var l in Object.getOwnPropertyNames(r.dat))n[l]=r.dat[l];r.dat=new Int32Array(n),i.globals.curlevelTarget=r}}},{key:"useDefaultSaveAndLoad",value:function(e){this.setSaver(function(t,r){var n=e,l=n+"_checkpoint";window.localStorage.setItem(n,t),r?window.localStorage.setItem(l,JSON.stringify(r)):window.localStorage.removeItem(l)}),this.setLoader(function(){var t=e,r=t+"_checkpoint",n=window.localStorage.getItem(t),l=window.localStorage.getItem(r),o=void 0;return l&&(o=JSON.parse(l)),{level:n,checkpoint:o}})}}]),e}();t.default=new h,e.exports=t.default},function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.setCanvas=function(e){r.canvas=e},t.getCtx=function(){return r.canvas.getContext("2d")};var r={canvas:null,cellwidth:null,cellheight:null,magnification:null,xoffset:null,yoffset:null,x:0,y:0,canvasdict:{},lastDownTarget:null,forceRegenImages:!1};t.globals=r},function(e,t){function r(e){var t=document.createElement("div");t.innerHTML=e;return t.textContent||t.innerText||""}Object.defineProperty(t,"__esModule",{value:!0}),t.stripTags=r,t.consolePrint=function(e){},t.consoleCacheDump=function(e){},t.consoleError=function(e,t){var n=document.getElementById("errormessage");e=r(e),n.innerHTML+=e+"<br>"},t.logErrorNoLine=function(e){var t=document.getElementById("errormessage");e=r(e),t.innerHTML+=e+"<br>"},t.logBetaMessage=function(e){var t=document.getElementById("errormessage");e=r(e),t.innerHTML+=e+"<br>"},t.clearInputHistory=function(){},t.pushInput=function(e){};t.globals={canSetHTMLColors:!0,canDump:!1,canOpenEditor:!1,canYoutube:!0,IDE:!1}},function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r={unitTesting:!1,curlevel:0,curlevelTarget:null,levelEditorOpened:!1,verbose_logging:!1,throttle_movement:!1,cache_console_messages:!1,quittingTitleScreen:!1,quittingMessageScreen:!1,deltatime:17,timer:0,repeatinterval:150,autotick:0,autotickinterval:0,winning:!1,againing:!1,againinterval:150,norepeat_action:!1,oldflickscreendat:[],keybuffer:[],messageselected:!1,textImages:{},level:{width:5,height:5,layerCount:2,dat:[1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2,3,2,1,3,2,1,3,2,1,3,1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2],movementMask:[1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2,3,2,1,3,2,1,3,2,1,3,1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2],rigidGroupIndexMask:[],rigidMovementAppliedMask:[],bannedGroup:[],colCellContents:[],rowCellContents:[]}};t.globals=r},function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=["..................................","..................................","..................................","..................................","..................................",".............new game.............","..................................","...........#.continue.#...........","..................................",".arrow keys to move...............",".X to action......................",".Z to undo, R to restart..........",".................................."],n={title:"2D Whale World",attribution:"increpare",objectCount:2,metadata:[],levels:[],bgcolor:"#000000",fgcolor:"#FFFFFF"},l={titletemplate_select1:r,titleImage:[],titleWidth:r[0].length,titleHeight:r.length,textMode:!0,titleScreen:!0,titleMode:0,titleSelection:0,titleSelected:!1,introstate:n,state:n,messagetext:"",STRIDE_OBJ:1,STRIDE_MOV:1,zoomscreen:!1,flickscreen:!1,screenwidth:0,screenheight:0,matchCache:{}};t.globals=l},function(e,t,r){function n(){if(te.globals.titleMode=le.globals.curlevel>0||null!==le.globals.curlevelTarget?1:0,0!==te.globals.state.levels.length){var e="PuzzleScript Game";void 0!==te.globals.state.metadata.title&&(e=te.globals.state.metadata.title),0===te.globals.titleMode?te.globals.titleSelected?te.globals.titleImage=l(fe):te.globals.titleImage=l(ue):0===te.globals.titleSelection?te.globals.titleSelected?te.globals.titleImage=l(ge):te.globals.titleImage=l(he):te.globals.titleSelected?te.globals.titleImage=l(de):te.globals.titleImage=l(te.globals.titletemplate_select1);var t="noaction"in te.globals.state.metadata,r="noundo"in te.globals.state.metadata,n="norestart"in te.globals.state.metadata;r&&n?te.globals.titleImage[11]="..................................":r?te.globals.titleImage[11]=".R to restart.....................":n&&(te.globals.titleImage[11]=".Z to undo....................."),t&&(te.globals.titleImage[10]="..................................");for(s=0;s<te.globals.titleImage.length;s++)te.globals.titleImage[s]=te.globals.titleImage[s].replace(/\./g," ");for(var i=te.globals.titleImage[0].length,a=o(e,te.globals.titleImage[0].length),s=0;s<a.length;s++){var c=a[s],u=c.length,h=(i-u)/2|0,f=te.globals.titleImage[1+s];te.globals.titleImage[1+s]=f.slice(0,h)+c+f.slice(h+c.length)}if(void 0!==te.globals.state.metadata.author)for(var g=o("by "+te.globals.state.metadata.author,te.globals.titleImage[0].length),s=0;s<g.length;s++){var d=g[s]+" ";d.length>i&&(d=d.slice(0,i));f=te.globals.titleImage[3+s];te.globals.titleImage[3+s]=f.slice(0,i-d.length)+d}}else te.globals.titleImage=se}function l(e){if(!e)return e;if([Number,String,Boolean].forEach(function(r){e instanceof r&&(t=r(e))}),void 0===t)if("[object Array]"===Object.prototype.toString.call(e))t=[],e.forEach(function(e,r,n){t[r]=l(e)});else if("object"==typeof e)if(e.nodeType&&"function"==typeof e.cloneNode)var t=e.cloneNode(!0);else if(e.prototype)t=e;else if(e instanceof Date)t=new Date(e);else{t={};for(var r in e)t[r]=l(e[r])}else t=e;return t}function o(e,t){t=t||75;if(!e)return e;var r=".{1,"+t+"}(\\s|$)|.{"+t+"}|.+$";return e.match(RegExp(r,"g"))}function i(){te.globals.titleMode=0,te.globals.textMode=!0,te.globals.titleImage=l(ce);for(r=0;r<te.globals.titleImage.length;r++)te.globals.titleImage[r]=te.globals.titleImage[r].replace(/\./g," ");var e,t=te.globals.titleImage[0].length;if(""===te.globals.messagetext){e=te.globals.state.levels[le.globals.curlevel].message.trim()}else e=te.globals.messagetext;pe=o(e,te.globals.titleImage[0].length);for(var r=0;r<pe.length;r++){var n=pe[r],i=5-(pe.length/2|0)+r,a=n.length,s=(t-a)/2|0,c=te.globals.titleImage[i];te.globals.titleImage[i]=c.slice(0,s)+n+c.slice(s+n.length)}le.globals.quittingMessageScreen&&(te.globals.titleImage[10]=te.globals.titleImage[9]),(0,ee.canvasResize)()}function a(e,t,r){null==r&&(r=(Math.random()+Date.now()).toString()),ve=r,ae=new $.RNG(ve),re.globals.forceRegenImages=!0,te.globals.titleScreen=!1,te.globals.titleMode=le.globals.curlevel>0||null!==le.globals.curlevelTarget?1:0,te.globals.titleSelection=le.globals.curlevel>0||null!==le.globals.curlevelTarget?1:0,te.globals.titleSelected=!1,le.globals.againing=!1,void 0!==t?(void 0===t.message?(te.globals.titleMode=0,te.globals.textMode=!1,le.globals.level=t.clone(),y(),be=[],Z=b(),"run_rules_on_level_start"in e.metadata&&U(-1,!0)):(m(),i(),(0,ee.canvasResize)()),(0,ne.clearInputHistory)()):(0,ne.consolePrint)("Trying to access a GAME.level that doesn't exist.",!0)}function s(e,t,r,n){var l=r;le.globals.curlevel=t,le.globals.curlevelTarget=r,void 0===l.message&&g(),a(e,e.levels[t],n),w(r),Z=r}function c(e,t,r){var n=e.levels[t];le.globals.curlevel=t,le.globals.curlevelTarget=null,void 0===n.message&&g(),a(e,n,r)}function u(e){if(void 0!==te.globals.state.sfx_Events[e]){var t=te.globals.state.sfx_Events[e];(0,ie.playSound)(t)}}function h(){u("titlescreen")}function f(){u("endgame")}function g(){u("startlevel")}function d(){u("endlevel")}function p(){u("undo")}function v(){u("restart")}function m(){u("showmessage")}function b(){return{dat:new Int32Array(le.globals.level.objects),width:le.globals.level.width,height:le.globals.level.height,oldflickscreendat:le.globals.oldflickscreendat.concat([])}}function y(){le.globals.level.movements=new Int32Array(le.globals.level.n_tiles*te.globals.STRIDE_MOV),le.globals.level.rigidMovementAppliedMask=[],le.globals.level.rigidGroupIndexMask=[],le.globals.level.rowCellContents=[],le.globals.level.colCellContents=[],le.globals.level.mapCellContents=new I(te.globals.STRIDE_OBJ),ke=new I(te.globals.STRIDE_MOV),t._o1=Me=new I(te.globals.STRIDE_OBJ),t._o2=Se=new I(te.globals.STRIDE_OBJ),t._o2_5=Ee=new I(te.globals.STRIDE_OBJ),t._o3=Le=new I(te.globals.STRIDE_OBJ),t._o4=Te=new I(te.globals.STRIDE_OBJ),t._o5=Ie=new I(te.globals.STRIDE_OBJ),t._o6=Re=new I(te.globals.STRIDE_OBJ),t._o7=Oe=new I(te.globals.STRIDE_OBJ),t._o8=Ae=new I(te.globals.STRIDE_OBJ),t._o9=De=new I(te.globals.STRIDE_OBJ),t._o10=Ne=new I(te.globals.STRIDE_OBJ),t._o11=Pe=new I(te.globals.STRIDE_OBJ),t._o12=Be=new I(te.globals.STRIDE_OBJ),t._m1=Fe=new I(te.globals.STRIDE_MOV),t._m2=je=new I(te.globals.STRIDE_MOV),t._m3=He=new I(te.globals.STRIDE_MOV);for(e=0;e<le.globals.level.height;e++)le.globals.level.rowCellContents[e]=new I(te.globals.STRIDE_OBJ);for(e=0;e<le.globals.level.width;e++)le.globals.level.colCellContents[e]=new I(te.globals.STRIDE_OBJ);for(var e=0;e<le.globals.level.n_tiles;e++)le.globals.level.rigidMovementAppliedMask[e]=new I(te.globals.STRIDE_MOV),le.globals.level.rigidGroupIndexMask[e]=new I(te.globals.STRIDE_MOV)}function w(e){if(le.globals.oldflickscreendat=e.oldflickscreendat.concat([]),le.globals.level.objects=new Int32Array(e.dat),le.globals.level.width!==e.width||le.globals.level.height!==e.height)le.globals.level.width=e.width,le.globals.level.height=e.height,le.globals.level.n_tiles=e.width*e.height,y();else{for(t=0;t<le.globals.level.n_tiles;t++)le.globals.level.movements[t]=0,le.globals.level.rigidMovementAppliedMask[t]=0,le.globals.level.rigidGroupIndexMask[t]=0;for(t=0;t<le.globals.level.height;t++){le.globals.level.rowCellContents[t].setZero()}for(var t=0;t<le.globals.level.width;t++){le.globals.level.colCellContents[t].setZero()}}le.globals.againing=!1,le.globals.level.commandQueue=[]}function _(e){!0!==e&&"norestart"in te.globals.state.metadata||(!1===e&&be.push(b()),le.globals.verbose_logging&&(0,ne.consolePrint)("--- restarting ---",!0),w(Z),v(),"run_rules_on_level_start"in te.globals.state.metadata&&U(-1,!0),le.globals.level.commandQueue=[])}function x(e){if((le.globals.levelEditorOpened||!("noundo"in te.globals.state.metadata)||!0===e)&&(le.globals.verbose_logging&&(0,ne.consolePrint)("--- undoing ---",!0),be.length>0)){w(be[be.length-1]),be=be.splice(0,be.length-1),e||p()}}function k(){for(var e=[],t=te.globals.state.playerMask,r=0;r<le.globals.level.n_tiles;r++)le.globals.level.getCellInto(r,Pe),t.anyBitsInCommon(Pe)&&e.push(r);return e}function C(e){for(var t=[],r=0;r<te.globals.state.objectCount;r++)if(e.get(r)){var n=te.globals.state.idDict[r],l=te.globals.state.objects[n];t.push(l.layer)}return t}function M(e,t,r){var n=le.globals.level.getCell(e);n.iand(t);for(var l=C(n),o=le.globals.level.getMovements(e),i=0;i<l.length;i++)o.ishiftor(r,5*l[i]);le.globals.level.setMovements(e,o)}function S(e){for(var t=k(),r=0;r<t.length;r++){M(t[r],te.globals.state.playerMask,e)}return t}function E(e,t,r){var n=ye[r],l=n[0],o=n[1],i=e/le.globals.level.height|0,a=e%le.globals.level.height,s=le.globals.level.width-1,c=le.globals.level.height-1;if(0===i&&l<0||i===s&&l>0||0===a&&o<0||a===c&&o>0)return!1;var u=(e+n[1]+n[0]*le.globals.level.height)%le.globals.level.n_tiles,h=te.globals.state.layerMasks[t],f=le.globals.level.getCellInto(u,Oe),g=le.globals.level.getCellInto(e,Ae);if(h.anyBitsInCommon(f)&&16!=r)return!1;for(var d=0;d<te.globals.state.sfx_MovementMasks.length;d++){var p=te.globals.state.sfx_MovementMasks[d];if(p.objectMask.anyBitsInCommon(g)){var v=le.globals.level.getMovements(e),m=p.directionMask;v.anyBitsInCommon(m)&&-1===_e.indexOf(p.seed)&&_e.push(p.seed)}}var b=g.clone();g.iclear(h),b.iand(h),f.ior(b),le.globals.level.setCell(e,g),le.globals.level.setCell(u,f);var y=u/le.globals.level.height|0,w=u%le.globals.level.height;return le.globals.level.colCellContents[y].ior(b),le.globals.level.rowCellContents[w].ior(b),le.globals.level.mapCellContents.ior(h),!0}function L(e){var t=le.globals.level.getMovements(e);if(t.iszero())return!1;for(var r=!1,n=0;n<le.globals.level.layerCount;n++){var l=t.getshiftor(31,5*n);if(0!==l){E(e,n,l)&&(t.ishiftclear(l,5*n),r=!0)}}return le.globals.level.setMovements(e,t),r}function T(e,t,r,n,l){this.lineNumber=e,this.width=t,this.height=r,this.n_tiles=t*r,this.objects=l,this.layerCount=n,this.commandQueue=[]}function I(e){return this.data=new Int32Array(e),this}function R(e){this.direction=e[0],this.patterns=e[1],this.hasReplacements=e[2],this.lineNumber=e[3],this.isEllipsis=e[4],this.groupNumber=e[5],this.isRigid=e[6],this.commands=e[7],this.isRandom=e[8],this.cellRowMasks=e[9],this.cellRowMatches=[];for(var t=0;t<this.patterns.length;t++)this.cellRowMatches.push(this.generateCellRowMatchesFunction(this.patterns[t],this.isEllipsis[t]))}function O(e){this.objectsPresent=e[0],this.objectsMissing=e[1],this.anyObjectsPresent=e[2],this.movementsPresent=e[3],this.movementsMissing=e[4],this.matches=this.generateMatchFunction(le.globals.level),this.replacement=e[5]}function A(e,t,r,n,l){void 0===l&&(l=0);u=t[0];if(window.GAME_dot_level=le.globals.level,u.matches(r))for(var o=ye[e],i=o[0]*le.globals.level.height,a=o[1],s=r,c=1;c<t.length;c+=1){s=(s+a+i)%le.globals.level.n_tiles;var u=t[c];if(window.GAME_dot_level=le.globals.level,u===Ce){for(var h=l;h<n;h++){var f=s;f=(f+(a+i)*h+le.globals.level.n_tiles)%le.globals.level.n_tiles;for(var g=c+1;g<t.length&&(u=t[g],window.GAME_dot_level=le.globals.level,u.matches(f));g++)f=(f+a+i)%le.globals.level.n_tiles;if(g>=t.length)return!0}break}if(!u.matches(s))break}return!1}function D(e,t,r,n){var l=t[0];if(window.GAME_dot_level=le.globals.level,l.matches(r)){for(var o=ye[e],i=o[0]*le.globals.level.height,a=o[1],s=t.length,c=r,u=1;u<s&&(c=(c+a+i)%le.globals.level.n_tiles,(l=t[u])===Ce&&(c=(c+(a+i)*n)%le.globals.level.n_tiles),window.GAME_dot_level=le.globals.level,l.matches(c));u++);if(u>=t.length)return!0}return!1}function N(e,t,r,n){var l=[];if(!n.bitsSetInArray(le.globals.level.mapCellContents.data))return l;var o=0,i=le.globals.level.width,a=0,s=le.globals.level.height,c=r.length;switch(e){case 1:a+=c-1;break;case 2:s-=c-1;break;case 4:o+=c-1;break;case 8:i-=c-1;break;default:window.console.log("EEEP "+e)}if(e>2){for(h=a;h<s;h++)if(n.bitsSetInArray(le.globals.level.rowCellContents[h].data))for(u=o;u<i;u++){f=u*le.globals.level.height+h;window.GAME_dot_level=le.globals.level,t(r,f)&&l.push(f)}}else for(var u=o;u<i;u++)if(n.bitsSetInArray(le.globals.level.colCellContents[u].data))for(var h=a;h<s;h++){var f=u*le.globals.level.height+h;window.GAME_dot_level=le.globals.level,t(r,f)&&l.push(f)}return l}function P(e,t,r,n){var l=[];if(!n.bitsSetInArray(le.globals.level.mapCellContents.data))return l;var o=0,i=le.globals.level.width,a=0,s=le.globals.level.height,c=r.length-1;switch(e){case 1:a+=c-1;break;case 2:s-=c-1;break;case 4:o+=c-1;break;case 8:i-=c-1;break;default:window.console.log("EEEP2 "+e)}if(e>2){for(h=a;h<s;h++)if(n.bitsSetInArray(le.globals.level.rowCellContents[h].data))for(u=o;u<i;u++){g=u*le.globals.level.height+h;4===e?f=u-c+2:8===e?f=le.globals.level.width-(u+c)+1:window.console.log("EEEP2 "+e),window.GAME_dot_level=le.globals.level,l.push.apply(l,t(r,g,f,0))}}else for(var u=o;u<i;u++)if(n.bitsSetInArray(le.globals.level.colCellContents[u].data))for(var h=a;h<s;h++){var f,g=u*le.globals.level.height+h;2===e?f=le.globals.level.height-(h+c)+1:1===e?f=h-c+2:window.console.log("EEEP2 "+e),window.GAME_dot_level=le.globals.level,l.push.apply(l,t(r,g,f,0))}return l}function B(e){for(var t=[[]],r=0;r<e.length;r++){for(var n=e[r],l=[],o=0;o<n.length;o++)for(var i=n[o],a=0;a<t.length;a++){var s=t[a].concat([i]);l.push(s)}t=l}return t}function F(e){var t={ruleGroupIndex:e,objects:new Int32Array(le.globals.level.objects),movements:new Int32Array(le.globals.level.movements),rigidGroupIndexMask:le.globals.level.rigidGroupIndexMask.concat([]),rigidMovementAppliedMask:le.globals.level.rigidMovementAppliedMask.concat([]),bannedGroup:le.globals.level.bannedGroup.concat([])};return We[e]=t,t}function j(e){le.globals.level.objects=new Int32Array(e.objects),le.globals.level.movements=new Int32Array(e.movements),le.globals.level.rigidGroupIndexMask=e.rigidGroupIndexMask.concat([]),le.globals.level.rigidMovementAppliedMask=e.rigidMovementAppliedMask.concat([]),ze=new I(te.globals.STRIDE_OBJ),qe=new I(te.globals.STRIDE_OBJ)}function H(){le.globals.keybuffer=[],te.globals.textMode=!0,te.globals.titleScreen=!1,le.globals.quittingMessageScreen=!1,le.globals.messageselected=!1,m(),i(),(0,ee.canvasResize)()}function W(e){for(var t=[],r=0;r<e.length;r++){var n=(a=e[r]).findMatches();if(n.length>0)for(var l=B(n),o=0;o<l.length;o++){c=l[o];t.push([r,c])}}if(0===t.length)return!1;var i=t[Math.floor(ae.uniform()*t.length)],a=e[r=i[0]],s=ye[a.direction],c=i[1],u=a.applyAt(s,c,!1);return a.queueCommands(),u}function z(e){if(e[0].isRandom)return W(e);for(var t=!1,r=!0,n=0;r;){if(++n>200){(0,oe.logErrorCacheable)("Got caught looping lots in a rule group :O",e[0].lineNumber,!0);break}r=!1;for(var l=0;l<e.length;l++){r=e[l].tryApply()||r}r&&(t=!0)}return t}function q(e,t,r,n){for(var l=r>0,o=0,i=r;i<e.length;){if(n&&n[i]);else{l=z(a=e[i])||l}if(l&&void 0!==t[i]){if(i=t[i],l=!1,++o>200){a=e[i];(0,oe.logErrorCacheable)("got caught in an endless startloop...endloop vortex, escaping!",a[0].lineNumber,!0);break}}else if(++i===e.length&&l&&void 0!==t[i]&&(i=t[i],l=!1,++o>200)){var a=e[i];(0,oe.logErrorCacheable)("got caught in an endless startloop...endloop vortex, escaping!",a[0].lineNumber,!0);break}}}function G(e){for(var t=!0;t;){t=!1;for(n=0;n<le.globals.level.n_tiles;n++)t=L(n)||t}for(var r=!1,n=0;n<le.globals.level.n_tiles;n++){var l=le.globals.level.getCellInto(n,Re),o=le.globals.level.getMovements(n);if(!o.iszero()){var i=le.globals.level.rigidMovementAppliedMask[n];if(0!==i&&(o.iand(i),!o.iszero()))for(h=0;h<le.globals.level.layerCount;h++){if(0!==o.getshiftor(31,5*h)){var a=le.globals.level.rigidGroupIndexMask[n].getshiftor(31,5*h);a--;var s=te.globals.state.rigidGroupIndex_to_GroupIndex[a];le.globals.level.bannedGroup[s]=!0,r=!0;break}}for(h=0;h<te.globals.state.sfx_MovementFailureMasks.length;h++){var c=te.globals.state.sfx_MovementFailureMasks[h];if(c.objectMask.anyBitsInCommon(l)){var u=c.directionMask;o.anyBitsInCommon(u)&&-1===xe.indexOf(c.seed)&&xe.push(c.seed)}}}for(var h=0;h<te.globals.STRIDE_MOV;h++)le.globals.level.movements[h+n*te.globals.STRIDE_MOV]=0;le.globals.level.rigidGroupIndexMask[n]=0,le.globals.level.rigidMovementAppliedMask[n]=0}return r}function V(){for(e=0;e<le.globals.level.mapCellContents.length;e++)le.globals.level.mapCellContents[e]=0;for(e=0;e<le.globals.level.width;e++){le.globals.level.colCellContents[e].setZero()}for(e=0;e<le.globals.level.height;e++){le.globals.level.rowCellContents[e].setZero()}for(var e=0;e<le.globals.level.width;e++)for(var t=0;t<le.globals.level.height;t++){var r=t+e*le.globals.level.height,n=le.globals.level.getCellInto(r,De);le.globals.level.mapCellContents.ior(n),le.globals.level.rowCellContents[t].ior(n),le.globals.level.colCellContents[e].ior(n)}}function U(e,t,r){le.globals.againing=!1,le.globals.verbose_logging&&(-1===e?(0,ne.consolePrint)("Turn starts with no input."):((0,ne.consolePrint)("======================="),(0,ne.consolePrint)("Turn starts with input of "+["up","left","down","right","action"][e]+".")));var n=b(),l=[];if(e<=4){if(e>=0){switch(e){case 0:e=parseInt("00001",2);break;case 1:e=parseInt("00100",2);break;case 2:e=parseInt("00010",2);break;case 3:e=parseInt("01000",2);break;case 4:e=parseInt("10000",2)}l=S(e)}c=0;le.globals.level.bannedGroup=[],We=[],le.globals.level.commandQueue=[];var o=0,i=!1,a=F();ze=new I(te.globals.STRIDE_OBJ),qe=new I(te.globals.STRIDE_OBJ),_e=[],xe=[],V();do{i=!1,c++,le.globals.verbose_logging&&(0,ne.consolePrint)("applying rules"),q(te.globals.state.rules,te.globals.state.loopPoint,o,le.globals.level.bannedGroup);G()?(i=!0,j(a),o=0):(le.globals.verbose_logging&&(0,ne.consolePrint)("applying late rules"),q(te.globals.state.lateRules,te.globals.state.lateLoopPoint,0),o=0)}while(c<50&&i);if(c>=50&&(0,ne.consolePrint)("looped through 50 times, gave up.  too many loops!"),l.length>0&&void 0!==te.globals.state.metadata.require_player_movement){for(var s=!1,c=0;c<l.length;c++){var h=l[c],f=le.globals.level.getCell(h);if(te.globals.state.playerMask.bitsClearInArray(f.data)){s=!0;break}}if(!1===s)return le.globals.verbose_logging&&((0,ne.consolePrint)("require_player_movement set, but no player movement detected, so cancelling turn."),consoleCacheDump()),be.push(n),x(!0),!1}if(le.globals.level.commandQueue.indexOf("cancel")>=0)return le.globals.verbose_logging&&((0,ne.consolePrint)("CANCEL command executed, cancelling turn."),consoleCacheDump()),be.push(n),x(!0),!1;if(le.globals.level.commandQueue.indexOf("restart")>=0)return le.globals.verbose_logging&&((0,ne.consolePrint)("RESTART command executed, reverting to restart state."),consoleCacheDump()),be.push(n),_(!0),!0;if(r&&le.globals.level.commandQueue.indexOf("win")>=0)return!0;for(var g=!1,c=0;c<le.globals.level.objects.length;c++)if(le.globals.level.objects[c]!==n.dat[c]){if(r)return le.globals.verbose_logging&&consoleCacheDump(),be.push(n),x(!0),!0;-1!==e&&be.push(n),g=!0;break}if(r)return le.globals.verbose_logging&&consoleCacheDump(),!1;for(c=0;c<xe.length;c++)(0,ie.playSound)(xe[c]);for(c=0;c<_e.length;c++)(0,ie.playSound)(_e[c]);for(c=0;c<te.globals.state.sfx_CreationMasks.length;c++){d=te.globals.state.sfx_CreationMasks[c];ze.anyBitsInCommon(d.objectMask)&&(0,ie.playSound)(d.seed)}for(c=0;c<te.globals.state.sfx_DestructionMasks.length;c++){var d=te.globals.state.sfx_DestructionMasks[c];qe.anyBitsInCommon(d.objectMask)&&(0,ie.playSound)(d.seed)}for(c=0;c<le.globals.level.commandQueue.length;c++){var p=le.globals.level.commandQueue[c];"f"===p.charAt(1)&&u(p),!1===le.globals.unitTesting&&"message"===p&&H()}if(!1!==te.globals.textMode||void 0!==t&&!1!==t||(le.globals.verbose_logging&&(0,ne.consolePrint)("Checking win condition."),J()),!le.globals.winning&&(le.globals.level.commandQueue.indexOf("checkpoint")>=0&&(le.globals.verbose_logging&&(0,ne.consolePrint)("CHECKPOINT command executed, saving current state to the restart state."),Z=b(),le.globals.curlevelTarget=Z,le.globals.stateSaver(le.globals.curlevel,Z)),le.globals.level.commandQueue.indexOf("again")>=0&&g)){var v=le.globals.verbose_logging,m=te.globals.messagetext;le.globals.verbose_logging=!1,U(-1,!0,!0)?(le.globals.verbose_logging=v,le.globals.verbose_logging&&(0,ne.consolePrint)("AGAIN command executed, with changes detected - will execute another turn."),le.globals.againing=!0,le.globals.timer=0):(le.globals.verbose_logging=v,le.globals.verbose_logging&&(0,ne.consolePrint)("AGAIN command not executed, it wouldn't make any changes.")),le.globals.verbose_logging=v,te.globals.messagetext=m}le.globals.level.commandQueue=[]}return le.globals.verbose_logging&&consoleCacheDump(),le.globals.winning&&(le.globals.againing=!1),g}function J(){if(!le.globals.levelEditorOpened){if(le.globals.level.commandQueue.indexOf("win")>=0)return(0,ne.consolePrint)("Win Condition Satisfied"),void Y();var e=!1;if(te.globals.state.winconditions.length>0){for(var t=!0,r=0;r<te.globals.state.winconditions.length;r++){var n=te.globals.state.winconditions[r],l=n[1],o=n[2],i=!0;switch(n[0]){case-1:for(s=0;s<le.globals.level.n_tiles;s++){c=le.globals.level.getCellInto(s,Ne);if(!l.bitsClearInArray(c.data)&&!o.bitsClearInArray(c.data)){i=!1;break}}break;case 0:for(var a=!1,s=0;s<le.globals.level.n_tiles;s++){c=le.globals.level.getCellInto(s,Ne);if(!l.bitsClearInArray(c.data)&&!o.bitsClearInArray(c.data)){a=!0;break}}!1===a&&(i=!1);break;case 1:for(s=0;s<le.globals.level.n_tiles;s++){var c=le.globals.level.getCellInto(s,Ne);if(!l.bitsClearInArray(c.data)&&o.bitsClearInArray(c.data)){i=!1;break}}}!1===i&&(t=!1)}e=t}e&&((0,ne.consolePrint)("Win Condition Satisfied"),Y())}}function Y(){le.globals.winning||(le.globals.againing=!1,d(),le.globals.unitTesting?K():(le.globals.winning=!0,le.globals.timer=0))}function K(){le.globals.keybuffer=[],le.globals.againing=!1,te.globals.messagetext="",te.globals.titleScreen?(0===te.globals.titleSelection&&(le.globals.curlevel=0,le.globals.curlevelTarget=null),null!==le.globals.curlevelTarget?s(te.globals.state,le.globals.curlevel,le.globals.curlevelTarget):c(te.globals.state,le.globals.curlevel)):le.globals.curlevel<te.globals.state.levels.length-1?(le.globals.curlevel++,te.globals.textMode=!1,te.globals.titleScreen=!1,le.globals.quittingMessageScreen=!1,le.globals.messageselected=!1,null!==le.globals.curlevelTarget?s(te.globals.state,le.globals.curlevel,le.globals.curlevelTarget):c(te.globals.state,le.globals.curlevel)):(le.globals.curlevel=0,le.globals.curlevelTarget=null,X(),f(),le.globals.onWinGame()),le.globals.stateSaver(le.globals.curlevel,le.globals.curlevelTarget),(0,ee.canvasResize)(),(0,ne.clearInputHistory)()}function X(){le.globals.againing=!1,te.globals.messagetext="",te.globals.titleScreen=!0,te.globals.textMode=!0,te.globals.titleSelection=le.globals.curlevel>0||null!==le.globals.curlevelTarget?1:0,n()}Object.defineProperty(t,"__esModule",{value:!0}),t.unloadGame=function(){te.globals.state=te.globals.introstate,le.globals.level=new T(0,5,5,2,null),le.globals.level.objects=new Int32Array(0),n(),(0,ee.canvasResize)(),redraw()},t.generateTitleScreen=n,t.deepClone=l,t.wordwrap=o,t.drawMessageScreen=i,t.loadLevelFromLevelDat=a,t.loadLevelFromStateTarget=s,t.loadLevelFromState=c,t.init=function(){n(),(0,ee.canvasResize)()},t.tryPlaySimpleSound=u,t.tryPlayTitleSound=h,t.tryPlayStartGameSound=function(){u("startgame")},t.tryPlayEndGameSound=f,t.tryPlayStartLevelSound=g,t.tryPlayEndLevelSound=d,t.tryPlayUndoSound=p,t.tryPlayRestartSound=v,t.tryPlayShowMessageSound=m,t.tryPlayCloseMessageSound=function(){u("closemessage")},t.backupLevel=b,t.setGameState=function(e,r,l){le.globals.oldflickscreendat=[],le.globals.timer=0,le.globals.autotick=0,le.globals.winning=!1,le.globals.againing=!1,le.globals.messageselected=!1,te.globals.STRIDE_MOV=e.STRIDE_MOV,te.globals.STRIDE_OBJ=e.STRIDE_OBJ,void 0===r&&(r=["restart"]),0===te.globals.state.levels.length&&r.length>0&&"rebuild"===r[0]&&(r=["restart"]),void 0===l&&(l=null),ae=new $.RNG(l),te.globals.state=e,window.console.log("setting game state :D "),be=[],t.sprites=me=[];for(var o in te.globals.state.objects)if(te.globals.state.objects.hasOwnProperty(o)){var i=te.globals.state.objects[o],a={colors:i.colors,dat:i.spritematrix};me[i.id]=a}switch(void 0!==te.globals.state.metadata.realtime_interval?(le.globals.autotick=0,le.globals.autotickinterval=1e3*te.globals.state.metadata.realtime_interval):(le.globals.autotick=0,le.globals.autotickinterval=0),void 0!==te.globals.state.metadata.key_repeat_interval?le.globals.repeatinterval=1e3*te.globals.state.metadata.key_repeat_interval:le.globals.repeatinterval=150,void 0!==te.globals.state.metadata.again_interval?le.globals.againinterval=1e3*te.globals.state.metadata.again_interval:le.globals.againinterval=150,le.globals.throttle_movement&&0===le.globals.autotickinterval&&logWarning("GAME.throttle_movement is designed for use in conjunction with realtime_interval. Using it in other situations makes games gross and unresponsive, broadly speaking.  Please don't."),le.globals.norepeat_action=void 0!==te.globals.state.metadata.norepeat_action,r[0]){case"restart":le.globals.winning=!1,le.globals.timer=0,te.globals.titleScreen=!0,h(),te.globals.textMode=!0,te.globals.titleSelection=le.globals.curlevel>0||null!==le.globals.curlevelTarget?1:0,te.globals.titleSelected=!1,le.globals.quittingMessageScreen=!1,le.globals.quittingTitleScreen=!1,le.globals.messageselected=!1,te.globals.titleMode=0,(le.globals.curlevel>0||null!==le.globals.curlevelTarget)&&(te.globals.titleMode=1),n();break;case"rebuild":break;case"loadLevel":var s=r[1];le.globals.curlevel=f,le.globals.winning=!1,le.globals.timer=0,te.globals.titleScreen=!1,te.globals.textMode=!1,te.globals.titleSelection=le.globals.curlevel>0||null!==le.globals.curlevelTarget?1:0,te.globals.titleSelected=!1,le.globals.quittingMessageScreen=!1,le.globals.quittingTitleScreen=!1,le.globals.messageselected=!1,te.globals.titleMode=0,c(te.globals.state,s,l);break;case"levelline":for(var u=r[1],f=te.globals.state.levels.length-1;f>=0;f--)if(te.globals.state.levels[f].lineNumber<=u+1){le.globals.curlevel=f,le.globals.winning=!1,le.globals.timer=0,te.globals.titleScreen=!1,te.globals.textMode=!1,te.globals.titleSelection=le.globals.curlevel>0||null!==le.globals.curlevelTarget?1:0,te.globals.titleSelected=!1,le.globals.quittingMessageScreen=!1,le.globals.quittingTitleScreen=!1,le.globals.messageselected=!1,te.globals.titleMode=0,c(te.globals.state,f);break}}if("rebuild"!==r[0]&&(0,ne.clearInputHistory)(),(0,ee.canvasResize)(),ne.globals.canYoutube&&"youtube"in te.globals.state.metadata){var g=te.globals.state.metadata.youtube,d="https://youtube.googleapis.com/v/"+g+"?autoplay=1&loop=1&playlist="+g;(Q=document.createElement("IFRAME")).setAttribute("src",d),Q.style.visibility="hidden",Q.style.width="500px",Q.style.height="500px",Q.style.position="absolute",Q.style.top="-1000px",Q.style.left="-1000px",document.body.appendChild(Q)}},t.RebuildLevelArrays=y,t.restoreLevel=w,t.DoRestart=_,t.DoUndo=x,t.getPlayerPositions=k,t.getLayersOfMask=C,t.moveEntitiesAtIndex=M,t.startMovement=S,t.repositionEntitiesOnLayer=E,t.repositionEntitiesAtCell=L,t.Level=T,t.BitVec=I,t.Rule=R,t.CellPattern=O,t.CellReplacement=function(e){this.objectsClear=e[0],this.objectsSet=e[1],this.movementsClear=e[2],this.movementsSet=e[3],this.movementsLayerMask=e[4],this.randomEntityMask=e[5],this.randomDirMask=e[6]},t.DoesCellRowMatchWildCard=A,t.DoesCellRowMatch=D,t.matchCellRow=N,t.matchCellRowWildCard=P,t.generateTuples=B,t.commitPreservationState=F,t.restorePreservationState=j,t.showTempMessage=H,t.applyRandomRuleGroup=W,t.applyRuleGroup=z,t.applyRules=q,t.resolveMovements=G,t.calculateRowColMasks=V,t.processInput=U,t.checkWin=J,t.DoWin=Y,t.nextLevel=K,t.goToTitleScreen=X;var Q,Z,$=r(7),ee=r(8),te=r(5),re=r(2),ne=r(3),le=r(4),oe=r(10),ie=r(13),ae=new $.RNG,se=["..................................","..................................","..................................","......Puzzle Script Terminal......","..............v 1.0...............","..................................","..................................","..................................",".........insert cartridge.........","..................................","..................................","..................................",".................................."],ce=["..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..........X to continue...........","..................................",".................................."],ue=["..................................","..................................","..................................","..................................","..................................","..................................","..........#.start game.#..........","..................................","..................................",".arrow keys to move...............",".X to action......................",".Z to undo, R to restart..........",".................................."],he=["..................................","..................................","..................................","..................................","..................................","...........#.new game.#...........","..................................",".............continue.............","..................................",".arrow keys to move...............",".X to action......................",".Z to undo, R to restart..........",".................................."],fe=["..................................","..................................","..................................","..................................","..................................","..................................","###########.start game.###########","..................................","..................................",".arrow keys to move...............",".X to action......................",".Z to undo, R to restart..........",".................................."],ge=["..................................","..................................","..................................","..................................","..................................","############.new game.############","..................................",".............continue.............","..................................",".arrow keys to move...............",".X to action......................",".Z to undo, R to restart..........",".................................."],de=["..................................","..................................","..................................","..................................","..................................",".............new game.............","..................................","############.continue.############","..................................",".arrow keys to move...............",".X to action......................",".Z to undo, R to restart..........",".................................."],pe=[],ve=0,me=[{color:"#423563",dat:[[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1]]},{color:"#252342",dat:[[0,0,1,0,0],[1,1,1,1,1],[0,0,1,0,0],[0,1,1,1,0],[0,1,0,1,0]]}],be=[],ye={1:[0,-1],2:[0,1],4:[-1,0],8:[1,0],15:[0,0],16:[0,0],3:[0,0]},we={1:"up",2:"down",4:"left",8:"right",15:"?",16:"action",3:"no"},_e=[],xe=[];T.prototype.clone=function(){var e=new T(this.lineNumber,this.width,this.height,this.layerCount,null);return e.objects=new Int32Array(this.objects),e},T.prototype.getCell=function(e){return new I(this.objects.subarray(e*te.globals.STRIDE_OBJ,e*te.globals.STRIDE_OBJ+te.globals.STRIDE_OBJ))},T.prototype.getCellInto=function(e,t){for(var r=0;r<te.globals.STRIDE_OBJ;r++)t.data[r]=this.objects[e*te.globals.STRIDE_OBJ+r];return t},T.prototype.setCell=function(e,t){for(var r=0;r<t.data.length;++r)this.objects[e*te.globals.STRIDE_OBJ+r]=t.data[r]};var ke;T.prototype.getMovements=function(e){for(var t=0;t<te.globals.STRIDE_MOV;t++)ke.data[t]=this.movements[e*te.globals.STRIDE_MOV+t];return ke},T.prototype.setMovements=function(e,t){for(var r=0;r<t.data.length;++r)this.movements[e*te.globals.STRIDE_MOV+r]=t.data[r]};var Ce=["ellipsis"];I.prototype.cloneInto=function(e){for(var t=0;t<this.data.length;++t)e.data[t]=this.data[t];return e},I.prototype.clone=function(){return new I(this.data)},I.prototype.iand=function(e){for(var t=0;t<this.data.length;++t)this.data[t]&=e.data[t]},I.prototype.ior=function(e){for(var t=0;t<this.data.length;++t)this.data[t]|=e.data[t]},I.prototype.iclear=function(e){for(var t=0;t<this.data.length;++t)this.data[t]&=~e.data[t]},I.prototype.ibitset=function(e){this.data[e>>5]|=1<<(31&e)},I.prototype.ibitclear=function(e){this.data[e>>5]&=~(1<<(31&e))},I.prototype.get=function(e){return 0!=(this.data[e>>5]&1<<(31&e))},I.prototype.getshiftor=function(e,t){var r=31&t,n=this.data[t>>5]>>>r;return r&&(n|=this.data[1+(t>>5)]<<32-r),n&e},I.prototype.ishiftor=function(e,t){var r=31&t,n=e<<r;if(this.data[t>>5]|=n,r){var l=e>>32-r;this.data[1+(t>>5)]|=l}},I.prototype.ishiftclear=function(e,t){var r=31&t,n=e<<r;if(this.data[t>>5]&=~n,r){var l=e>>32-(31&t);this.data[1+(t>>5)]&=~l}},I.prototype.equals=function(e){if(this.data.length!==e.data.length)return!1;for(var t=0;t<this.data.length;++t)if(this.data[t]!==e.data[t])return!1;return!0},I.prototype.setZero=function(){for(var e=0;e<this.data.length;++e)this.data[e]=0},I.prototype.iszero=function(){for(var e=0;e<this.data.length;++e)if(this.data[e])return!1;return!0},I.prototype.bitsSetInArray=function(e){for(var t=0;t<this.data.length;++t)if((this.data[t]&e[t])!==this.data[t])return!1;return!0},I.prototype.bitsClearInArray=function(e){for(var t=0;t<this.data.length;++t)if(this.data[t]&e[t])return!1;return!0},I.prototype.anyBitsInCommon=function(e){return!this.bitsClearInArray(e.data)},R.prototype.generateCellRowMatchesFunction=function(e,t){if(0==t){for(var r=(s=ye[this.direction])[0],n=s[1],l=e.length,o="var d = "+n+"+"+r+"*window.GAME_dot_level.height;\n",i=1===te.globals.STRIDE_OBJ?"":"*"+te.globals.STRIDE_OBJ,a=0;a<te.globals.STRIDE_OBJ;++a)o+="var cellObjects"+a+" = window.GAME_dot_level.objects[i"+i+(a?"+"+a:"")+"];\n";i=1===te.globals.STRIDE_MOV?"":"*"+te.globals.STRIDE_MOV;for(a=0;a<te.globals.STRIDE_MOV;++a)o+="var cellMovements"+a+" = window.GAME_dot_level.movements[i"+i+(a?"+"+a:"")+"];\n";o+="return "+e[0].generateMatchString("0_");for(c=1;c<l;c++)o+="&&cellRow["+c+"].matches((i+"+c+"*d)%window.GAME_dot_level.n_tiles)";return(o+=";")in te.globals.matchCache?te.globals.matchCache[o]:te.globals.matchCache[o]=new Function("cellRow","i",o)}var s=ye[this.direction],r=s[0],n=s[1],l=e.length,o="var d = "+n+"+"+r+"*window.GAME_dot_level.height;\n";o+="var result = [];\n",o+="if(cellRow[0].matches(i)";for(var c=1;e[c]!==Ce;c++)o+="&&cellRow["+c+"].matches((i+"+c+"*d)%window.GAME_dot_level.n_tiles)";for(o+=") {\n",o+="\tfor (var k=kmin;k<kmax;k++) {\n",o+="\t\tif(cellRow["+ ++c+"].matches((i+d*(k+"+(c-1)+"))%window.GAME_dot_level.n_tiles)",c++;c<l;c++)o+="&&cellRow["+c+"].matches((i+d*(k+"+(c-1)+"))%window.GAME_dot_level.n_tiles)";return o+="){\n",o+="\t\t\tresult.push([i,k]);\n",o+="\t\t}\n",o+="\t}\n",o+="}\n",(o+="return result;")in te.globals.matchCache?te.globals.matchCache[o]:te.globals.matchCache[o]=new Function("cellRow","i","kmax","kmin",o)},R.prototype.toJSON=function(){return[this.direction,this.patterns,this.hasReplacements,this.lineNumber,this.isEllipsis,this.groupNumber,this.isRigid,this.commands,this.isRandom,this.cellRowMasks]},O.prototype.generateMatchString=function(){for(var e="(true",t=0;t<Math.max(te.globals.STRIDE_OBJ,te.globals.STRIDE_MOV);++t){var r="cellObjects"+t,n="cellMovements"+t,l=this.objectsPresent.data[t],o=this.objectsMissing.data[t],i=this.movementsPresent.data[t],a=this.movementsMissing.data[t];l&&(e+=l&l-1?"\t\t&& (("+r+"&"+l+")==="+l+")\n":"\t\t&& ("+r+"&"+l+")\n"),o&&(e+="\t\t&& !("+r+"&"+o+")\n"),i&&(e+=i&i-1?"\t\t&& (("+n+"&"+i+")==="+i+")\n":"\t\t&& ("+n+"&"+i+")\n"),a&&(e+="\t\t&& !("+n+"&"+a+")\n")}for(var s=0;s<this.anyObjectsPresent.length;s++){e+="\t\t&& (0";for(t=0;t<te.globals.STRIDE_OBJ;++t){var c=this.anyObjectsPresent[s].data[t];c&&(e+="|(cellObjects"+t+"&"+c+")")}e+=")"}return e+="\t)"},O.prototype.generateMatchFunction=function(){for(var e="",t=1===te.globals.STRIDE_OBJ?"":"*"+te.globals.STRIDE_OBJ,r=0;r<te.globals.STRIDE_OBJ;++r)e+="\tvar cellObjects"+r+" = window.GAME_dot_level.objects[i"+t+(r?"+"+r:"")+"];\n";t=1===te.globals.STRIDE_MOV?"":"*"+te.globals.STRIDE_MOV;for(r=0;r<te.globals.STRIDE_MOV;++r)e+="\tvar cellMovements"+r+" = window.GAME_dot_level.movements[i"+t+(r?"+"+r:"")+"];\n";return(e+="return "+this.generateMatchString()+";")in te.globals.matchCache?te.globals.matchCache[e]:te.globals.matchCache[e]=new Function("i",e)},O.prototype.toJSON=function(){return[this.movementMask,this.cellMask,this.nonExistenceMask,this.moveNonExistenceMask,this.moveStationaryMask,this.randomDirOrEntityMask,this.movementsToRemove]};var Me,Se,Ee,Le,Te,Ie,Re,Oe,Ae,De,Ne,Pe,Be,Fe,je,He;O.prototype.replace=function(e,t){var r=this.replacement;if(null===r)return!1;var n=r.randomEntityMask,l=r.randomDirMask,o=r.objectsSet.cloneInto(Me),i=r.objectsClear.cloneInto(Se),a=r.movementsSet.cloneInto(Fe),s=r.movementsClear.cloneInto(je);if(s.ior(r.movementsLayerMask),!n.iszero()){for(var c=[],u=0;u<32*te.globals.STRIDE_OBJ;u++)n.get(u)&&c.push(u);var h=c[Math.floor(ae.uniform()*c.length)],f=te.globals.state.idDict[h],g=te.globals.state.objects[f];o.ibitset(h),i.ior(te.globals.state.layerMasks[g.layer]),s.ishiftor(31,5*g.layer)}if(!l.iszero())for(var d=0;d<le.globals.level.layerCount;d++)if(l.get(5*d)){var p=Math.floor(4*ae.uniform());a.ibitset(p+5*d)}var v=le.globals.level.getCellInto(t,Ee),m=le.globals.level.getMovements(t),b=v.cloneInto(Le),y=m.cloneInto(He);v.iclear(i),v.ior(o),m.iclear(s),m.ior(a);var w=!1,_=0,x=0;if(e.isRigid){var k=te.globals.state.groupNumber_to_RigidGroupIndex[e.groupNumber];k++;for(var C=new I(te.globals.STRIDE_MOV),M=0;M<le.globals.level.layerCount;M++)C.ishiftor(k,5*M);C.iand(r.movementsLayerMask),_=le.globals.level.rigidGroupIndexMask[t]||new I(te.globals.STRIDE_MOV),x=le.globals.level.rigidMovementAppliedMask[t]||new I(te.globals.STRIDE_MOV),C.bitsSetInArray(_.data)||r.movementsLayerMask.bitsSetInArray(x.data)||(_.ior(C),x.ior(r.movementsLayerMask),w=!0)}var S=!1;if(!b.equals(v)||!y.equals(m)||w){S=!0,w&&(le.globals.level.rigidGroupIndexMask[t]=_,le.globals.level.rigidMovementAppliedMask[t]=x);var E=v.cloneInto(Te);E.iclear(b),ze.ior(E);var L=b.cloneInto(Ie);L.iclear(v),qe.ior(L),le.globals.level.setCell(t,v),le.globals.level.setMovements(t,m);var T=t/le.globals.level.height|0,R=t%le.globals.level.height;le.globals.level.colCellContents[T].ior(v),le.globals.level.rowCellContents[R].ior(v),le.globals.level.mapCellContents.ior(v)}return S};var We=[];R.prototype.findMatches=function(){for(var e=[],t=this.cellRowMasks,r=0;r<this.patterns.length;r++){var n=this.patterns[r],l=this.cellRowMatches[r];if(this.isEllipsis[r])o=P(this.direction,l,n,t[r]);else var o=N(this.direction,l,n,t[r]);if(0===o.length)return[];e.push(o)}return e},R.prototype.applyAt=function(e,t,r){var n=this;if(r){for(var l=!0,o=0;o<n.patterns.length;o++)if(n.isEllipsis[o]){if(!1===A(n.direction,n.patterns[o],t[o][0],t[o][1]+1,t[o][1])){l=!1;break}}else if(!1===D(n.direction,n.patterns[o],t[o])){l=!1;break}if(!1===l)return!1}for(var i=!1,a=e[0]*le.globals.level.height,s=e[1],o=0;o<n.patterns.length;o++)for(var c=n.patterns[o],u=n.isEllipsis[o]?t[o][0]:t[o],h=0;h<c.length;h++){var f=c[h];if(f!==Ce)i=f.replace(n,u)||i,u=(u+s+a)%le.globals.level.n_tiles;else{u=(u+(s+a)*t[o][1])%le.globals.level.n_tiles}}if(le.globals.verbose_logging&&i){var g=we[n.direction],d='<font color="green">Rule <a onclick="jumpToLine('+n.lineNumber+');"  href="javascript:void(0);">'+n.lineNumber+"</a> "+g+" applied.</font>";(0,ne.consolePrint)(d)}return i},R.prototype.tryApply=function(){var e=ye[this.direction],t=this.findMatches();if(0===t.length)return!1;var r=!1;if(this.hasReplacements)for(var n=B(t),l=0;l<n.length;l++){var o=n[l],i=l>0;r=this.applyAt(e,o,i)||r}return t.length>0&&this.queueCommands(),r},R.prototype.queueCommands=function(){for(var e=this.commands,t=0;t<e.length;t++){var r=e[t];if(!(le.globals.level.commandQueue.indexOf(r[0])>=0)){if(le.globals.level.commandQueue.push(r[0]),le.globals.verbose_logging){var n=this.lineNumber,l=(this.direction,'<font color="green">Rule <a onclick="jumpToLine('+n.toString()+');"  href="javascript:void(0);">'+n.toString()+"</a> triggers command "+r[0]+".</font>");(0,ne.consolePrint)(l)}"message"===r[0]&&(te.globals.messagetext=r[1])}}};var ze=0,qe=0;t.ellipsisPattern=Ce,t.sprites=me,t._o1=Me,t._o2=Se,t._o2_5=Ee,t._o3=Le,t._o4=Te,t._o5=Ie,t._o6=Re,t._o7=Oe,t._o8=Ae,t._o9=De,t._o10=Ne,t._o11=Pe,t._o12=Be,t._m1=Fe,t._m2=je,t._m3=He},function(e,t){function r(e){this.s=new Array(256),this.i=0,this.j=0;for(var t=0;t<256;t++)this.s[t]=t;e&&this.mix(e)}function n(e){this.seed=e,null==e?e=(Math.random()+Date.now()).toString():"function"==typeof e?(this.uniform=e,this.nextByte=function(){return~~(256*this.uniform())},e=null):"[object String]"!==Object.prototype.toString.call(e)&&(e=JSON.stringify(e)),this._normal=null,this._state=e?new r(e):null}Object.defineProperty(t,"__esModule",{value:!0}),t.RC4=r,t.print_call_stack=function(){var e=(new Error).stack;console.log(e)},t.RNG=n,/**
	 * Seedable random number generator functions.
	 * @version 1.0.0
	 * @license Public Domain
	 *
	 * @example
	 * var rng = new RNG('Example');
	 * rng.random(40, 50);  // =>  42
	 * rng.uniform();       // =>  0.7972798995050903
	 * rng.normal();        // => -0.6698504543216376
	 * rng.exponential();   // =>  1.0547367609131555
	 * rng.poisson(4);      // =>  2
	 * rng.gamma(4);        // =>  2.781724687386858
	 */
String.prototype.getBytes=function(){for(var e=[],t=0;t<this.length;t++){var r=this.charCodeAt(t),n=[];do{n.push(255&r),r>>=8}while(r>0);e=e.concat(n.reverse())}return e},r.prototype._swap=function(e,t){var r=this.s[e];this.s[e]=this.s[t],this.s[t]=r},r.prototype.mix=function(e){for(var t=e.getBytes(),r=0,n=0;n<this.s.length;n++)r+=this.s[n]+t[n%t.length],r%=256,this._swap(n,r)},r.prototype.next=function(){return this.i=(this.i+1)%256,this.j=(this.j+this.s[this.i])%256,this._swap(this.i,this.j),this.s[(this.s[this.i]+this.s[this.j])%256]},n.prototype.nextByte=function(){return this._state.next()},n.prototype.uniform=function(){for(var e=0,t=0;t<7;t++)e*=256,e+=this.nextByte();return e/(Math.pow(2,56)-1)},n.prototype.random=function(e,t){return null==e?this.uniform():(null==t&&(t=e,e=0),e+Math.floor(this.uniform()*(t-e)))},n.prototype.normal=function(){if(null!==this._normal){var e=this._normal;return this._normal=null,e}var t=this.uniform()||Math.pow(2,-53),r=this.uniform();return this._normal=Math.sqrt(-2*Math.log(t))*Math.sin(2*Math.PI*r),Math.sqrt(-2*Math.log(t))*Math.cos(2*Math.PI*r)},n.prototype.exponential=function(){return-Math.log(this.uniform()||Math.pow(2,-53))},n.prototype.poisson=function(e){var t=Math.exp(-(e||1)),r=0,n=1;do{r++,n*=this.uniform()}while(n>t);return r-1},n.prototype.gamma=function(e){var t=(e<1?1+e:e)-1/3,r=1/Math.sqrt(9*t);do{do{var n=this.normal(),l=Math.pow(r*n+1,3)}while(l<=0);var o=this.uniform(),i=Math.pow(n,2)}while(o>=1-.0331*i*i&&Math.log(o)>=.5*i+t*(1-l+Math.log(l)));return e<1?t*l*Math.exp(this.exponential()/-e):t*l},n.roller=function(e,t){var r=e.split(/(\d+)?d(\d+)([+-]\d+)?/).slice(1),l=parseFloat(r[0])||1,o=parseFloat(r[1]),i=parseFloat(r[2])||0;return t=t||new n,function(){for(var e=l+i,r=0;r<l;r++)e+=t.random(o);return e}}},function(e,t,r){function n(e,t,r,n){void 0===r&&(r=[_.globals.state.bgcolor,_.globals.state.fgcolor]);var l=i(e),o=l.getContext("2d");o.clearRect(0,0,_.globals.cellwidth,_.globals.cellheight);var a=t[0].length,s=t.length,c=~~(_.globals.cellwidth/(a+(0|n))),u=~~(_.globals.cellheight/(s+(0|n))),h=u;"scanline"in _.globals.state.metadata&&(h=Math.ceil(u/2)),o.fillStyle=_.globals.state.fgcolor;for(var f=0;f<a;f++)for(var g=0;g<s;g++){var d=t[f][g];if(d>=0){var p=f*c|0,v=g*u|0;o.fillStyle=r[d],o.fillRect(v,p,c,h)}}return l}function l(e,t){k.globals.textImages={};for(var r in w.default)w.default.hasOwnProperty(r)&&(k.globals.textImages[r]=n("char"+r,w.default[r],void 0,1))}function o(){if(_.globals.textMode)l();else if(k.globals.levelEditorOpened&&(k.globals.textImages.s=n("chars",w.default.s,void 0)),0!==_.globals.state.levels.length){f=[];for(var e=0;e<x.sprites.length;e++)void 0!=x.sprites[e]&&(f[e]=n(e.toString(),x.sprites[e].dat,x.sprites[e].colors));(!1).canOpenEditor&&a()}}function i(e){var t;return e in y.globals.canvasdict?t=y.globals.canvasdict[e]:(t=document.createElement("canvas"),y.globals.canvasdict[e]=t),t.width=_.globals.cellwidth,t.height=_.globals.cellheight,t}function a(){if(0!==_.globals.cellwidth&&0!==_.globals.cellheight){g=[],d=[];for(var e in _.globals.state.glyphDict)if(1==e.length&&_.globals.state.glyphDict.hasOwnProperty(e)){var t=_.globals.state.glyphDict[e],r=i("C"+e),n=r.getContext("2d");g.push(e);for(var l=0;l<t.length;l++){var o=t[l];-1!==o&&n.drawImage(f[o],0,0)}d.push(r)}(n=(p=i("highlight")).getContext("2d")).fillStyle="#FFFFFF",n.fillRect(0,0,_.globals.cellwidth,1),n.fillRect(0,0,1,_.globals.cellheight),n.fillRect(0,_.globals.cellheight-1,_.globals.cellwidth,1),n.fillRect(_.globals.cellwidth-1,0,1,_.globals.cellheight),m=k.globals.textImages.s;(n=(v=i("highlightresize")).getContext("2d")).fillStyle="#FFFFFF";var a=_.globals.cellwidth/2-1|0,s=_.globals.cellwidth-a-1-a,c=_.globals.cellheight/2-1|0,u=_.globals.cellheight-c-1-a;n.fillRect(a,0,s,_.globals.cellheight),n.fillRect(0,c,_.globals.cellwidth,u);(n=(b=i()).getContext("2d")).fillStyle="yellow",n.fillRect(0,0,_.globals.cellwidth,2),n.fillRect(0,0,2,_.globals.cellheight),n.fillRect(0,_.globals.cellheight-2,_.globals.cellwidth,2),n.fillRect(_.globals.cellwidth-2,0,2,_.globals.cellheight)}}function s(){var e=0;for(var t in _.globals.state.glyphDict)1==t.length&&_.globals.state.glyphDict.hasOwnProperty(t)&&e++;return e}function c(){if(0!==_.globals.cellwidth&&0!==_.globals.cellheight)if(void 0===f&&o(),_.globals.textMode){(0,y.getCtx)().fillStyle=_.globals.state.bgcolor,(0,y.getCtx)().fillRect(0,0,y.globals.canvas.width,y.globals.canvas.height);for(v=0;v<_.globals.titleWidth;v++)for(m=0;m<_.globals.titleHeight;m++){var e=_.globals.titleImage[m].charAt(v);if(e in k.globals.textImages){S=k.globals.textImages[e];(0,y.getCtx)().drawImage(S,_.globals.xoffset+v*_.globals.cellwidth,_.globals.yoffset+m*_.globals.cellheight)}}}else{(0,y.getCtx)().fillStyle=_.globals.state.bgcolor,(0,y.getCtx)().fillRect(0,0,y.globals.canvas.width,y.globals.canvas.height);var t=0,r=_.globals.screenwidth,n=0,l=_.globals.screenheight;if(k.globals.levelEditorOpened){var i=s();r-=2,l-=2+(M=Math.ceil(i/(_.globals.screenwidth-1)))}else if(_.globals.flickscreen){if((d=(0,x.getPlayerPositions)()).length>0){var a=(p=d[0])/k.globals.level.height|0,c=p%k.globals.level.height|0,h=a/_.globals.screenwidth|0,g=c/_.globals.screenheight|0;t=h*_.globals.screenwidth,n=g*_.globals.screenheight,r=Math.min(t+_.globals.screenwidth,k.globals.level.width),l=Math.min(n+_.globals.screenheight,k.globals.level.height),k.globals.oldflickscreendat=[t,n,r,l]}else k.globals.oldflickscreendat.length>0&&(t=k.globals.oldflickscreendat[0],n=k.globals.oldflickscreendat[1],r=k.globals.oldflickscreendat[2],l=k.globals.oldflickscreendat[3])}else if(_.globals.zoomscreen){var d=(0,x.getPlayerPositions)();if(d.length>0){var p=d[0],a=p/k.globals.level.height|0,c=p%k.globals.level.height|0;t=Math.max(Math.min(a-(_.globals.screenwidth/2|0),k.globals.level.width-_.globals.screenwidth),0),n=Math.max(Math.min(c-(_.globals.screenheight/2|0),k.globals.level.height-_.globals.screenheight),0),r=Math.min(t+_.globals.screenwidth,k.globals.level.width),l=Math.min(n+_.globals.screenheight,k.globals.level.height),k.globals.oldflickscreendat=[t,n,r,l]}else k.globals.oldflickscreendat.length>0&&(t=k.globals.oldflickscreendat[0],n=k.globals.oldflickscreendat[1],r=k.globals.oldflickscreendat[2],l=k.globals.oldflickscreendat[3])}for(var v=t;v<r;v++)for(var m=n;m<l;m++)for(var b=m+v*k.globals.level.height,w=k.globals.level.getCellInto(b,x._o12),C=0;C<_.globals.state.objectCount;C++)if(0!=w.get(C)){var S=f[C];(0,y.getCtx)().drawImage(S,_.globals.xoffset+(v-t)*_.globals.cellwidth,_.globals.yoffset+(m-n)*_.globals.cellheight)}k.globals.levelEditorOpened&&u()}}function u(){d.length;var e=d.length-0;(0,y.getCtx)().drawImage(m,_.globals.xoffset-_.globals.cellwidth,_.globals.yoffset-_.globals.cellheight*(1+M)),mouseCoordY===-1-M&&-1===mouseCoordX&&(0,y.getCtx)().drawImage(b,_.globals.xoffset-_.globals.cellwidth,_.globals.yoffset-_.globals.cellheight*(1+M));for(var t=M-(-mouseCoordY-2)-1,r=mouseCoordX+(_.globals.screenwidth-1)*t,n=0;n<e;n++){var l=d[0+n],o=n%(_.globals.screenwidth-1),t=n/(_.globals.screenwidth-1)|0;(0,y.getCtx)().drawImage(l,_.globals.xoffset+o*_.globals.cellwidth,_.globals.yoffset+t*_.globals.cellheight-_.globals.cellheight*(1+M)),mouseCoordX>=0&&mouseCoordX<_.globals.screenwidth-1&&r===n&&(0,y.getCtx)().drawImage(b,_.globals.xoffset+o*_.globals.cellwidth,_.globals.yoffset+t*_.globals.cellheight-_.globals.cellheight*(1+M)),n===C&&(0,y.getCtx)().drawImage(p,_.globals.xoffset+o*_.globals.cellwidth,_.globals.yoffset+t*_.globals.cellheight-_.globals.cellheight*(1+M))}mouseCoordX>=-1&&mouseCoordY>=-1&&mouseCoordX<_.globals.screenwidth-1&&mouseCoordY<_.globals.screenheight-1-M&&(-1==mouseCoordX||-1==mouseCoordY||mouseCoordX==_.globals.screenwidth-2||mouseCoordY===_.globals.screenheight-2-M?(0,y.getCtx)().drawImage(v,_.globals.xoffset+mouseCoordX*_.globals.cellwidth,_.globals.yoffset+mouseCoordY*_.globals.cellheight):(0,y.getCtx)().drawImage(p,_.globals.xoffset+mouseCoordX*_.globals.cellwidth,_.globals.yoffset+mouseCoordY*_.globals.cellheight))}function h(){if(y.globals.canvas.width=y.globals.canvas.parentNode.clientWidth,y.globals.canvas.height=y.globals.canvas.parentNode.clientHeight,_.globals.screenwidth=k.globals.level.width,_.globals.screenheight=k.globals.level.height,void 0!==_.globals.state)if(_.globals.flickscreen=void 0!==_.globals.state.metadata.flickscreen,_.globals.zoomscreen=void 0!==_.globals.state.metadata.zoomscreen,k.globals.levelEditorOpened){_.globals.screenwidth+=2;var e=s();M=Math.ceil(e/(_.globals.screenwidth-1)),_.globals.screenheight+=2+M}else _.globals.flickscreen?(_.globals.screenwidth=_.globals.state.metadata.flickscreen[0],_.globals.screenheight=_.globals.state.metadata.flickscreen[1]):_.globals.zoomscreen&&(_.globals.screenwidth=_.globals.state.metadata.zoomscreen[0],_.globals.screenheight=_.globals.state.metadata.zoomscreen[1]);_.globals.textMode&&(_.globals.screenwidth=_.globals.titleWidth,_.globals.screenheight=_.globals.titleHeight),_.globals.cellwidth=y.globals.canvas.width/_.globals.screenwidth,_.globals.cellheight=y.globals.canvas.height/_.globals.screenheight;var t=5,r=5;_.globals.textMode&&(t=6,r=6),_.globals.cellwidth=t*~~(_.globals.cellwidth/t),_.globals.cellheight=r*~~(_.globals.cellheight/r),_.globals.xoffset=0,_.globals.yoffset=0,_.globals.cellwidth>_.globals.cellheight?(_.globals.cellwidth=_.globals.cellheight,_.globals.xoffset=(y.globals.canvas.width-_.globals.cellwidth*_.globals.screenwidth)/2,_.globals.yoffset=(y.globals.canvas.height-_.globals.cellheight*_.globals.screenheight)/2):(_.globals.cellheight=_.globals.cellwidth,_.globals.yoffset=(y.globals.canvas.height-_.globals.cellheight*_.globals.screenheight)/2,_.globals.xoffset=(y.globals.canvas.width-_.globals.cellwidth*_.globals.screenwidth)/2),_.globals.magnification=_.globals.cellwidth/t*5|0,k.globals.levelEditorOpened&&!_.globals.textMode&&(_.globals.xoffset+=_.globals.cellwidth,_.globals.yoffset+=_.globals.cellheight*(1+M)),_.globals.cellwidth=0|_.globals.cellwidth,_.globals.cellheight=0|_.globals.cellheight,_.globals.xoffset=0|_.globals.xoffset,_.globals.yoffset=0|_.globals.yoffset,(S!=_.globals.cellwidth||E!=_.globals.cellheight||L!=_.globals.textMode||T!=_.globals.state.fgcolor||y.globals.forceRegenImages)&&(y.globals.forceRegenImages=!1,o()),E=_.globals.cellheight,S=_.globals.cellwidth,L=_.globals.textMode,T=_.globals.state.fgcolor,c()}Object.defineProperty(t,"__esModule",{value:!0}),t.createSprite=n,t.regenText=l,t.regenSpriteImages=o,t.makeSpriteCanvas=i,t.generateGlyphImages=a,t.glyphCount=s,t.redraw=c,t.drawEditorIcons=u,t.canvasResize=h,t.addListeners=function(e){e.addEventListener("resize",h,!1)},t.removeListeners=function(e){e.removeEventListener("resize",h)};var f,g,d,p,v,m,b,y=r(2),w=function(e){return e&&e.__esModule?e:{default:e}}(r(9)),_=r(5),x=r(6),k=r(4),C=0,M=1,S=0,E=0,L=-1,T=-1},function(e,t){Object.defineProperty(t,"__esModule",{value:!0});t.default={a:[[0,0,0,0,0],[0,1,1,1,0],[1,0,0,1,0],[1,0,0,1,0],[0,1,1,1,0]],b:[[1,0,0,0,0],[1,0,0,0,0],[1,1,1,0,0],[1,0,0,1,0],[0,1,1,0,0]],c:[[0,0,0,0,0],[0,1,1,1,0],[1,0,0,0,0],[1,0,0,0,0],[0,1,1,1,0]],d:[[0,0,0,1,0],[0,0,0,1,0],[0,1,1,1,0],[1,0,0,1,0],[0,1,1,0,0]],e:[[0,1,1,0,0],[1,0,0,1,0],[1,1,1,0,0],[1,0,0,0,0],[0,1,1,0,0]],f:[[0,0,0,0,0],[0,0,1,1,0],[0,1,0,0,0],[1,1,1,0,0],[0,1,0,0,0]],g:[[0,1,1,0,0],[1,0,0,1,0],[0,1,1,1,0],[0,0,0,1,0],[0,1,1,0,0]],h:[[1,0,0,0,0],[1,0,0,0,0],[1,1,1,0,0],[1,0,0,1,0],[1,0,0,1,0]],i:[[0,0,1,0,0],[0,0,0,0,0],[0,1,1,0,0],[0,0,1,0,0],[0,1,1,1,0]],j:[[0,0,1,0,0],[0,0,0,0,0],[0,0,1,0,0],[1,0,1,0,0],[0,1,0,0,0]],k:[[1,0,0,0,0],[1,0,0,1,0],[1,1,1,0,0],[1,0,0,1,0],[1,0,0,1,0]],l:[[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,1,0],[0,1,1,0,0]],m:[[0,0,0,0,0],[0,1,0,1,0],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1]],n:[[0,0,0,0,0],[0,1,1,0,0],[1,0,0,1,0],[1,0,0,1,0],[1,0,0,1,0]],o:[[0,0,0,0,0],[0,1,1,0,0],[1,0,0,1,0],[1,0,0,1,0],[0,1,1,0,0]],p:[[0,0,0,0,0],[0,1,1,0,0],[1,0,0,1,0],[1,1,1,0,0],[1,0,0,0,0]],q:[[0,0,0,0,0],[0,1,1,0,0],[1,0,0,1,0],[0,1,1,1,0],[0,0,0,1,0]],r:[[0,0,0,0,0],[0,1,1,1,0],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0]],s:[[0,1,1,1,0],[1,0,0,0,0],[0,1,1,0,0],[0,0,0,1,0],[1,1,1,0,0]],t:[[0,1,0,0,0],[1,1,1,0,0],[0,1,0,0,0],[0,1,0,0,1],[0,0,1,1,0]],u:[[0,0,0,0,0],[1,0,0,1,0],[1,0,0,1,0],[1,0,0,1,0],[1,1,1,0,0]],v:[[0,0,0,0,0],[1,0,0,1,0],[1,0,1,0,0],[1,1,0,0,0],[1,0,0,0,0]],w:[[0,0,0,0,0],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1],[0,1,0,1,0]],x:[[0,0,0,0,0],[1,0,0,1,0],[0,1,1,0,0],[0,1,1,0,0],[1,0,0,1,0]],y:[[1,0,0,1,0],[1,0,0,1,0],[0,1,1,1,0],[0,0,0,1,0],[1,1,1,0,0]],z:[[0,0,0,0,0],[1,1,1,1,0],[0,0,1,0,0],[0,1,0,0,0],[1,1,1,1,0]],A:[[1,1,1,1,1],[1,0,0,0,1],[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1]],B:[[1,1,1,1,0],[1,0,0,0,1],[1,1,1,1,0],[1,0,0,0,1],[1,1,1,1,0]],C:[[1,1,1,1,1],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,1,1,1,1]],D:[[1,1,1,1,0],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,0]],E:[[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,1]],F:[[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,1],[1,0,0,0,0],[1,0,0,0,0]],G:[[0,1,1,1,1],[1,0,0,0,0],[1,0,0,1,1],[1,0,0,0,1],[0,1,1,1,1]],H:[[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1]],I:[[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[1,1,1,1,1]],J:[[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[1,1,1,0,0]],K:[[1,0,0,0,1],[1,0,1,1,0],[1,1,0,0,0],[1,0,1,1,0],[1,0,0,0,1]],L:[[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,1,1,1,1]],M:[[1,1,1,1,1],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1]],N:[[1,0,0,0,1],[1,1,0,0,1],[1,0,1,0,1],[1,0,0,1,1],[1,0,0,0,1]],O:[[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1]],P:[[1,1,1,1,1],[1,0,0,0,1],[1,1,1,1,1],[1,0,0,0,0],[1,0,0,0,0]],Q:[[1,1,1,1,1],[1,0,0,0,1],[1,1,1,1,1],[0,0,0,0,1],[0,0,0,0,1]],R:[[1,1,1,1,0],[1,0,0,0,1],[1,1,1,1,0],[1,0,0,0,1],[1,0,0,0,1]],S:[[0,1,1,1,1],[1,0,0,0,0],[0,1,1,1,0],[0,0,0,0,1],[1,1,1,1,0]],T:[[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0]],U:[[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1]],V:[[1,0,0,0,1],[0,1,0,1,0],[0,1,0,1,0],[0,0,1,0,0],[0,0,1,0,0]],W:[[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1],[0,1,0,1,0]],X:[[1,0,0,0,1],[0,1,0,1,0],[0,0,1,0,0],[0,1,0,1,0],[1,0,0,0,1]],Y:[[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0]],Z:[[1,1,1,1,1],[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0],[1,1,1,1,1]],0:[[1,1,1,1,1],[1,0,0,1,1],[1,0,1,0,1],[1,1,0,0,1],[1,1,1,1,1]],1:[[1,1,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[1,1,1,1,1]],2:[[1,1,1,1,1],[0,0,0,0,1],[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,1]],3:[[1,1,1,1,0],[0,0,0,0,1],[0,0,1,1,0],[0,0,0,0,1],[1,1,1,1,0]],4:[[1,0,0,0,0],[1,0,0,0,0],[1,0,0,1,0],[1,1,1,1,1],[0,0,0,1,0]],5:[[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,0],[0,0,0,0,1],[1,1,1,1,0]],6:[[0,1,1,1,0],[1,0,0,0,0],[1,1,1,1,0],[1,0,0,0,1],[0,1,1,1,0]],7:[[1,1,1,1,1],[0,0,0,0,1],[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0]],8:[[0,1,1,1,0],[1,0,0,0,1],[0,1,1,1,0],[1,0,0,0,1],[0,1,1,1,0]],9:[[0,1,1,1,0],[1,0,0,0,1],[0,1,1,1,1],[0,0,0,0,1],[0,1,1,1,0]],".":[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,1,0,0]],",":[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,1,0,0],[0,1,1,0,0]],";":[[0,0,0,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,1,0,0],[0,1,1,0,0]],":":[[0,0,0,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,1,0,0],[0,0,0,0,0]],"?":[[0,1,1,1,0],[1,0,0,0,1],[0,0,1,1,0],[0,0,1,0,0],[0,0,1,0,0]],"!":[[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,1,0,0]],"@":[[0,1,1,1,0],[1,0,0,0,1],[1,0,1,1,1],[1,0,0,0,0],[0,1,1,1,0]],"":[[0,1,1,1,0],[0,1,0,0,1],[1,1,1,0,0],[0,1,0,0,0],[1,1,1,1,1]],$:[[0,1,1,1,1],[1,0,1,0,0],[0,1,1,1,0],[0,0,1,0,1],[1,1,1,1,0]],"%":[[1,1,0,0,1],[1,1,0,1,0],[0,0,1,0,0],[0,1,0,1,1],[1,0,0,1,1]],"^":[[0,0,1,0,0],[0,1,0,1,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],"&":[[0,1,1,0,0],[1,0,0,0,0],[0,1,0,1,1],[1,0,0,1,0],[0,1,1,0,0]],"*":[[0,1,0,1,0],[0,0,1,0,0],[0,1,0,1,0],[0,0,0,0,0],[0,0,0,0,0]],"(":[[0,0,0,1,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,0,1,0]],")":[[0,1,0,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,1,0,0,0]],"+":[[0,0,1,0,0],[0,0,1,0,0],[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0]],"-":[[0,0,0,0,0],[0,0,0,0,0],[0,1,1,1,0],[0,0,0,0,0],[0,0,0,0,0]],_:[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[1,1,1,1,1]],"=":[[0,0,0,0,0],[1,1,1,1,1],[0,0,0,0,0],[1,1,1,1,1],[0,0,0,0,0]]," ":[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],"{":[[0,0,1,1,0],[0,0,1,0,0],[0,1,1,0,0],[0,0,1,0,0],[0,0,1,1,0]],"}":[[0,1,1,0,0],[0,0,1,0,0],[0,0,1,1,0],[0,0,1,0,0],[0,1,1,0,0]],"[":[[0,0,1,1,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,1,0]],"]":[[0,1,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,1,1,0,0]],"'":[[0,0,1,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],'"':[[0,1,0,1,0],[0,1,0,1,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],"/":[[0,0,0,0,1],[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0],[1,0,0,0,0]],"\\":[[1,0,0,0,0],[0,1,0,0,0],[0,0,1,0,0],[0,0,0,1,0],[0,0,0,0,1]],"|":[[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0]],"<":[[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0],[0,0,1,0,0],[0,0,0,1,0]],">":[[0,1,0,0,0],[0,0,1,0,0],[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0]],"~":[[0,0,0,0,0],[0,1,0,0,0],[1,0,1,0,1],[0,0,0,1,0],[0,0,0,0,0]],"`":[[0,1,0,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],"#":[[0,1,0,1,0],[1,1,1,1,1],[0,1,0,1,0],[1,1,1,1,1],[0,1,0,1,0]]},e.exports=t.default},function(e,t,r){function n(e,t,r){if(c[0]||r){if(void 0===t)return o(e);var n='<a onclick="jumpToLine('+t.toString()+');"  href="javascript:void(0);"><span class="errorTextLineNumber"> line '+t.toString()+'</span></a> : <span class="errorText">'+e+"</span>";u.indexOf(n)>=0&&!r||((0,s.consolePrint)(n,!0),u.push(n),h[0]++)}}function l(e,t,r){if(c[0]||r){if(void 0===t)return o(e);var n='<a onclick="jumpToLine('+t.toString()+');"  href="javascript:void(0);"><span class="errorTextLineNumber"> line '+t.toString()+'</span></a> : <span class="warningText">'+e+"</span>";u.indexOf(n)>=0&&!r||((0,s.consolePrint)(n,!0),u.push(n))}}function o(e,t){if(c[0]||t){var r='<span class="errorText">'+e+"</span>";u.indexOf(r)>=0&&!t||((0,s.consolePrint)(r,!0),u.push(r)),h[0]++}}function i(e){"levels"===e.section?e.levels[e.levels.length-1].length>0&&e.levels.push([]):"objects"===e.section&&(e.objects_section=0)}Object.defineProperty(t,"__esModule",{value:!0}),t.logErrorCacheable=function(e,t,r){if(c[0]||r){if(void 0===t)return o(e);var n='<a onclick="jumpToLine('+t.toString()+');"  href="javascript:void(0);"><span class="errorTextLineNumber"> line '+t.toString()+'</span></a> : <span class="errorText">'+e+"</span>";u.indexOf(n)>=0&&!r||((0,s.consolePrint)(n),u.push(n),h[0]++)}},t.logError=n,t.logWarning=l,t.logErrorNoLine=o,t.logBetaMessage=function(e,t){if(c[0]||t){var r='<span class="betaText">'+e+"</span>";u.indexOf(r)>=0&&!t||(consoleError(r),u.push(r))}},t.blankLineHandle=i;!function(e){e&&e.__esModule}(r(11));var a=r(12),s=r(3),c=(r(4),[!1]);t.compiling=c;var u=[];t.errorStrings=u;var h=[0];t.errorCount=h;t.codeMirrorFn=function(){"use strict";function e(e,t){if(void 0!==e.objects[t])return n('Object "'+t.toUpperCase()+'" defined multiple times.',e.lineNumber),"ERROR";for(r=0;r<e.legend_synonyms.length;r++)(l=e.legend_synonyms[r])[0]==t&&n('Name "'+t.toUpperCase()+'" already in use.',e.lineNumber);for(r=0;r<e.legend_aggregates.length;r++)(l=e.legend_aggregates[r])[0]==t&&n('Name "'+t.toUpperCase()+'" already in use.',e.lineNumber);for(var r=0;r<e.legend_properties.length;r++){var l=e.legend_properties[r];l[0]==t&&n('Name "'+t.toUpperCase()+'" already in use.',e.lineNumber)}}var t=["objects","legend","sounds","collisionlayers","rules","winconditions","levels"],r=["sfx0","sfx1","sfx2","sfx3","sfx4","sfx5","sfx6","sfx7","sfx8","sfx9","sfx10","cancel","checkpoint","restart","win","message","again"],o=/[\w]+\s*/,s=/\d+\b/,c=/(objects|collisionlayers|legend|sounds|rules|winconditions|levels)\s*/,u=/[\=]+/,h=/[^\(]+/,f=/[ \,]*/,g=/(move|action|create|destroy|cantmove|undo|restart|titlescreen|startgame|endgame|startlevel|endlevel|showmessage|closemessage|sfx0|sfx1|sfx2|sfx3|sfx4|sfx5|sfx6|sfx7|sfx8|sfx9|sfx10)\s+/,d=/^(action|up|down|left|right|\^|v|\<|\>|forward|moving|stationary|parallel|perpendicular|horizontal|orthogonal|vertical|no|randomdir|random)$/,p=/^(startloop|endloop)$/,v=/^(up|down|left|right|horizontal|vertical|orthogonal|late|rigid)$/,m=/\s*(up|down|left|right|horizontal|vertical|orthogonal)\s*/,b=/^(all|any|no|some)$/,y=["objects","collisionlayers","legend","sounds","rules","...","winconditions","levels","up","down","left","right","late","rigid","^","v",">","<","no","randomdir","random","horizontal","vertical","any","all","no","some","moving","stationary","parallel","perpendicular","action","message"];return{copyState:function(e){var t={};for(var r in e.objects)if(e.objects.hasOwnProperty(r)){var n=e.objects[r];t[r]={colors:n.colors.concat([]),lineNumber:n.lineNumber,spritematrix:n.spritematrix.concat([])}}for(var l=[],r=0;r<e.collisionLayers.length;r++)l.push(e.collisionLayers[r].concat([]));for(var o=[],i=[],a=[],s=[],c=[],u=[],r=0;r<e.legend_synonyms.length;r++)o.push(e.legend_synonyms[r].concat([]));for(r=0;r<e.legend_aggregates.length;r++)i.push(e.legend_aggregates[r].concat([]));for(r=0;r<e.legend_properties.length;r++)a.push(e.legend_properties[r].concat([]));for(r=0;r<e.sounds.length;r++)s.push(e.sounds[r].concat([]));for(r=0;r<e.levels.length;r++)c.push(e.levels[r].concat([]));for(r=0;r<e.winconditions.length;r++)u.push(e.winconditions[r].concat([]));return{lineNumber:e.lineNumber,objects:t,collisionLayers:l,commentLevel:e.commentLevel,section:e.section,visitedSections:e.visitedSections.concat([]),objects_candname:e.objects_candname,objects_section:e.objects_section,objects_spritematrix:e.objects_spritematrix.concat([]),tokenIndex:e.tokenIndex,legend_synonyms:o,legend_aggregates:i,legend_properties:a,sounds:s,rules:e.rules.concat([]),names:e.names.concat([]),winconditions:u,abbrevNames:e.abbrevNames.concat([]),metadata:e.metadata.concat([]),levels:c,STRIDE_OBJ:e.STRIDE_OBJ,STRIDE_MOV:e.STRIDE_MOV}},blankLine:function(e){"levels"===e.section&&e.levels[e.levels.length-1].length>0&&e.levels.push([])},token:function(w,_){var x=w.string,k=w.sol();if(k&&(w.string=w.string.toLowerCase(),_.tokenIndex=0),w.eatWhile(/[ \t]/),"("===(I=w.peek())&&-4!==_.tokenIndex)w.next(),_.commentLevel++;else if(")"===I&&(w.next(),_.commentLevel>0&&(_.commentLevel--,0===_.commentLevel)))return"comment";if(_.commentLevel>0){for(;(w.eatWhile(/[^\(\)]+/),!w.eol())&&("("===(I=w.peek())?_.commentLevel++:")"===I&&_.commentLevel--,w.next(),0!==_.commentLevel););return"comment"}if(w.eatWhile(/[ \t]/),k&&w.eol())return i(_);if(k&&w.match(u,!0))return"EQUALSBIT";if(w.match(c,!0)){_.section=w.string.slice(0,w.pos).trim(),_.visitedSections.indexOf(_.section)>=0&&n('cannot duplicate sections (you tried to duplicate "'+_.section.toUpperCase()+'").',_.lineNumber),_.visitedSections.push(_.section);var C=t.indexOf(_.section);if(0==C?(_.objects_section=0,_.visitedSections.length>1&&n('section "'+_.section.toUpperCase()+'" must be the first section',_.lineNumber)):-1==_.visitedSections.indexOf(t[C-1])&&(-1===C?n('no such section as "'+_.section.toUpperCase()+'".',_.lineNumber):n('section "'+_.section.toUpperCase()+'" is out of order, must follow  "'+t[C-1].toUpperCase()+'".',_.lineNumber)),"sounds"===_.section){for(var M in _.objects)_.objects.hasOwnProperty(M)&&_.names.push(M);for(W=0;W<_.legend_synonyms.length;W++)M=_.legend_synonyms[W][0],_.names.push(M);for(W=0;W<_.legend_aggregates.length;W++)M=_.legend_aggregates[W][0],_.names.push(M);for(W=0;W<_.legend_properties.length;W++)M=_.legend_properties[W][0],_.names.push(M)}else if("levels"===_.section){for(var M in _.objects)_.objects.hasOwnProperty(M)&&1==M.length&&_.abbrevNames.push(M);for(W=0;W<_.legend_synonyms.length;W++)1==_.legend_synonyms[W][0].length&&_.abbrevNames.push(_.legend_synonyms[W][0]);for(W=0;W<_.legend_aggregates.length;W++)1==_.legend_aggregates[W][0].length&&_.abbrevNames.push(_.legend_aggregates[W][0])}return"HEADER"}if(void 0===_.section&&n('must start with section "OBJECTS"',_.lineNumber),w.eol())return null;switch(_.section){case"objects":var S=function(){var e=k?w.match(o,!0):w.match(/[^\s\()]+\s*/,!0);if(null==e)return w.match(h,!0),"ERROR";var t=e[0].trim();if(void 0!==_.objects[t])return n('Object "'+t.toUpperCase()+'" defined multiple times.',_.lineNumber),"ERROR";for(var r=0;r<_.legend_synonyms.length;r++)_.legend_synonyms[r][0]==t&&n('Name "'+t.toUpperCase()+'" already in use.',_.lineNumber);if(y.indexOf(t)>=0&&l('You named an object "'+t.toUpperCase()+"\", but this is a keyword. Don't do that!",_.lineNumber),k)_.objects_candname=t,_.objects[_.objects_candname]={lineNumber:_.lineNumber,colors:[],spritematrix:[]};else{var i=[t,_.objects_candname];i.lineNumber=_.lineNumber,_.legend_synonyms.push(i)}return _.objects_section=1,"NAME"};switch(k&&2==_.objects_section&&(_.objects_section=3),k&&1==_.objects_section&&(_.objects_section=2),_.objects_section){case 0:case 1:return _.objects_spritematrix=[],S();case 2:_.tokenIndex=0;var E=w.match(a.reg_color,!0);if(null==E){var L=w.match(o,!0)||w.match(h,!0);return n("Was looking for color for object "+_.objects_candname.toUpperCase()+', got "'+L+'" instead.',_.lineNumber),null}void 0===_.objects[_.objects_candname].colors?_.objects[_.objects_candname].colors=[E[0].trim()]:_.objects[_.objects_candname].colors.push(E[0].trim());var T=E[0].trim().toLowerCase();return T in a.colorPalettes.arnecolors?"COLOR COLOR-"+T.toUpperCase():"transparent"===T?"COLOR FADECOLOR":"COLOR";case 3:var I=w.eat(/[.\d]/),R=_.objects_spritematrix;if(void 0===I)return 0===R.length?S():(n("Unknown junk in spritematrix for object "+_.objects_candname.toUpperCase()+".",_.lineNumber),w.match(h,!0),null);k&&R.push("");var O=_.objects[_.objects_candname];return R[R.length-1]+=I,5===R.length&&5==R[R.length-1].length&&(O.spritematrix=_.objects_spritematrix,_.objects_section=0),"."!==I?(M=parseInt(I))>=O.colors.length?(n("trying to access color number "+M+" from the color palette of sprite "+_.objects_candname.toUpperCase()+", but there are only "+O.colors.length+" defined in it.",_.lineNumber),"ERROR"):isNaN(M)?(n('invalid character "'+I+'" in sprite for '+_.objects_candname.toUpperCase(),_.lineNumber),"ERROR"):"COLOR BOLDCOLOR COLOR-"+O.colors[M].toUpperCase():"COLOR FADECOLOR";default:window.console.logError("EEK shouldn't get here.")}break;case"sounds":return k&&(B=!0,(P=h.exec(w.string)[0].split(/\s/).filter(function(e){return""!==e})).push(_.lineNumber),_.sounds.push(P)),null!==(G=w.match(g,!0))?"SOUNDVERB":null!==(G=w.match(m,!0))?"DIRECTION":null!==(G=w.match(s,!0))?(_.tokenIndex++,"SOUND"):null!==(G=w.match(/[^\[\|\]\s]*/,!0))&&(U=G[0].trim(),_.names.indexOf(U)>=0)?"NAME":(G=w.match(h,!0),n('unexpected sound token "'+G+'".',_.lineNumber),w.match(h,!0),"ERROR");case"collisionlayers":if(k&&(_.collisionLayers.push([]),_.tokenIndex=0),null===(q=w.match(o,!0))){var A=w.pos;return w.match(f,!0),w.pos==A&&(n("error detected - unexpected character "+w.peek(),_.lineNumber),w.next()),null}H=function e(t){if((t=t.toLowerCase())in _.objects)return[t];for(r=0;r<_.legend_synonyms.length;r++)if((l=_.legend_synonyms[r])[0]===t)return[l[1]];for(r=0;r<_.legend_aggregates.length;r++)if((l=_.legend_aggregates[r])[0]===t)return n('"'+t+'" is an aggregate (defined using "and"), and cannot be added to a single layer because its constituent objects must be able to coexist.',_.lineNumber),[];for(var r=0;r<_.legend_properties.length;r++){var l=_.legend_properties[r];if(l[0]===t)return[].concat.apply([],l.slice(1).map(e))}return n('Cannot add "'+G.toUpperCase()+'" to a collision layer; it has not been declared.',_.lineNumber),[]},"background"===(G=q[0].trim())?(_.collisionLayers.length>0&&_.collisionLayers[_.collisionLayers.length-1].length>0&&n("Background must be in a layer by itself.",_.lineNumber),_.tokenIndex=1):0!==_.tokenIndex&&n("Background must be in a layer by itself.",_.lineNumber);var D=H(G);return 0===_.collisionLayers.length?(n("no layers found.",_.lineNumber),"ERROR"):(_.collisionLayers[_.collisionLayers.length-1]=_.collisionLayers[_.collisionLayers.length-1].concat(D),D.length>0?"NAME":"ERROR");case"legend":if(k){var N=w.string.replace("="," = "),P=(N=h.exec(N)[0]).split(/\s/).filter(function(e){return""!==e}),B=!0;if(P.length>0&&(G=P[0].toLowerCase(),y.indexOf(G)>=0&&l('You named an object "'+G.toUpperCase()+"\", but this is a keyword. Don't do that!",_.lineNumber),P.indexOf(G,2)>=2&&n("You can't define object "+G.toUpperCase()+" in terms of itself!",_.lineNumber),e(_,G)),P.length<3)B=!1;else if("="!==P[1])B=!1;else if(3===P.length){var F=[P[0],P[2].toLowerCase()];F.lineNumber=_.lineNumber,_.legend_synonyms.push(F)}else if(P.length%2==0)B=!1;else{var j=P[3].toLowerCase();if("and"===j){for(var H=function e(t){if((t=t.toLowerCase())in _.objects)return[t];for(r=0;r<_.legend_synonyms.length;r++)if((l=_.legend_synonyms[r])[0]===t)return[1];for(r=0;r<_.legend_aggregates.length;r++)if((l=_.legend_aggregates[r])[0]===t)return[].concat.apply([],l.slice(1).map(e));for(var r=0;r<_.legend_properties.length;r++){var l=_.legend_properties[r];if(l[0]===t)return n("Cannot define an aggregate (using 'and') in terms of properties (something that uses 'or').",_.lineNumber),B=!1,[t]}return[t]},W=5;W<P.length;W+=2)if("and"!==P[W].toLowerCase()){B=!1;break}if(B){for(var z=[P[0]].concat(H(P[2])).concat(H(P[4])),W=6;W<P.length;W+=2)z=z.concat(H(P[W]));z.lineNumber=_.lineNumber,_.legend_aggregates.push(z)}}else if("or"===j){for(var H=function e(t){if((t=t.toLowerCase())in _.objects)return[t];for(r=0;r<_.legend_synonyms.length;r++)if((l=_.legend_synonyms[r])[0]===t)return[1];for(r=0;r<_.legend_aggregates.length;r++)(l=_.legend_aggregates[r])[0]===t&&(n("Cannot define a property (using 'or') in terms of aggregates (something that uses 'and').",_.lineNumber),B=!1);for(var r=0;r<_.legend_properties.length;r++){var l=_.legend_properties[r];if(l[0]===t)return[].concat.apply([],l.slice(1).map(e))}return[t]},W=5;W<P.length;W+=2)if("or"!==P[W].toLowerCase()){B=!1;break}if(B){for(var z=[P[0],P[2].toLowerCase(),P[4].toLowerCase()],W=6;W<P.length;W+=2)z.push(P[W].toLowerCase());z.lineNumber=_.lineNumber,_.legend_properties.push(z)}}else B=!1}if(!1===B)return n("incorrect format of legend - should be one of A = B, A = B or C ( or D ...), A = B and C (and D ...)",_.lineNumber),w.match(h,!0),"ERROR";_.tokenIndex=0}if(0===_.tokenIndex)return w.match(/[^=]*/,!0),_.tokenIndex++,"NAME";if(1===_.tokenIndex)return w.next(),w.match(/\s*/,!0),_.tokenIndex++,"ASSSIGNMENT";var q=w.match(o,!0);if(null===q)return n("Something bad's happening in the LEGEND",_.lineNumber),w.match(h,!0),"ERROR";var G=q[0].trim();return _.tokenIndex%2==0?!1===function(e){if((e=e.toLowerCase())in _.objects)return!0;for(t=0;t<_.legend_aggregates.length;t++)if((r=_.legend_aggregates[t])[0]===e)return!0;for(t=0;t<_.legend_properties.length;t++)if((r=_.legend_properties[t])[0]===e)return!0;for(var t=0;t<_.legend_synonyms.length;t++){var r=_.legend_synonyms[t];if(r[0]===e)return!0}return!1}(G)?(n('Cannot reference "'+G.toUpperCase()+'" in the LEGEND section; it has not been defined yet.',_.lineNumber),_.tokenIndex++,"ERROR"):(_.tokenIndex++,"NAME"):(_.tokenIndex++,"LOGICWORD");case"rules":if(k){var V=h.exec(w.string)[0];_.rules.push([V,_.lineNumber,x]),_.tokenIndex=0}if(-4===_.tokenIndex)return w.skipToEnd(),"MESSAGE";if(w.match(/\s*\-\>\s*/,!0))return"ARROW";if("["===I||"|"===I||"]"===I||"+"===I)return"+"!==I&&(_.tokenIndex=1),w.next(),w.match(/\s*/,!0),"BRACKET";var U=w.match(/[^\[\|\]\s]*/,!0)[0].trim();return 0===_.tokenIndex&&p.exec(U)?"BRACKET":0===_.tokenIndex&&v.exec(U)?(w.match(/\s*/,!0),"DIRECTION"):1===_.tokenIndex&&d.exec(U)?(w.match(/\s*/,!0),"DIRECTION"):_.names.indexOf(U)>=0?k?(n("Identifiers cannot appear outside of square brackes in rules, only directions can.",_.lineNumber),"ERROR"):(w.match(/\s*/,!0),"NAME"):"..."===U?"DIRECTION":"rigid"===U?"DIRECTION":"random"===U?"DIRECTION":r.indexOf(U)>=0?("message"===U&&(_.tokenIndex=-4),"COMMAND"):(n('Name "'+U+'", referred to in a rule, does not exist.',_.lineNumber),"ERROR");case"winconditions":if(k){var J=h.exec(w.string)[0].split(/\s/).filter(function(e){return""!==e});J.push(_.lineNumber),_.winconditions.push(J),_.tokenIndex=-1}if(_.tokenIndex++,null===(Z=w.match(/\s*\w+\s*/)))return n("incorrect format of win condition.",_.lineNumber),w.match(h,!0),"ERROR";var Y=Z[0].trim();if(0===_.tokenIndex)return b.exec(Y)?"LOGICWORD":"ERROR";if(2===_.tokenIndex)return"on"!=Y?"ERROR":"LOGICWORD";if(1===_.tokenIndex||3===_.tokenIndex)return-1===_.names.indexOf(Y)?(n('Error in win condition: "'+Y.toUpperCase()+'" is not a valid object name.',_.lineNumber),"ERROR"):"NAME";break;case"levels":if(k){if(w.match(/\s*message\s*/,!0)){_.tokenIndex=1;var K=["\n",x.slice(w.pos).trim()];return 0==_.levels[_.levels.length-1].length?_.levels.splice(_.levels.length-1,0,K):_.levels.push(K),"MESSAGE_VERB"}var X=w.match(h,!1)[0].trim();_.tokenIndex=2;var Q=_.levels[_.levels.length-1];"\n"==Q[0]?_.levels.push([_.lineNumber,X]):(0==Q.length&&Q.push(_.lineNumber),Q.push(X))}else if(1==_.tokenIndex)return w.skipToEnd(),"MESSAGE";if(2===_.tokenIndex&&!w.eol())return I=w.peek(),w.next(),_.abbrevNames.indexOf(I)>=0?"LEVEL":(n('Key "'+I.toUpperCase()+'" not found. Do you need to add it to the legend, or define a new object?',_.lineNumber),"ERROR");break;default:if(k&&(_.tokenIndex=0),0!=_.tokenIndex)return w.match(h,!0),"METADATATEXT";var Z=w.match(/\s*\w+\s*/);if(null!==Z){var $=Z[0].trim();if(k){if(["title","author","homepage","background_color","text_color","key_repeat_interval","realtime_interval","again_interval","flickscreen","zoomscreen","color_palette","youtube"].indexOf($)>=0){"youtube"!==$&&"author"!==$&&"title"!==$||(w.string=x);var ee=w.match(h,!1);return null!=ee?(_.metadata.push($),_.metadata.push(ee[0].trim())):n('MetaData "'+$+'" needs a value.',_.lineNumber),_.tokenIndex=1,"METADATA"}return["run_rules_on_level_start","norepeat_action","require_player_movement","debug","verbose_logging","throttle_movement","noundo","noaction","norestart","scanline"].indexOf($)>=0?(_.metadata.push($),_.metadata.push("true"),_.tokenIndex=-1,"METADATA"):(n("Unrecognised stuff in metadata section.",_.lineNumber),"ERROR")}return-1==_.tokenIndex?(n('MetaData "'+$+'" has no parameters.',_.lineNumber),"ERROR"):"METADATA"}}return w.eol()?null:w.eol()?void 0:(w.next(),null)},startState:function(){return{objects:{},lineNumber:0,commentLevel:0,section:"",visitedSections:[],objects_candname:"",objects_section:0,objects_spritematrix:[],collisionLayers:[],tokenIndex:0,legend_synonyms:[],legend_aggregates:[],legend_properties:[],sounds:[],rules:[],names:[],winconditions:[],metadata:[],abbrevNames:[],levels:[[]],subsection:""}}}}},function(e,t){Object.defineProperty(t,"__esModule",{value:!0});t.default=function(){"use strict";function e(t,r){if(!(this instanceof e))return new e(t,r);this.options=r=r||{};for(var n in Zn)r.hasOwnProperty(n)||(r[n]=Zn[n]);h(r);var l=r.value;"string"==typeof l&&(l=new xl(l,r.mode)),this.doc=l;var o=this.display=new function(e,t){var r=this,n=r.input=Xr("textarea",null,null,"position: absolute; padding: 0; width: 1px; height: 1em; outline: none");wn?n.style.width="1000px":n.setAttribute("wrap","off"),Tn&&(n.style.border="1px solid black"),n.setAttribute("autocorrect","off"),n.setAttribute("autocapitalize","off"),n.setAttribute("spellcheck","false"),r.inputDiv=Xr("div",[n],null,"overflow: hidden; position: relative; width: 3px; height: 0px;"),r.scrollbarH=Xr("div",[Xr("div",null,null,"height: 100%; min-height: 1px")],"CodeMirror-hscrollbar"),r.scrollbarV=Xr("div",[Xr("div",null,null,"min-width: 1px")],"CodeMirror-vscrollbar"),r.scrollbarFiller=Xr("div",null,"CodeMirror-scrollbar-filler"),r.gutterFiller=Xr("div",null,"CodeMirror-gutter-filler"),r.lineDiv=Xr("div",null,"CodeMirror-code"),r.selectionDiv=Xr("div",null,null,"position: relative; z-index: 1"),r.cursorDiv=Xr("div",null,"CodeMirror-cursors"),r.measure=Xr("div",null,"CodeMirror-measure"),r.lineMeasure=Xr("div",null,"CodeMirror-measure"),r.lineSpace=Xr("div",[r.measure,r.lineMeasure,r.selectionDiv,r.cursorDiv,r.lineDiv],null,"position: relative; outline: none"),r.mover=Xr("div",[Xr("div",[r.lineSpace],"CodeMirror-lines")],null,"position: relative"),r.sizer=Xr("div",[r.mover],"CodeMirror-sizer"),r.heightForcer=Xr("div",null,null,"position: absolute; height: "+Al+"px; width: 1px;"),r.gutters=Xr("div",null,"CodeMirror-gutters"),r.lineGutter=null,r.scroller=Xr("div",[r.sizer,r.heightForcer,r.gutters],"CodeMirror-scroll"),r.scroller.setAttribute("tabIndex","-1"),r.wrapper=Xr("div",[r.inputDiv,r.scrollbarH,r.scrollbarV,r.scrollbarFiller,r.gutterFiller,r.scroller],"CodeMirror"),pn&&(r.gutters.style.zIndex=-1,r.scroller.style.paddingRight=0),Tn&&(n.style.width="0px"),wn||(r.scroller.draggable=!0),Mn&&(r.inputDiv.style.height="1px",r.inputDiv.style.position="absolute"),pn&&(r.scrollbarH.style.minHeight=r.scrollbarV.style.minWidth="18px"),e.appendChild?e.appendChild(r.wrapper):e(r.wrapper),r.viewFrom=r.viewTo=t.first,r.view=[],r.externalMeasured=null,r.viewOffset=0,r.lastSizeC=0,r.updateLineNumbers=null,r.lineNumWidth=r.lineNumInnerWidth=r.lineNumChars=null,r.prevInput="",r.alignWidgets=!1,r.pollingFast=!1,r.poll=new jr,r.cachedCharWidth=r.cachedTextHeight=r.cachedPaddingH=null,r.inaccurateSelection=!1,r.maxLine=null,r.maxLineLength=0,r.maxLineChanged=!1,r.wheelDX=r.wheelDY=r.wheelStartX=r.wheelStartY=null,r.shift=!1}(t,l);o.wrapper.CodeMirror=this,s(this),i(this),r.lineWrapping&&(this.display.wrapper.className+=" CodeMirror-wrap"),r.autofocus&&!In&&He(this),this.state={keyMaps:[],overlays:[],modeGen:0,overwrite:!1,focused:!1,suppressEdits:!1,pasteIncoming:!1,cutIncoming:!1,draggingText:!1,highlight:new jr},dn&&setTimeout(Jr(je,this,!0),20),function(e){function t(){e.state.focused&&setTimeout(Jr(He,e),0)}function r(){null==a&&(a=setTimeout(function(){a=null,i.cachedCharWidth=i.cachedTextHeight=i.cachedPaddingH=Vl=null,e.setSize()},100))}function n(){$r(document.body,i.wrapper)?setTimeout(n,5e3):Il(window,"resize",r)}function l(t){Pr(e,t)||Ll(t)}function o(t){i.inaccurateSelection&&(i.prevInput="",i.inaccurateSelection=!1,i.input.value=e.getSelection(),Hl(i.input)),"cut"==t.type&&(e.state.cutIncoming=!0)}var i=e.display;Tl(i.scroller,"mousedown",Me(e,Ve)),dn?Tl(i.scroller,"dblclick",Me(e,function(t){if(!Pr(e,t)){var r=Ge(e,t);if(r&&!Je(e,t)&&!qe(e.display,t)){Sl(t);var n=St(e.doc,r);j(e.doc,n.anchor,n.head)}}})):Tl(i.scroller,"dblclick",function(t){Pr(e,t)||Sl(t)}),Tl(i.lineSpace,"selectstart",function(e){qe(i,e)||Sl(e)}),Nn||Tl(i.scroller,"contextmenu",function(t){it(e,t)}),Tl(i.scroller,"scroll",function(){i.scroller.clientHeight&&(Ke(e,i.scroller.scrollTop),Xe(e,i.scroller.scrollLeft,!0),Rl(e,"scroll",e))}),Tl(i.scrollbarV,"scroll",function(){i.scroller.clientHeight&&Ke(e,i.scrollbarV.scrollTop)}),Tl(i.scrollbarH,"scroll",function(){i.scroller.clientHeight&&Xe(e,i.scrollbarH.scrollLeft)}),Tl(i.scroller,"mousewheel",function(t){Qe(e,t)}),Tl(i.scroller,"DOMMouseScroll",function(t){Qe(e,t)}),Tl(i.scrollbarH,"mousedown",t),Tl(i.scrollbarV,"mousedown",t),Tl(i.wrapper,"scroll",function(){i.wrapper.scrollTop=i.wrapper.scrollLeft=0});var a;Tl(window,"resize",r),setTimeout(n,5e3),Tl(i.input,"keyup",Me(e,rt)),Tl(i.input,"input",function(){yn&&!vn&&e.display.inputHasSelection&&(e.display.inputHasSelection=null),Be(e)}),Tl(i.input,"keydown",Me(e,tt)),Tl(i.input,"keypress",Me(e,nt)),Tl(i.input,"focus",Jr(lt,e)),Tl(i.input,"blur",Jr(ot,e)),e.options.dragDrop&&(Tl(i.scroller,"dragstart",function(t){!function(e,t){if(dn&&(!e.state.draggingText||+new Date-Vn<100))Ll(t);else if(!Pr(e,t)&&!qe(e.display,t)&&(t.dataTransfer.setData("Text",e.getSelection()),t.dataTransfer.setDragImage&&!Cn)){var r=Xr("img",null,null,"position: fixed; left: 0; top: 0;");r.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",kn&&(r.width=r.height=1,e.display.wrapper.appendChild(r),r._top=r.offsetTop),t.dataTransfer.setDragImage(r,0,0),kn&&r.parentNode.removeChild(r)}}(e,t)}),Tl(i.scroller,"dragenter",l),Tl(i.scroller,"dragover",l),Tl(i.scroller,"drop",Me(e,Ye))),Tl(i.scroller,"paste",function(t){qe(i,t)||(e.state.pasteIncoming=!0,He(e),Be(e))}),Tl(i.input,"paste",function(){e.state.pasteIncoming=!0,Be(e)}),Tl(i.input,"cut",o),Tl(i.input,"copy",o),Mn&&Tl(i.sizer,"mouseup",function(){en()==i.input&&i.input.blur(),He(e)})}(this);var a=this;Ce(this,function(){a.curOp.forceUpdate=!0,hr(a,l),r.autofocus&&!In||en()==o.input?setTimeout(Jr(lt,a),20):ot(a);for(var e in $n)$n.hasOwnProperty(e)&&$n[e](a,r[e],el);for(var t=0;t<ll.length;++t)ll[t](a)})}function t(t){t.doc.mode=e.getMode(t.options,t.doc.modeOption),r(t)}function r(e){e.doc.iter(function(e){e.stateAfter&&(e.stateAfter=null),e.styles&&(e.styles=null)}),e.doc.frontier=e.doc.first,Z(e,100),e.state.modeGen++,e.curOp&&Ie(e)}function n(e){var t=we(e.display),r=e.options.lineWrapping,n=r&&Math.max(5,e.display.scroller.clientWidth/_e(e.display)-3);return function(l){if(Jt(e.doc,l))return 0;var o=0;if(l.widgets)for(var i=0;i<l.widgets.length;i++)l.widgets[i].height&&(o+=l.widgets[i].height);return r?o+(Math.ceil(l.text.length/n)||1)*t:o+t}}function l(e){var t=e.doc,r=n(e);t.iter(function(e){var t=r(e);t!=e.height&&pr(e,t)})}function o(e){var t=cl[e.options.keyMap].style;e.display.wrapper.className=e.display.wrapper.className.replace(/\s*cm-keymap-\S+/g,"")+(t?" cm-keymap-"+t:"")}function i(e){e.display.wrapper.className=e.display.wrapper.className.replace(/\s*cm-s-\S+/g,"")+e.options.theme.replace(/(^|\s)\s*/g," cm-s-"),ue(e)}function a(e){s(e),Ie(e),setTimeout(function(){p(e)},20)}function s(e){var t=e.display.gutters,r=e.options.gutters;Qr(t);for(var n=0;n<r.length;++n){var l=r[n],o=t.appendChild(Xr("div",null,"CodeMirror-gutter "+l));"CodeMirror-linenumbers"==l&&(e.display.lineGutter=o,o.style.width=(e.display.lineNumWidth||1)+"px")}t.style.display=n?"":"none";var i=t.offsetWidth;e.display.sizer.style.marginLeft=i+"px",n&&(e.display.scrollbarH.style.left=e.options.fixedGutter?i+"px":0)}function c(e){if(0==e.height)return 0;for(var t,r=e.text.length,n=e;t=Wt(n);)n=(l=t.find(0,!0)).from.line,r+=l.from.ch-l.to.ch;for(n=e;t=zt(n);){var l=t.find(0,!0);r-=n.text.length-l.from.ch,r+=(n=l.to.line).text.length-l.to.ch}return r}function u(e){var t=e.display,r=e.doc;t.maxLine=fr(r,r.first),t.maxLineLength=c(t.maxLine),t.maxLineChanged=!0,r.iter(function(e){var r=c(e);r>t.maxLineLength&&(t.maxLineLength=r,t.maxLine=e)})}function h(e){var t=qr(e.gutters,"CodeMirror-linenumbers");-1==t&&e.lineNumbers?e.gutters=e.gutters.concat(["CodeMirror-linenumbers"]):t>-1&&!e.lineNumbers&&(e.gutters=e.gutters.slice(0),e.gutters.splice(t,1))}function f(e){var t=e.display.scroller;return{clientHeight:t.clientHeight,barHeight:e.display.scrollbarV.clientHeight,scrollWidth:t.scrollWidth,clientWidth:t.clientWidth,barWidth:e.display.scrollbarH.clientWidth,docHeight:Math.round(e.doc.height+re(e.display))}}function g(e,t){t||(t=f(e));var r=e.display,n=t.docHeight+Al,l=t.scrollWidth>t.clientWidth,o=n>t.clientHeight;if(o?(r.scrollbarV.style.display="block",r.scrollbarV.style.bottom=l?tn(r.measure)+"px":"0",r.scrollbarV.firstChild.style.height=Math.max(0,n-t.clientHeight+(t.barHeight||r.scrollbarV.clientHeight))+"px"):(r.scrollbarV.style.display="",r.scrollbarV.firstChild.style.height="0"),l?(r.scrollbarH.style.display="block",r.scrollbarH.style.right=o?tn(r.measure)+"px":"0",r.scrollbarH.firstChild.style.width=t.scrollWidth-t.clientWidth+(t.barWidth||r.scrollbarH.clientWidth)+"px"):(r.scrollbarH.style.display="",r.scrollbarH.firstChild.style.width="0"),l&&o?(r.scrollbarFiller.style.display="block",r.scrollbarFiller.style.height=r.scrollbarFiller.style.width=tn(r.measure)+"px"):r.scrollbarFiller.style.display="",l&&e.options.coverGutterNextToScrollbar&&e.options.fixedGutter?(r.gutterFiller.style.display="block",r.gutterFiller.style.height=tn(r.measure)+"px",r.gutterFiller.style.width=r.gutters.offsetWidth+"px"):r.gutterFiller.style.display="",Sn&&0===tn(r.measure)){r.scrollbarV.style.minWidth=r.scrollbarH.style.minHeight=En?"18px":"12px";var i=function(t){Or(t)!=r.scrollbarV&&Or(t)!=r.scrollbarH&&Me(e,Ve)(t)};Tl(r.scrollbarV,"mousedown",i),Tl(r.scrollbarH,"mousedown",i)}}function d(e,t,r){var n=r&&null!=r.top?r.top:e.scroller.scrollTop;n=Math.floor(n-te(e));var l=r&&null!=r.bottom?r.bottom:n+e.wrapper.clientHeight,o=mr(t,n),i=mr(t,l);if(r&&r.ensure){var a=r.ensure.from.line,s=r.ensure.to.line;if(a<o)return{from:a,to:mr(t,br(fr(t,a))+e.wrapper.clientHeight)};if(Math.min(s,t.lastLine())>=i)return{from:mr(t,br(fr(t,s))-e.wrapper.clientHeight),to:s}}return{from:o,to:i}}function p(e){var t=e.display,r=t.view;if(t.alignWidgets||t.gutters.firstChild&&e.options.fixedGutter){for(var n=m(t)-t.scroller.scrollLeft+e.doc.scrollLeft,l=t.gutters.offsetWidth,o=n+"px",i=0;i<r.length;i++)if(!r[i].hidden){e.options.fixedGutter&&r[i].gutter&&(r[i].gutter.style.left=o);var a=r[i].alignable;if(a)for(var s=0;s<a.length;s++)a[s].style.left=o}e.options.fixedGutter&&(t.gutters.style.left=n+l+"px")}}function v(e,t){return String(e.lineNumberFormatter(t+e.firstLineNumber))}function m(e){return e.scroller.getBoundingClientRect().left-e.sizer.getBoundingClientRect().left}function b(e,t,r){for(var n,l=e.display.viewFrom,o=e.display.viewTo,i=d(e.display,e.doc,t),a=!0;;a=!1){var s=e.display.scroller.clientWidth;if(!function(e,t,r){var n=e.display,l=e.doc;if(n.wrapper.offsetWidth){if(!(!r&&t.from>=n.viewFrom&&t.to<=n.viewTo&&0==Ne(e))){(function(e){if(!e.options.lineNumbers)return!1;var t=e.doc,r=v(e.options,t.first+t.size-1),n=e.display;if(r.length!=n.lineNumChars){var l=n.measure.appendChild(Xr("div",[Xr("div",r)],"CodeMirror-linenumber CodeMirror-gutter-elt")),o=l.firstChild.offsetWidth,i=l.offsetWidth-o;n.lineGutter.style.width="",n.lineNumInnerWidth=Math.max(o,n.lineGutter.offsetWidth-i),n.lineNumWidth=n.lineNumInnerWidth+i,n.lineNumChars=n.lineNumInnerWidth?r.length:-1,n.lineGutter.style.width=n.lineNumWidth+"px";var a=n.gutters.offsetWidth;return n.scrollbarH.style.left=e.options.fixedGutter?a+"px":0,n.sizer.style.marginLeft=a+"px",!0}return!1})(e)&&Oe(e);var o=w(e),i=l.first+l.size,a=Math.max(t.from-e.options.viewportMargin,l.first),s=Math.min(i,t.to+e.options.viewportMargin);n.viewFrom<a&&a-n.viewFrom<20&&(a=Math.max(l.first,n.viewFrom)),n.viewTo>s&&n.viewTo-s<20&&(s=Math.min(i,n.viewTo)),Bn&&(a=Vt(e.doc,a),s=Ut(e.doc,s));var c=a!=n.viewFrom||s!=n.viewTo||n.lastSizeC!=n.wrapper.clientHeight;(function(e,t,r){var n=e.display;0==n.view.length||t>=n.viewTo||r<=n.viewFrom?(n.view=Te(e,t,r),n.viewFrom=t):(n.viewFrom>t?n.view=Te(e,t,n.viewFrom).concat(n.view):n.viewFrom<t&&(n.view=n.view.slice(Ae(e,t))),n.viewFrom=t,n.viewTo<r?n.view=n.view.concat(Te(e,n.viewTo,r)):n.viewTo>r&&(n.view=n.view.slice(0,Ae(e,r)))),n.viewTo=r})(e,a,s),n.viewOffset=br(fr(e.doc,n.viewFrom)),e.display.mover.style.top=n.viewOffset+"px";var u=Ne(e);if(c||0!=u||r){var h=en();return u>4&&(n.lineDiv.style.display="none"),function(e,t,r){function n(t){var r=t.nextSibling;return wn&&Rn&&e.display.currentWheelTarget==t?t.style.display="none":t.parentNode.removeChild(t),r}for(var l=e.display,o=e.options.lineNumbers,i=l.lineDiv,a=i.firstChild,s=l.view,c=l.viewFrom,u=0;u<s.length;u++){var h=s[u];if(h.hidden);else if(h.node){for(;a!=h.node;)a=n(a);var f=o&&null!=t&&t<=c&&h.lineNumber;h.changes&&(qr(h.changes,"gutter")>-1&&(f=!1),_(e,h,c,r)),f&&(Qr(h.lineNumber),h.lineNumber.appendChild(document.createTextNode(v(e.options,c)))),a=h.node.nextSibling}else{var g=function(e,t,r,n){var l=k(e,t);return t.text=t.node=l.pre,l.bgClass&&(t.bgClass=l.bgClass),l.textClass&&(t.textClass=l.textClass),C(t),M(e,t,r,n),S(t,n),t.node}(e,h,c,r);i.insertBefore(g,a)}c+=h.size}for(;a;)a=n(a)}(e,n.updateLineNumbers,o),u>4&&(n.lineDiv.style.display=""),h&&en()!=h&&h.offsetHeight&&h.focus(),Qr(n.cursorDiv),Qr(n.selectionDiv),c&&(n.lastSizeC=n.wrapper.clientHeight,Z(e,400)),function(e){for(var t=e.display,r=t.lineDiv.offsetTop,n=0;n<t.view.length;n++){var l,o=t.view[n];if(!o.hidden){if(pn){var i=o.node.offsetTop+o.node.offsetHeight;l=i-r,r=i}else{var a=o.node.getBoundingClientRect();l=a.bottom-a.top}var s=o.line.height-l;if(l<2&&(l=we(t)),(s>.001||s<-.001)&&(pr(o.line,l),y(o.line),o.rest))for(var c=0;c<o.rest.length;c++)y(o.rest[c])}}}(e),!0}}}else Oe(e)}(e,i,r))break;n=!0,e.display.maxLineChanged&&!e.options.lineWrapping&&function(e){var t=e.display,r=le(e,t.maxLine,t.maxLine.text.length).left;t.maxLineChanged=!1;var n=Math.max(0,r+3),l=Math.max(0,t.sizer.offsetLeft+n+Al-t.scroller.clientWidth);t.sizer.style.minWidth=n+"px",l<e.doc.scrollLeft&&Xe(e,Math.min(t.scroller.scrollLeft,l),!0)}(e);var c=f(e);if(X(e),function(e,t){e.display.sizer.style.minHeight=e.display.heightForcer.style.top=t.docHeight+"px",e.display.gutters.style.height=Math.max(t.docHeight,t.clientHeight-Al)+"px"}(e,c),g(e,c),a&&e.options.lineWrapping&&s!=e.display.scroller.clientWidth)r=!0;else if(r=!1,t&&null!=t.top&&(t={top:Math.min(c.docHeight-Al-c.clientHeight,t.top)}),(i=d(e.display,e.doc,t)).from>=e.display.viewFrom&&i.to<=e.display.viewTo)break}return e.display.updateLineNumbers=null,n&&(Dr(e,"update",e),e.display.viewFrom==l&&e.display.viewTo==o||Dr(e,"viewportChange",e,e.display.viewFrom,e.display.viewTo)),n}function y(e){if(e.widgets)for(var t=0;t<e.widgets.length;++t)e.widgets[t].height=e.widgets[t].node.offsetHeight}function w(e){for(var t=e.display,r={},n={},l=t.gutters.firstChild,o=0;l;l=l.nextSibling,++o)r[e.options.gutters[o]]=l.offsetLeft,n[e.options.gutters[o]]=l.offsetWidth;return{fixedPos:m(t),gutterTotalWidth:t.gutters.offsetWidth,gutterLeft:r,gutterWidth:n,wrapperWidth:t.wrapper.clientWidth}}function _(e,t,r,n){for(var l=0;l<t.changes.length;l++){var o=t.changes[l];"text"==o?function(e,t){var r=t.text.className,n=k(e,t);t.text==t.node&&(t.node=n.pre),t.text.parentNode.replaceChild(n.pre,t.text),t.text=n.pre,n.bgClass!=t.bgClass||n.textClass!=t.textClass?(t.bgClass=n.bgClass,t.textClass=n.textClass,C(t)):r&&(t.text.className=r)}(e,t):"gutter"==o?M(e,t,r,n):"class"==o?C(t):"widget"==o&&function(e,t){e.alignable&&(e.alignable=null);for(var r=e.node.firstChild;r;r=n){var n=r.nextSibling;"CodeMirror-linewidget"==r.className&&e.node.removeChild(r)}S(e,t)}(t,n)}t.changes=null}function x(e){return e.node==e.text&&(e.node=Xr("div",null,null,"position: relative"),e.text.parentNode&&e.text.parentNode.replaceChild(e.node,e.text),e.node.appendChild(e.text),pn&&(e.node.style.zIndex=2)),e.node}function k(e,t){var r=e.display.externalMeasured;return r&&r.line==t.line?(e.display.externalMeasured=null,t.measure=r.measure,r.built):nr(e,t)}function C(e){!function(e){var t=e.bgClass?e.bgClass+" "+(e.line.bgClass||""):e.line.bgClass;if(t&&(t+=" CodeMirror-linebackground"),e.background)t?e.background.className=t:(e.background.parentNode.removeChild(e.background),e.background=null);else if(t){var r=x(e);e.background=r.insertBefore(Xr("div",null,t),r.firstChild)}}(e),e.line.wrapClass?x(e).className=e.line.wrapClass:e.node!=e.text&&(e.node.className="");var t=e.textClass?e.textClass+" "+(e.line.textClass||""):e.line.textClass;e.text.className=t||""}function M(e,t,r,n){t.gutter&&(t.node.removeChild(t.gutter),t.gutter=null);var l=t.line.gutterMarkers;if(e.options.lineNumbers||l){var o=x(t),i=t.gutter=o.insertBefore(Xr("div",null,"CodeMirror-gutter-wrapper","position: absolute; left: "+(e.options.fixedGutter?n.fixedPos:-n.gutterTotalWidth)+"px"),t.text);if(!e.options.lineNumbers||l&&l["CodeMirror-linenumbers"]||(t.lineNumber=i.appendChild(Xr("div",v(e.options,r),"CodeMirror-linenumber CodeMirror-gutter-elt","left: "+n.gutterLeft["CodeMirror-linenumbers"]+"px; width: "+e.display.lineNumInnerWidth+"px"))),l)for(var a=0;a<e.options.gutters.length;++a){var s=e.options.gutters[a],c=l.hasOwnProperty(s)&&l[s];c&&i.appendChild(Xr("div",[c],"CodeMirror-gutter-elt","left: "+n.gutterLeft[s]+"px; width: "+n.gutterWidth[s]+"px"))}}}function S(e,t){if(E(e.line,e,t,!0),e.rest)for(var r=0;r<e.rest.length;r++)E(e.rest[r],e,t,!1)}function E(e,t,r,n){if(e.widgets)for(var l=x(t),o=0,i=e.widgets;o<i.length;++o){var a=i[o],s=Xr("div",[a.node],"CodeMirror-linewidget");a.handleMouseEvents||(s.ignoreEvents=!0),function(e,t,r,n){if(e.noHScroll){(r.alignable||(r.alignable=[])).push(t);var l=n.wrapperWidth;t.style.left=n.fixedPos+"px",e.coverGutter||(l-=n.gutterTotalWidth,t.style.paddingLeft=n.gutterTotalWidth+"px"),t.style.width=l+"px"}e.coverGutter&&(t.style.zIndex=5,t.style.position="relative",e.noHScroll||(t.style.marginLeft=-n.gutterTotalWidth+"px"))}(a,s,t,r),n&&a.above?l.insertBefore(s,t.gutter||t.text):l.appendChild(s),Dr(a,"redraw")}}function L(e){return Fn(e.line,e.ch)}function T(e,t){return jn(e,t)<0?t:e}function I(e,t){return jn(e,t)<0?e:t}function R(e,t){this.ranges=e,this.primIndex=t}function O(e,t){this.anchor=e,this.head=t}function A(e,t){var r=e[t];e.sort(function(e,t){return jn(e.from(),t.from())}),t=qr(e,r);for(var n=1;n<e.length;n++){var l=e[n],o=e[n-1];if(jn(o.to(),l.from())>=0){var i=I(o.from(),l.from()),a=T(o.to(),l.to()),s=o.empty()?l.from()==l.head:o.from()==o.head;n<=t&&--t,e.splice(--n,2,new O(s?a:i,s?i:a))}}return new R(e,t)}function D(e,t){return new R([new O(e,t||e)],0)}function N(e,t){return Math.max(e.first,Math.min(t,e.first+e.size-1))}function P(e,t){if(t.line<e.first)return Fn(e.first,0);var r=e.first+e.size-1;return t.line>r?Fn(r,fr(e,r).text.length):function(e,t){var r=e.ch;return null==r||r>t?Fn(e.line,t):r<0?Fn(e.line,0):e}(t,fr(e,t.line).text.length)}function B(e,t){return t>=e.first&&t<e.first+e.size}function F(e,t,r,n){if(e.cm&&e.cm.display.shift||e.extend){var l=t.anchor;if(n){var o=jn(r,l)<0;o!=jn(n,l)<0?(l=r,r=n):o!=jn(r,n)<0&&(r=n)}return new O(l,r)}return new O(n||r,r)}function j(e,t,r,n){G(e,new R([F(e,e.sel.primary(),t,r)],0),n)}function H(e,t,r){for(var n=[],l=0;l<e.sel.ranges.length;l++)n[l]=F(e,e.sel.ranges[l],t[l],null);G(e,A(n,e.sel.primIndex),r)}function W(e,t,r,n){var l=e.sel.ranges.slice(0);l[t]=r,G(e,A(l,e.sel.primIndex),n)}function z(e,t,r,n){G(e,D(t,r),n)}function q(e,t,r){var n=e.history.done,l=zr(n);l&&l.ranges?(n[n.length-1]=t,V(e,t,r)):G(e,t,r)}function G(e,t,r){V(e,t,r),function(e,t,r,n){var l=e.history,o=n&&n.origin;r==l.lastOp||o&&l.lastSelOrigin==o&&(l.lastModTime==l.lastSelTime&&l.lastOrigin==o||function(e,t,r,n){var l=t.charAt(0);return"*"==l||"+"==l&&r.ranges.length==n.ranges.length&&r.somethingSelected()==n.somethingSelected()&&new Date-e.history.lastSelTime<=(e.cm?e.cm.options.historyEventDelay:500)}(e,o,zr(l.done),t))?l.done[l.done.length-1]=t:Cr(t,l.done),l.lastSelTime=+new Date,l.lastSelOrigin=o,l.lastOp=r,n&&!1!==n.clearRedo&&xr(l.undone)}(e,e.sel,e.cm?e.cm.curOp.id:NaN,r)}function V(e,t,r){(Br(e,"beforeSelectionChange")||e.cm&&Br(e.cm,"beforeSelectionChange"))&&(t=function(e,t){var r={ranges:t.ranges,update:function(t){this.ranges=[];for(var r=0;r<t.length;r++)this.ranges[r]=new O(P(e,t[r].anchor),P(e,t[r].head))}};return Rl(e,"beforeSelectionChange",e,r),e.cm&&Rl(e.cm,"beforeSelectionChange",e.cm,r),r.ranges!=t.ranges?A(r.ranges,r.ranges.length-1):t}(e,t)),U(e,Y(e,t,jn(t.primary().head,e.sel.primary().head)<0?-1:1,!0)),r&&!1===r.scroll||!e.cm||yt(e.cm)}function U(e,t){t.equals(e.sel)||(e.sel=t,e.cm&&(e.cm.curOp.updateInput=e.cm.curOp.selectionChanged=e.cm.curOp.cursorActivity=!0),Dr(e,"cursorActivity",e))}function J(e){U(e,Y(e,e.sel,null,!1))}function Y(e,t,r,n){for(var l,o=0;o<t.ranges.length;o++){var i=t.ranges[o],a=K(e,i.anchor,r,n),s=K(e,i.head,r,n);(l||a!=i.anchor||s!=i.head)&&(l||(l=t.ranges.slice(0,o)),l[o]=new O(a,s))}return l?A(l,t.primIndex):t}function K(e,t,r,n){var l=!0;e:for(;l;){var o=e,i=t,a=r,s=n;l=!1;var c=!1,u=i,h=a||1;o.cantEdit=!1;t:for(;;){var f=fr(o,u.line);if(f.markedSpans)for(var g=0;g<f.markedSpans.length;++g){var d=f.markedSpans[g],p=d.marker;if((null==d.from||(p.inclusiveLeft?d.from<=u.ch:d.from<u.ch))&&(null==d.to||(p.inclusiveRight?d.to>=u.ch:d.to>u.ch))){if(s&&(Rl(p,"beforeCursorEnter"),p.explicitlyCleared)){if(f.markedSpans){--g;continue}break}if(!p.atomic)continue;var v=p.find(h<0?-1:1);if(0==jn(v,u)&&(v.ch+=h,v.ch<0?v=v.line>o.first?P(o,Fn(v.line-1)):null:v.ch>f.text.length&&(v=v.line<o.first+o.size-1?Fn(v.line+1,0):null),!v)){if(c){if(!s){e=o,t=i,r=a,n=!0,l=!0,c=u=h=f=g=d=p=v=void 0;continue e}return o.cantEdit=!0,Fn(o.first,0)}c=!0,v=i,h=-h}u=v;continue t}}return u}}}function X(e){for(var t=e.display,r=e.doc,n=document.createDocumentFragment(),l=document.createDocumentFragment(),o=0;o<r.sel.ranges.length;o++){var i=r.sel.ranges[o],a=i.empty();(a||e.options.showCursorWhenSelecting)&&function(e,t,r){var n=ve(e,t.head,"div"),l=r.appendChild(Xr("div","","CodeMirror-cursor"));if(l.style.left=n.left+"px",l.style.top=n.top+"px",l.style.height=Math.max(0,n.bottom-n.top)*e.options.cursorHeight+"px",n.other){var o=r.appendChild(Xr("div","","CodeMirror-cursor CodeMirror-secondarycursor"));o.style.display="",o.style.left=n.other.left+"px",o.style.top=n.other.top+"px",o.style.height=.85*(n.other.bottom-n.other.top)+"px"}}(e,i,n),a||function(e,t,r){function n(e,t,r,n){t<0&&(t=0),a.appendChild(Xr("div",null,"CodeMirror-selected","position: absolute; left: "+e+"px; top: "+t+"px; width: "+(null==r?u-e:r)+"px; height: "+(n-t)+"px"))}function l(t,r,l){function o(r,n){return pe(e,Fn(t,r),"div",h,n)}var a,s,h=fr(i,t),f=h.text.length;return function(e,t,r,n){if(!e)return n(t,r,"ltr");for(var l=!1,o=0;o<e.length;++o){var i=e[o];(i.from<r&&i.to>t||t==r&&i.to==t)&&(n(Math.max(i.from,t),Math.min(i.to,r),1==i.level?"rtl":"ltr"),l=!0)}l||n(t,r,"ltr")}(yr(h),r||0,null==l?f:l,function(e,t,i){var h,g,d,p=o(e,"left");if(e==t)h=p,g=d=p.left;else{if(h=o(t-1,"right"),"rtl"==i){var v=p;p=h,h=v}g=p.left,d=h.right}null==r&&0==e&&(g=c),h.top-p.top>3&&(n(g,p.top,null,p.bottom),g=c,p.bottom<h.top&&n(g,p.bottom,null,h.top)),null==l&&t==f&&(d=u),(!a||p.top<a.top||p.top==a.top&&p.left<a.left)&&(a=p),(!s||h.bottom>s.bottom||h.bottom==s.bottom&&h.right>s.right)&&(s=h),g<c+1&&(g=c),n(g,h.top,d-g,h.bottom)}),{start:a,end:s}}var o=e.display,i=e.doc,a=document.createDocumentFragment(),s=ne(e.display),c=s.left,u=o.lineSpace.offsetWidth-s.right,h=t.from(),f=t.to();if(h.line==f.line)l(h.line,h.ch,f.ch);else{var g=fr(i,h.line),d=fr(i,f.line),p=Gt(g)==Gt(d),v=l(h.line,h.ch,p?g.text.length+1:null).end,m=l(f.line,p?0:null,f.ch).start;p&&(v.top<m.top-2?(n(v.right,v.top,null,v.bottom),n(c,m.top,m.left,m.bottom)):n(v.right,v.top,m.left-v.right,v.bottom)),v.bottom<m.top&&n(c,v.bottom,null,m.top)}r.appendChild(a)}(e,i,l)}if(e.options.moveInputWithCursor){var s=ve(e,r.sel.primary().head,"div"),c=t.wrapper.getBoundingClientRect(),u=t.lineDiv.getBoundingClientRect(),h=Math.max(0,Math.min(t.wrapper.clientHeight-10,s.top+u.top-c.top)),f=Math.max(0,Math.min(t.wrapper.clientWidth-10,s.left+u.left-c.left));t.inputDiv.style.top=h+"px",t.inputDiv.style.left=f+"px"}Zr(t.cursorDiv,n),Zr(t.selectionDiv,l)}function Q(e){if(e.state.focused){var t=e.display;clearInterval(t.blinker);var r=!0;t.cursorDiv.style.visibility="",e.options.cursorBlinkRate>0&&(t.blinker=setInterval(function(){t.cursorDiv.style.visibility=(r=!r)?"":"hidden"},e.options.cursorBlinkRate))}}function Z(e,t){e.doc.mode.startState&&e.doc.frontier<e.display.viewTo&&e.state.highlight.set(t,Jr($,e))}function $(e){var t=e.doc;if(t.frontier<t.first&&(t.frontier=t.first),!(t.frontier>=e.display.viewTo)){var r=+new Date+e.options.workTime,n=il(t.mode,ee(e,t.frontier));Ce(e,function(){t.iter(t.frontier,Math.min(t.first+t.size,e.display.viewTo+500),function(l){if(t.frontier>=e.display.viewFrom){var o=l.styles;l.styles=$t(e,l,n,!0);for(var i=!o||o.length!=l.styles.length,a=0;!i&&a<o.length;++a)i=o[a]!=l.styles[a];i&&Re(e,t.frontier,"text"),l.stateAfter=il(t.mode,n)}else tr(e,l.text,n),l.stateAfter=t.frontier%5==0?il(t.mode,n):null;if(++t.frontier,+new Date>r)return Z(e,e.options.workDelay),!0})})}}function ee(e,t,r){var n=e.doc,l=e.display;if(!n.mode.startState)return!0;var o=function(e,t,r){for(var n,l,o=e.doc,i=r?-1:t-(e.doc.mode.innerMode?1e3:100),a=t;a>i;--a){if(a<=o.first)return o.first;var s=fr(o,a-1);if(s.stateAfter&&(!r||a<=o.frontier))return a;var c=Fl(s.text,null,e.options.tabSize);(null==l||n>c)&&(l=a-1,n=c)}return l}(e,t,r),i=o>n.first&&fr(n,o-1).stateAfter;return i=i?il(n.mode,i):al(n.mode),n.iter(o,t,function(r){tr(e,r.text,i);var a=o==t-1||o%5==0||o>=l.viewFrom&&o<l.viewTo;r.stateAfter=a?il(n.mode,i):null,++o}),r&&(n.frontier=o),i}function te(e){return e.lineSpace.offsetTop}function re(e){return e.mover.offsetHeight-e.lineSpace.offsetHeight}function ne(e){if(e.cachedPaddingH)return e.cachedPaddingH;var t=Zr(e.measure,Xr("pre","x")),r=window.getComputedStyle?window.getComputedStyle(t):t.currentStyle;return e.cachedPaddingH={left:parseInt(r.paddingLeft),right:parseInt(r.paddingRight)}}function le(e,t,r,n){return ae(e,ie(e,t),r,n)}function oe(e,t){if(t>=e.display.viewFrom&&t<e.display.viewTo)return e.display.view[Ae(e,t)];var r=e.display.externalMeasured;return r&&t>=r.lineN&&t<r.lineN+r.size?r:void 0}function ie(e,t){var r=vr(t),n=oe(e,r);n&&!n.text?n=null:n&&n.changes&&_(e,n,r,w(e)),n||(n=function(e,t){var r=vr(t=Gt(t)),n=e.display.externalMeasured=new Le(e.doc,t,r);n.lineN=r;var l=n.built=nr(e,n);return n.text=l.pre,Zr(e.display.lineMeasure,l.pre),n}(e,t));var l=function(e,t,r){if(e.line==t)return{map:e.measure.map,cache:e.measure.cache};for(n=0;n<e.rest.length;n++)if(e.rest[n]==t)return{map:e.measure.maps[n],cache:e.measure.caches[n]};for(var n=0;n<e.rest.length;n++)if(vr(e.rest[n])>r)return{map:e.measure.maps[n],cache:e.measure.caches[n],before:!0}}(n,t,r);return{line:t,view:n,rect:null,map:l.map,cache:l.cache,before:l.before,hasHeights:!1}}function ae(e,t,r,n){t.before&&(r=-1);var l,o=r+(n||"");return t.cache.hasOwnProperty(o)?l=t.cache[o]:(t.rect||(t.rect=t.view.text.getBoundingClientRect()),t.hasHeights||(function(e,t,r){var n=e.options.lineWrapping,l=n&&e.display.scroller.clientWidth;if(!t.measure.heights||n&&t.measure.width!=l){var o=t.measure.heights=[];if(n){t.measure.width=l;for(var i=t.text.firstChild.getClientRects(),a=0;a<i.length-1;a++){var s=i[a],c=i[a+1];Math.abs(s.bottom-c.bottom)>2&&o.push((s.bottom+c.top)/2-r.top)}}o.push(r.bottom-r.top)}}(e,t.view,t.rect),t.hasHeights=!0),(l=function(e,t,r,n){for(var l,o,i,a,s=t.map,c=0;c<s.length;c+=3){var u=s[c],h=s[c+1];if(r<u?(o=0,i=1,a="left"):r<h?i=1+(o=r-u):(c==s.length-3||r==h&&s[c+3]>r)&&(o=(i=h-u)-1,r>=h&&(a="right")),null!=o){if(l=s[c+2],u==h&&n==(l.insertLeft?"left":"right")&&(a=n),"left"==n&&0==o)for(;c&&s[c-2]==s[c-3]&&s[c-1].insertLeft;)l=s[2+(c-=3)],a="left";if("right"==n&&o==h-u)for(;c<s.length-3&&s[c+3]==s[c+4]&&!s[c+5].insertLeft;)l=s[(c+=3)+2],a="right";break}}var f;if(3==l.nodeType){for(;o&&Kr(t.line.text.charAt(u+o));)--o;for(;u+i<h&&Kr(t.line.text.charAt(u+i));)++i;vn&&0==o&&i==h-u?f=l.parentNode.getBoundingClientRect():yn&&e.options.lineWrapping?(g=Wl(l,o,i).getClientRects(),f=g.length?g["right"==n?g.length-1:0]:qn):f=Wl(l,o,i).getBoundingClientRect()}else{o>0&&(a=n="right");var g;f=e.options.lineWrapping&&(g=l.getClientRects()).length>1?g["right"==n?g.length-1:0]:l.getBoundingClientRect()}if(vn&&!o&&(!f||!f.left&&!f.right)){var d=l.parentNode.getClientRects()[0];f=d?{left:d.left,right:d.left+_e(e.display),top:d.top,bottom:d.bottom}:qn}for(var p,v=(f.bottom+f.top)/2-t.rect.top,m=t.view.measure.heights,c=0;c<m.length-1&&!(v<m[c]);c++);p=c?m[c-1]:0,v=m[c];var b={left:("right"==a?f.right:f.left)-t.rect.left,right:("left"==a?f.left:f.right)-t.rect.left,top:p,bottom:v};return f.left||f.right||(b.bogus=!0),b}(e,t,r,n)).bogus||(t.cache[o]=l)),{left:l.left,right:l.right,top:l.top,bottom:l.bottom}}function se(e){if(e.measure&&(e.measure.cache={},e.measure.heights=null,e.rest))for(var t=0;t<e.rest.length;t++)e.measure.caches[t]={}}function ce(e){e.display.externalMeasure=null,Qr(e.display.lineMeasure);for(var t=0;t<e.display.view.length;t++)se(e.display.view[t])}function ue(e){ce(e),e.display.cachedCharWidth=e.display.cachedTextHeight=e.display.cachedPaddingH=null,e.options.lineWrapping||(e.display.maxLineChanged=!0),e.display.lineNumChars=null}function he(){return window.pageXOffset||(document.documentElement||document.body).scrollLeft}function fe(){return window.pageYOffset||(document.documentElement||document.body).scrollTop}function ge(e,t,r,n){if(t.widgets)for(var l=0;l<t.widgets.length;++l)if(t.widgets[l].above){var o=Xt(t.widgets[l]);r.top+=o,r.bottom+=o}if("line"==n)return r;n||(n="local");var i=br(t);if("local"==n?i+=te(e.display):i-=e.display.viewOffset,"page"==n||"window"==n){var a=e.display.lineSpace.getBoundingClientRect();i+=a.top+("window"==n?0:fe());var s=a.left+("window"==n?0:he());r.left+=s,r.right+=s}return r.top+=i,r.bottom+=i,r}function de(e,t,r){if("div"==r)return t;var n=t.left,l=t.top;if("page"==r)n-=he(),l-=fe();else if("local"==r||!r){var o=e.display.sizer.getBoundingClientRect();n+=o.left,l+=o.top}var i=e.display.lineSpace.getBoundingClientRect();return{left:n-i.left,top:l-i.top}}function pe(e,t,r,n,l){return n||(n=fr(e.doc,t.line)),ge(e,n,le(e,n,t.ch,l),r)}function ve(e,t,r,n,l){function o(t,o){var i=ae(e,l,t,o?"right":"left");return o?i.left=i.right:i.right=i.left,ge(e,n,i,r)}function i(e,t){var r=a[t],n=r.level%2;return e==rn(r)&&t&&r.level<a[t-1].level?(e=nn(r=a[--t])-(r.level%2?0:1),n=!0):e==nn(r)&&t<a.length-1&&r.level<a[t+1].level&&(e=rn(r=a[++t])-r.level%2,n=!1),n&&e==r.to&&e>r.from?o(e-1):o(e,n)}n=n||fr(e.doc,t.line),l||(l=ie(e,n));var a=yr(n),s=t.ch;if(!a)return o(s);var c=i(s,cn(a,s));return null!=$l&&(c.other=i(s,$l)),c}function me(e,t){var r=0,t=P(e.doc,t);e.options.lineWrapping||(r=_e(e.display)*t.ch);var n=fr(e.doc,t.line),l=br(n)+te(e.display);return{left:r,right:r,top:l,bottom:l+n.height}}function be(e,t,r,n){var l=Fn(e,t);return l.xRel=n,r&&(l.outside=!0),l}function ye(e,t,r){var n=e.doc;if((r+=e.display.viewOffset)<0)return be(n.first,0,!0,-1);var l=mr(n,r),o=n.first+n.size-1;if(l>o)return be(n.first+n.size-1,fr(n,o).text.length,!0,1);t<0&&(t=0);for(var i=fr(n,l);;){var a=function(e,t,r,n,l){function o(n){var l=ve(e,Fn(r,n),"line",t,c);return a=!0,i>l.bottom?l.left-s:i<l.top?l.left+s:(a=!1,l.left)}var i=l-br(t),a=!1,s=2*e.display.wrapper.clientWidth,c=ie(e,t),u=yr(t),h=t.text.length,f=ln(t),g=on(t),d=o(f),p=a,v=o(g),m=a;if(n>v)return be(r,g,m,1);for(;;){if(u?g==f||g==hn(t,f,1):g-f<=1){for(var b=n<d||n-d<=v-n?f:g,y=n-(b==f?d:v);Kr(t.text.charAt(b));)++b;return be(r,b,b==f?p:m,y<-1?-1:y>1?1:0)}var w=Math.ceil(h/2),_=f+w;if(u){_=f;for(var x=0;x<w;++x)_=hn(t,_,1)}var k=o(_);k>n?(g=_,v=k,(m=a)&&(v+=1e3),h=w):(f=_,d=k,p=a,h-=w)}}(e,i,l,t,r),s=zt(i),c=s&&s.find(0,!0);if(!s||!(a.ch>c.from.ch||a.ch==c.from.ch&&a.xRel>0))return a;l=vr(i=c.to.line)}}function we(e){if(null!=e.cachedTextHeight)return e.cachedTextHeight;if(null==Hn){Hn=Xr("pre");for(var t=0;t<49;++t)Hn.appendChild(document.createTextNode("x")),Hn.appendChild(Xr("br"));Hn.appendChild(document.createTextNode("x"))}Zr(e.measure,Hn);var r=Hn.offsetHeight/50;return r>3&&(e.cachedTextHeight=r),Qr(e.measure),r||1}function _e(e){if(null!=e.cachedCharWidth)return e.cachedCharWidth;var t=Xr("span","xxxxxxxxxx"),r=Xr("pre",[t]);Zr(e.measure,r);var n=t.getBoundingClientRect(),l=(n.right-n.left)/10;return l>2&&(e.cachedCharWidth=l),l||10}function xe(e){e.curOp={viewChanged:!1,startHeight:e.doc.height,forceUpdate:!1,updateInput:null,typing:!1,changeObjs:null,cursorActivity:!1,selectionChanged:!1,updateMaxLine:!1,scrollLeft:null,scrollTop:null,scrollToPos:null,id:++Gn},Ol++||(Ml=[])}function ke(e){var t=e.curOp,r=e.doc,n=e.display;if(e.curOp=null,t.updateMaxLine&&u(e),t.viewChanged||t.forceUpdate||null!=t.scrollTop||t.scrollToPos&&(t.scrollToPos.from.line<n.viewFrom||t.scrollToPos.to.line>=n.viewTo)||n.maxLineChanged&&e.options.lineWrapping){var l=b(e,{top:t.scrollTop,ensure:t.scrollToPos},t.forceUpdate);e.display.scroller.offsetHeight&&(e.doc.scrollTop=e.display.scroller.scrollTop)}if(!l&&t.selectionChanged&&X(e),l||t.startHeight==e.doc.height||g(e),null!=t.scrollTop&&n.scroller.scrollTop!=t.scrollTop){var o=Math.max(0,Math.min(n.scroller.scrollHeight-n.scroller.clientHeight,t.scrollTop));n.scroller.scrollTop=n.scrollbarV.scrollTop=r.scrollTop=o}if(null!=t.scrollLeft&&n.scroller.scrollLeft!=t.scrollLeft){var i=Math.max(0,Math.min(n.scroller.scrollWidth-n.scroller.clientWidth,t.scrollLeft));n.scroller.scrollLeft=n.scrollbarH.scrollLeft=r.scrollLeft=i,p(e)}if(t.scrollToPos){var a=function(e,t,r,n){for(null==n&&(n=0);;){var l=!1,o=ve(e,t),i=r&&r!=t?ve(e,r):o,a=mt(e,Math.min(o.left,i.left),Math.min(o.top,i.top)-n,Math.max(o.left,i.left),Math.max(o.bottom,i.bottom)+n),s=e.doc.scrollTop,c=e.doc.scrollLeft;if(null!=a.scrollTop&&(Ke(e,a.scrollTop),Math.abs(e.doc.scrollTop-s)>1&&(l=!0)),null!=a.scrollLeft&&(Xe(e,a.scrollLeft),Math.abs(e.doc.scrollLeft-c)>1&&(l=!0)),!l)return o}}(e,P(e.doc,t.scrollToPos.from),P(e.doc,t.scrollToPos.to),t.scrollToPos.margin);t.scrollToPos.isCursor&&e.state.focused&&function(e,t){var r=e.display,n=r.sizer.getBoundingClientRect(),l=null;if(t.top+n.top<0?l=!0:t.bottom+n.top>(window.innerHeight||document.documentElement.clientHeight)&&(l=!1),null!=l&&!Ln){var o=Xr("div","",null,"position: absolute; top: "+(t.top-r.viewOffset-te(e.display))+"px; height: "+(t.bottom-t.top+Al)+"px; left: "+t.left+"px; width: 2px;");e.display.lineSpace.appendChild(o),o.scrollIntoView(l),e.display.lineSpace.removeChild(o)}}(e,a)}t.selectionChanged&&Q(e),e.state.focused&&t.updateInput&&je(e,t.typing);var s=t.maybeHiddenMarkers,c=t.maybeUnhiddenMarkers;if(s)for(f=0;f<s.length;++f)s[f].lines.length||Rl(s[f],"hide");if(c)for(f=0;f<c.length;++f)c[f].lines.length&&Rl(c[f],"unhide");var h;if(--Ol||(h=Ml,Ml=null),t.changeObjs){for(f=0;f<t.changeObjs.length;f++)Rl(e,"change",e,t.changeObjs[f]);Rl(e,"changes",e,t.changeObjs)}if(t.cursorActivity&&Rl(e,"cursorActivity",e),h)for(var f=0;f<h.length;++f)h[f]()}function Ce(e,t){if(e.curOp)return t();xe(e);try{return t()}finally{ke(e)}}function Me(e,t){return function(){if(e.curOp)return t.apply(e,arguments);xe(e);try{return t.apply(e,arguments)}finally{ke(e)}}}function Se(e){return function(){if(this.curOp)return e.apply(this,arguments);xe(this);try{return e.apply(this,arguments)}finally{ke(this)}}}function Ee(e){return function(){var t=this.cm;if(!t||t.curOp)return e.apply(this,arguments);xe(t);try{return e.apply(this,arguments)}finally{ke(t)}}}function Le(e,t,r){this.line=t,this.rest=function(e){for(var t,r;t=zt(e);)e=t.find(1,!0).line,(r||(r=[])).push(e);return r}(t),this.size=this.rest?vr(zr(this.rest))-r+1:1,this.node=this.text=null,this.hidden=Jt(e,t)}function Te(e,t,r){for(var n,l=[],o=t;o<r;o=n){var i=new Le(e.doc,fr(e.doc,o),o);n=o+i.size,l.push(i)}return l}function Ie(e,t,r,n){null==t&&(t=e.doc.first),null==r&&(r=e.doc.first+e.doc.size),n||(n=0);var l=e.display;if(n&&r<l.viewTo&&(null==l.updateLineNumbers||l.updateLineNumbers>t)&&(l.updateLineNumbers=t),e.curOp.viewChanged=!0,t>=l.viewTo)Bn&&Vt(e.doc,t)<l.viewTo&&Oe(e);else if(r<=l.viewFrom)Bn&&Ut(e.doc,r+n)>l.viewFrom?Oe(e):(l.viewFrom+=n,l.viewTo+=n);else if(t<=l.viewFrom&&r>=l.viewTo)Oe(e);else if(t<=l.viewFrom)(o=De(e,r,r+n,1))?(l.view=l.view.slice(o.index),l.viewFrom=o.lineN,l.viewTo+=n):Oe(e);else if(r>=l.viewTo){var o=De(e,t,t,-1);o?(l.view=l.view.slice(0,o.index),l.viewTo=o.lineN):Oe(e)}else{var i=De(e,t,t,-1),a=De(e,r,r+n,1);i&&a?(l.view=l.view.slice(0,i.index).concat(Te(e,i.lineN,a.lineN)).concat(l.view.slice(a.index)),l.viewTo+=n):Oe(e)}var s=l.externalMeasured;s&&(r<s.lineN?s.lineN+=n:t<s.lineN+s.size&&(l.externalMeasured=null))}function Re(e,t,r){e.curOp.viewChanged=!0;var n=e.display,l=e.display.externalMeasured;if(l&&t>=l.lineN&&t<l.lineN+l.size&&(n.externalMeasured=null),!(t<n.viewFrom||t>=n.viewTo)){var o=n.view[Ae(e,t)];if(null!=o.node){var i=o.changes||(o.changes=[]);-1==qr(i,r)&&i.push(r)}}}function Oe(e){e.display.viewFrom=e.display.viewTo=e.doc.first,e.display.view=[],e.display.viewOffset=0}function Ae(e,t){if(t>=e.display.viewTo)return null;if((t-=e.display.viewFrom)<0)return null;for(var r=e.display.view,n=0;n<r.length;n++)if((t-=r[n].size)<0)return n}function De(e,t,r,n){var l,o=Ae(e,t),i=e.display.view;if(!Bn)return{index:o,lineN:r};for(var a=0,s=e.display.viewFrom;a<o;a++)s+=i[a].size;if(s!=t){if(n>0){if(o==i.length-1)return null;l=s+i[o].size-t,o++}else l=s-t;t+=l,r+=l}for(;Vt(e.doc,r)!=r;){if(o==(n<0?0:i.length-1))return null;r+=n*i[o-(n<0?1:0)].size,o+=n}return{index:o,lineN:r}}function Ne(e){for(var t=e.display.view,r=0,n=0;n<t.length;n++){var l=t[n];l.hidden||l.node&&!l.changes||++r}return r}function Pe(e){e.display.pollingFast||e.display.poll.set(e.options.pollInterval,function(){Fe(e),e.state.focused&&Pe(e)})}function Be(e){function t(){Fe(e)||r?(e.display.pollingFast=!1,Pe(e)):(r=!0,e.display.poll.set(60,t))}var r=!1;e.display.pollingFast=!0,e.display.poll.set(20,t)}function Fe(e){var t=e.display.input,r=e.display.prevInput,n=e.doc;if(!e.state.focused||Xl(t)||ze(e)||e.options.disableInput)return!1;var l=t.value;if(l==r&&!e.somethingSelected())return!1;if(yn&&!vn&&e.display.inputHasSelection===l)return je(e),!1;var o=!e.curOp;o&&xe(e),e.display.shift=!1;for(var i=0,a=Math.min(r.length,l.length);i<a&&r.charCodeAt(i)==l.charCodeAt(i);)++i;for(var s=l.slice(i),c=Kl(s),u=e.state.pasteIncoming&&c.length>1&&n.sel.ranges.length==c.length,h=n.sel.ranges.length-1;h>=0;h--){var f=n.sel.ranges[h],g=f.from(),d=f.to();i<r.length?g=Fn(g.line,g.ch-(r.length-i)):e.state.overwrite&&f.empty()&&!e.state.pasteIncoming&&(d=Fn(d.line,Math.min(fr(n,d.line).text.length,d.ch+zr(c).length)));var p=e.curOp.updateInput,v={from:g,to:d,text:u?[c[h]]:c,origin:e.state.pasteIncoming?"paste":e.state.cutIncoming?"cut":"+input"};if(ht(e.doc,v),Dr(e,"inputRead",e,v),s&&!e.state.pasteIncoming&&e.options.electricChars&&e.options.smartIndent&&f.head.ch<100&&(!h||n.sel.ranges[h-1].head.line!=f.head.line)){var m=e.getModeAt(f.head).electricChars;if(m)for(var b=0;b<m.length;b++)if(s.indexOf(m.charAt(b))>-1){_t(e,f.head.line,"smart");break}}}return yt(e),e.curOp.updateInput=p,e.curOp.typing=!0,l.length>1e3||l.indexOf("\n")>-1?t.value=e.display.prevInput="":e.display.prevInput=l,o&&ke(e),e.state.pasteIncoming=e.state.cutIncoming=!1,!0}function je(e,t){var r,n,l=e.doc;if(e.somethingSelected()){e.display.prevInput="";var o=l.sel.primary(),i=(r=Ql&&(o.to().line-o.from().line>100||(n=e.getSelection()).length>1e3))?"-":n||e.getSelection();e.display.input.value=i,e.state.focused&&Hl(e.display.input),yn&&!vn&&(e.display.inputHasSelection=i)}else t||(e.display.prevInput=e.display.input.value="",yn&&!vn&&(e.display.inputHasSelection=null));e.display.inaccurateSelection=r}function He(e){"nocursor"==e.options.readOnly||In&&en()==e.display.input||e.display.input.focus()}function We(e){e.state.focused||(He(e),lt(e))}function ze(e){return e.options.readOnly||e.doc.cantEdit}function qe(e,t){for(var r=Or(t);r!=e.wrapper;r=r.parentNode)if(!r||r.ignoreEvents||r.parentNode==e.sizer&&r!=e.mover)return!0}function Ge(e,t,r,n){var l=e.display;if(!r){var o=Or(t);if(o==l.scrollbarH||o==l.scrollbarV||o==l.scrollbarFiller||o==l.gutterFiller)return null}var i,a,s=l.lineSpace.getBoundingClientRect();try{i=t.clientX-s.left,a=t.clientY-s.top}catch(t){return null}var c,u=ye(e,i,a);if(n&&1==u.xRel&&(c=fr(e.doc,u.line).text).length==u.ch){var h=Fl(c,c.length,e.options.tabSize)-c.length;u=Fn(u.line,Math.round((i-ne(e.display).left)/_e(e.display))-h)}return u}function Ve(e){if(!Pr(this,e)){var t=this,r=t.display;if(r.shift=e.shiftKey,qe(r,e))wn||(r.scroller.draggable=!1,setTimeout(function(){r.scroller.draggable=!0},100));else if(!Je(t,e)){var n=Ge(t,e);switch(window.focus(),Ar(e)){case 1:n?function(e,t,r){setTimeout(Jr(We,e),0);var n,l=+new Date;zn&&zn.time>l-400&&0==jn(zn.pos,r)?n="triple":Wn&&Wn.time>l-400&&0==jn(Wn.pos,r)?(n="double",zn={time:l,pos:r}):(n="single",Wn={time:l,pos:r});var o=e.doc.sel;e.options.dragDrop&&Yl&&!ze(e)&&"single"==n&&o.contains(r)>-1&&o.somethingSelected()?function(e,t,r){var n=e.display,l=Me(e,function(o){wn&&(n.scroller.draggable=!1),e.state.draggingText=!1,Il(document,"mouseup",l),Il(n.scroller,"drop",l),Math.abs(t.clientX-o.clientX)+Math.abs(t.clientY-o.clientY)<10&&(Sl(o),j(e.doc,r),He(e),dn&&!vn&&setTimeout(function(){document.body.focus(),He(e)},20))});wn&&(n.scroller.draggable=!0),e.state.draggingText=l,n.scroller.dragDrop&&n.scroller.dragDrop(),Tl(document,"mouseup",l),Tl(n.scroller,"drop",l)}(e,t,r):function(e,t,r,n,l){function o(t){if(0!=jn(v,t))if(v=t,"rect"==n){for(var l=[],o=e.options.tabSize,i=Fl(fr(c,r.line).text,r.ch,o),a=Fl(fr(c,t.line).text,t.ch,o),s=Math.min(i,a),g=Math.max(i,a),d=Math.min(r.line,t.line),p=Math.min(e.lastLine(),Math.max(r.line,t.line));d<=p;d++){var m=fr(c,d).text,b=Hr(m,s,o);s==g?l.push(new O(Fn(d,b),Fn(d,b))):m.length>b&&l.push(new O(Fn(d,b),Fn(d,Hr(m,g,o))))}l.length||l.push(new O(r,r)),G(c,A(f.ranges.slice(0,h).concat(l),h),Pl)}else{var y=u,w=y.anchor,_=t;if("single"!=n){if("double"==n)x=St(c,t);else var x=new O(Fn(t.line,0),P(c,Fn(t.line+1,0)));jn(x.anchor,w)>0?(_=x.head,w=I(y.from(),x.anchor)):(_=x.anchor,w=T(y.to(),x.head))}(l=f.ranges.slice(0))[h]=new O(P(c,w),_),G(c,A(l,h),Pl)}}function i(t){var r=++b,l=Ge(e,t,!0,"rect"==n);if(l)if(0!=jn(l,v)){We(e),o(l);var a=d(s,c);(l.line>=a.to||l.line<a.from)&&setTimeout(Me(e,function(){b==r&&i(t)}),150)}else{var u=t.clientY<m.top?-20:t.clientY>m.bottom?20:0;u&&setTimeout(Me(e,function(){b==r&&(s.scroller.scrollTop+=u,i(t))}),50)}}function a(t){b=1/0,Sl(t),He(e),Il(document,"mousemove",y),Il(document,"mouseup",w),c.history.lastSelOrigin=null}var s=e.display,c=e.doc;Sl(t);var u,h,f=c.sel;if(l?(h=c.sel.contains(r),u=h>-1?c.sel.ranges[h]:new O(r,r)):u=c.sel.primary(),t.altKey)n="rect",l||(u=new O(r,r)),r=Ge(e,t,!0,!0),h=-1;else if("double"==n){var g=St(c,r);u=e.display.shift||c.extend?F(c,u,g.anchor,g.head):g}else if("triple"==n){var p=new O(Fn(r.line,0),P(c,Fn(r.line+1,0)));u=e.display.shift||c.extend?F(c,u,p.anchor,p.head):p}else u=F(c,u,r);l?h>-1?W(c,h,u,Pl):(h=c.sel.ranges.length,G(c,A(c.sel.ranges.concat([u]),h),{scroll:!1,origin:"*mouse"})):(h=0,G(c,new R([u],0),Pl));var v=r,m=s.wrapper.getBoundingClientRect(),b=0,y=Me(e,function(e){(yn&&!mn?e.buttons:Ar(e))?i(e):a(e)}),w=Me(e,a);Tl(document,"mousemove",y),Tl(document,"mouseup",w)}(e,t,r,n,!1)}(t,e,n):Or(e)==r.scroller&&Sl(e);break;case 2:wn&&(t.state.lastMiddleDown=+new Date),n&&j(t.doc,n),setTimeout(Jr(He,t),20),Sl(e);break;case 3:Nn&&it(t,e)}}}}function Ue(e,t,r,n,l){try{var o=t.clientX,i=t.clientY}catch(t){return!1}if(o>=Math.floor(e.display.gutters.getBoundingClientRect().right))return!1;n&&Sl(t);var a=e.display,s=a.lineDiv.getBoundingClientRect();if(i>s.bottom||!Br(e,r))return Rr(t);i-=s.top-a.viewOffset;for(var c=0;c<e.options.gutters.length;++c){var u=a.gutters.childNodes[c];if(u&&u.getBoundingClientRect().right>=o)return l(e,r,e,mr(e.doc,i),e.options.gutters[c],t),Rr(t)}}function Je(e,t){return Ue(e,t,"gutterClick",!0,Dr)}function Ye(e){var t=this;if(!Pr(t,e)&&!qe(t.display,e)){Sl(e),dn&&(Vn=+new Date);var r=Ge(t,e,!0),n=e.dataTransfer.files;if(r&&!ze(t))if(n&&n.length&&window.FileReader&&window.File)for(var l=n.length,o=Array(l),i=0,a=function(e,n){var a=new FileReader;a.onload=function(){if(o[n]=a.result,++i==l){var e={from:r=P(t.doc,r),to:r,text:Kl(o.join("\n")),origin:"paste"};ht(t.doc,e),q(t.doc,D(r,Qn(e)))}},a.readAsText(e)},s=0;s<l;++s)a(n[s],s);else{if(t.state.draggingText&&t.doc.sel.contains(r)>-1)return t.state.draggingText(e),void setTimeout(Jr(He,t),20);try{if(o=e.dataTransfer.getData("Text")){var c=t.state.draggingText&&t.listSelections();if(V(t.doc,D(r,r)),c)for(s=0;s<c.length;++s)vt(t.doc,"",c[s].anchor,c[s].head,"drag");t.replaceSelection(o,"around","paste"),He(t)}}catch(e){}}}}function Ke(e,t){Math.abs(e.doc.scrollTop-t)<2||(e.doc.scrollTop=t,gn||b(e,{top:t}),e.display.scroller.scrollTop!=t&&(e.display.scroller.scrollTop=t),e.display.scrollbarV.scrollTop!=t&&(e.display.scrollbarV.scrollTop=t),gn&&b(e),Z(e,100))}function Xe(e,t,r){(r?t==e.doc.scrollLeft:Math.abs(e.doc.scrollLeft-t)<2)||(t=Math.min(t,e.display.scroller.scrollWidth-e.display.scroller.clientWidth),e.doc.scrollLeft=t,p(e),e.display.scroller.scrollLeft!=t&&(e.display.scroller.scrollLeft=t),e.display.scrollbarH.scrollLeft!=t&&(e.display.scrollbarH.scrollLeft=t))}function Qe(e,t){var r=t.wheelDeltaX,n=t.wheelDeltaY;null==r&&t.detail&&t.axis==t.HORIZONTAL_AXIS&&(r=t.detail),null==n&&t.detail&&t.axis==t.VERTICAL_AXIS?n=t.detail:null==n&&(n=t.wheelDelta);var l=e.display,o=l.scroller;if(r&&o.scrollWidth>o.clientWidth||n&&o.scrollHeight>o.clientHeight){if(n&&Rn&&wn)e:for(var i=t.target,a=l.view;i!=o;i=i.parentNode)for(var s=0;s<a.length;s++)if(a[s].node==i){e.display.currentWheelTarget=i;break e}if(r&&!gn&&!kn&&null!=Jn)return n&&Ke(e,Math.max(0,Math.min(o.scrollTop+n*Jn,o.scrollHeight-o.clientHeight))),Xe(e,Math.max(0,Math.min(o.scrollLeft+r*Jn,o.scrollWidth-o.clientWidth))),Sl(t),void(l.wheelStartX=null);if(n&&null!=Jn){var c=n*Jn,u=e.doc.scrollTop,h=u+l.wrapper.clientHeight;c<0?u=Math.max(0,u+c-50):h=Math.min(e.doc.height,h+c+50),b(e,{top:u,bottom:h})}Un<20&&(null==l.wheelStartX?(l.wheelStartX=o.scrollLeft,l.wheelStartY=o.scrollTop,l.wheelDX=r,l.wheelDY=n,setTimeout(function(){if(null!=l.wheelStartX){var e=o.scrollLeft-l.wheelStartX,t=o.scrollTop-l.wheelStartY,r=t&&l.wheelDY&&t/l.wheelDY||e&&l.wheelDX&&e/l.wheelDX;l.wheelStartX=l.wheelStartY=null,r&&(Jn=(Jn*Un+r)/(Un+1),++Un)}},200)):(l.wheelDX+=r,l.wheelDY+=n))}}function Ze(e,t,r){if("string"==typeof t&&!(t=sl[t]))return!1;e.display.pollingFast&&Fe(e)&&(e.display.pollingFast=!1);var n=e.display.shift,l=!1;try{ze(e)&&(e.state.suppressEdits=!0),r&&(e.display.shift=!1),l=t(e)!=Dl}finally{e.display.shift=n,e.state.suppressEdits=!1}return l}function $e(e){var t=e.state.keyMaps.slice(0);return e.options.extraKeys&&t.push(e.options.extraKeys),t.push(e.options.keyMap),t}function et(e,t){var r=Lt(e.options.keyMap),n=r.auto;clearTimeout(Yn),n&&!hl(t)&&(Yn=setTimeout(function(){Lt(e.options.keyMap)==r&&(e.options.keyMap=n.call?n.call(null,e):n,o(e))},50));var l=fl(t,!0),i=!1;if(!l)return!1;var a=$e(e);return(i=t.shiftKey?ul("Shift-"+l,a,function(t){return Ze(e,t,!0)})||ul(l,a,function(t){if("string"==typeof t?/^go[A-Z]/.test(t):t.motion)return Ze(e,t)}):ul(l,a,function(t){return Ze(e,t)}))&&(Sl(t),Q(e),Dr(e,"keyHandled",e,l,t)),i}function tt(e){var t=this;if(We(t),!Pr(t,e)){dn&&27==e.keyCode&&(e.returnValue=!1);var r=e.keyCode;t.display.shift=16==r||e.shiftKey;var n=et(t,e);kn&&(Xn=n?r:null,!n&&88==r&&!Ql&&(Rn?e.metaKey:e.ctrlKey)&&t.replaceSelection("",null,"cut"))}}function rt(e){Pr(this,e)||16==e.keyCode&&(this.doc.sel.shift=!1)}function nt(e){var t=this;if(!Pr(t,e)){var r=e.keyCode,n=e.charCode;if(kn&&r==Xn)return Xn=null,void Sl(e);(kn&&(!e.which||e.which<10)||Mn)&&et(t,e)||function(e,t,r){var n=ul("'"+r+"'",$e(e),function(t){return Ze(e,t,!0)});return n&&(Sl(t),Q(e),Dr(e,"keyHandled",e,"'"+r+"'",t)),n}(t,e,String.fromCharCode(null==n?r:n))||(yn&&!vn&&(t.display.inputHasSelection=null),Be(t))}}function lt(e){"nocursor"!=e.options.readOnly&&(e.state.focused||(Rl(e,"focus",e),e.state.focused=!0,-1==e.display.wrapper.className.search(/\bCodeMirror-focused\b/)&&(e.display.wrapper.className+=" CodeMirror-focused"),e.curOp||(je(e),wn&&setTimeout(Jr(je,e,!0),0))),Pe(e),Q(e))}function ot(e){e.state.focused&&(Rl(e,"blur",e),e.state.focused=!1,e.display.wrapper.className=e.display.wrapper.className.replace(" CodeMirror-focused","")),clearInterval(e.display.blinker),setTimeout(function(){e.state.focused||(e.display.shift=!1)},150)}function it(e,t){function r(){if(null!=l.input.selectionStart){var t=l.input.value=""+(e.somethingSelected()?l.input.value:"");l.prevInput="",l.input.selectionStart=1,l.input.selectionEnd=t.length}}function n(){if(l.inputDiv.style.position="relative",l.input.style.cssText=a,vn&&(l.scrollbarV.scrollTop=l.scroller.scrollTop=i),Pe(e),null!=l.input.selectionStart){yn&&!vn||r(),clearTimeout(Kn);var t=0,n=function r(){""==l.prevInput&&0==l.input.selectionStart?Me(e,sl.selectAll)(e):t++<10?Kn=setTimeout(r,500):je(e)};Kn=setTimeout(n,200)}}if(!Pr(e,t,"contextmenu")){var l=e.display;if(!qe(l,t)&&!function(e,t){return!!Br(e,"gutterContextMenu")&&Ue(e,t,"gutterContextMenu",!1,Rl)}(e,t)){var o=Ge(e,t),i=l.scroller.scrollTop;if(o&&!kn){e.options.resetSelectionOnContextMenu&&-1==e.doc.sel.contains(o)&&Me(e,G)(e.doc,D(o),Nl);var a=l.input.style.cssText;if(l.inputDiv.style.position="absolute",l.input.style.cssText="position: fixed; width: 30px; height: 30px; top: "+(t.clientY-5)+"px; left: "+(t.clientX-5)+"px; z-index: 1000; background: "+(yn?"rgba(255, 255, 255, .05)":"transparent")+"; outline: none; border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);",He(e),je(e),e.somethingSelected()||(l.input.value=l.prevInput=" "),yn&&!vn&&r(),Nn){Ll(t);var s=function e(){Il(window,"mouseup",e),setTimeout(n,20)};Tl(window,"mouseup",s)}else setTimeout(n,50)}}}}function at(e,t){if(jn(e,t.from)<0)return e;if(jn(e,t.to)<=0)return Qn(t);var r=e.line+t.text.length-(t.to.line-t.from.line)-1,n=e.ch;return e.line==t.to.line&&(n+=Qn(t).ch-t.to.ch),Fn(r,n)}function st(e,t){for(var r=[],n=0;n<e.sel.ranges.length;n++){var l=e.sel.ranges[n];r.push(new O(at(l.anchor,t),at(l.head,t)))}return A(r,e.sel.primIndex)}function ct(e,t,r){return e.line==t.line?Fn(r.line,e.ch-t.ch+r.ch):Fn(r.line+(e.line-t.line),e.ch)}function ut(e,t,r){var n={canceled:!1,from:t.from,to:t.to,text:t.text,origin:t.origin,cancel:function(){this.canceled=!0}};return r&&(n.update=function(t,r,n,l){t&&(this.from=P(e,t)),r&&(this.to=P(e,r)),n&&(this.text=n),void 0!==l&&(this.origin=l)}),Rl(e,"beforeChange",e,n),e.cm&&Rl(e.cm,"beforeChange",e.cm,n),n.canceled?null:{from:n.from,to:n.to,text:n.text,origin:n.origin}}function ht(e,t,r){if(e.cm){if(!e.cm.curOp)return Me(e.cm,ht)(e,t,r);if(e.cm.state.suppressEdits)return}if(!(Br(e,"beforeChange")||e.cm&&Br(e.cm,"beforeChange"))||(t=ut(e,t,!0))){var n=Pn&&!r&&function(e,t,r){var n=null;if(e.iter(t.line,r.line+1,function(e){if(e.markedSpans)for(var t=0;t<e.markedSpans.length;++t){var r=e.markedSpans[t].marker;!r.readOnly||n&&-1!=qr(n,r)||(n||(n=[])).push(r)}}),!n)return null;for(var l=[{from:t,to:r}],o=0;o<n.length;++o)for(var i=n[o],a=i.find(0),s=0;s<l.length;++s){var c=l[s];if(!(jn(c.to,a.from)<0||jn(c.from,a.to)>0)){var u=[s,1],h=jn(c.from,a.from),f=jn(c.to,a.to);(h<0||!i.inclusiveLeft&&!h)&&u.push({from:c.from,to:a.from}),(f>0||!i.inclusiveRight&&!f)&&u.push({from:a.to,to:c.to}),l.splice.apply(l,u),s+=u.length-1}}return l}(e,t.from,t.to);if(n)for(var l=n.length-1;l>=0;--l)ft(e,{from:n[l].from,to:n[l].to,text:l?[""]:t.text});else ft(e,t)}}function ft(e,t){if(1!=t.text.length||""!=t.text[0]||0!=jn(t.from,t.to)){var r=st(e,t);kr(e,t,r,e.cm?e.cm.curOp.id:NaN),pt(e,t,r,Ot(e,t));var n=[];ur(e,function(e,r){r||-1!=qr(n,e.history)||(Ir(e.history,t),n.push(e.history)),pt(e,t,null,Ot(e,t))})}}function gt(e,t,r){if(!e.cm||!e.cm.state.suppressEdits){for(var n,l=e.history,o=e.sel,i="undo"==t?l.done:l.undone,a="undo"==t?l.undone:l.done,s=0;s<i.length&&(n=i[s],r?!n.ranges||n.equals(e.sel):n.ranges);s++);if(s!=i.length){for(l.lastOrigin=l.lastSelOrigin=null;(n=i.pop()).ranges;){if(Cr(n,a),r&&!n.equals(e.sel))return void G(e,n,{clearRedo:!1});o=n}var c=[];Cr(o,a),a.push({changes:c,generation:l.generation}),l.generation=n.generation||++l.maxGeneration;for(var u=Br(e,"beforeChange")||e.cm&&Br(e.cm,"beforeChange"),s=n.changes.length-1;s>=0;--s){var h=n.changes[s];if(h.origin=t,u&&!ut(e,h,!1))return void(i.length=0);c.push(_r(e,h));var f=s?st(e,h):zr(i);pt(e,h,f,Dt(e,h)),e.cm&&yt(e.cm);var g=[];ur(e,function(e,t){t||-1!=qr(g,e.history)||(Ir(e.history,h),g.push(e.history)),pt(e,h,null,Dt(e,h))})}}}}function dt(e,t){e.first+=t,e.sel=new R(Gr(e.sel.ranges,function(e){return new O(Fn(e.anchor.line+t,e.anchor.ch),Fn(e.head.line+t,e.head.ch))}),e.sel.primIndex),e.cm&&Ie(e.cm,e.first,e.first-t,t)}function pt(e,t,r,l){if(e.cm&&!e.cm.curOp)return Me(e.cm,pt)(e,t,r,l);if(t.to.line<e.first)dt(e,t.text.length-1-(t.to.line-t.from.line));else if(!(t.from.line>e.lastLine())){if(t.from.line<e.first){var o=t.text.length-1-(e.first-t.from.line);dt(e,o),t={from:Fn(e.first,0),to:Fn(t.to.line+o,t.to.ch),text:[zr(t.text)],origin:t.origin}}var i=e.lastLine();t.to.line>i&&(t={from:t.from,to:Fn(i,fr(e,i).text.length),text:[t.text[0]],origin:t.origin}),t.removed=gr(e,t.from,t.to),r||(r=st(e,t)),e.cm?function(e,t,r){var l=e.doc,o=e.display,i=t.from,a=t.to,s=!1,u=i.line;e.options.lineWrapping||(u=vr(Gt(fr(l,i.line))),l.iter(u,a.line+1,function(e){if(e==o.maxLine)return s=!0,!0})),l.sel.contains(t.from,t.to)>-1&&(e.curOp.cursorActivity=!0),ar(l,t,r,n(e)),e.options.lineWrapping||(l.iter(u,i.line+t.text.length,function(e){var t=c(e);t>o.maxLineLength&&(o.maxLine=e,o.maxLineLength=t,o.maxLineChanged=!0,s=!1)}),s&&(e.curOp.updateMaxLine=!0)),l.frontier=Math.min(l.frontier,i.line),Z(e,400);var h=t.text.length-(a.line-i.line)-1;i.line!=a.line||1!=t.text.length||ir(e.doc,t)?Ie(e,i.line,a.line+1,h):Re(e,i.line,"text"),(Br(e,"change")||Br(e,"changes"))&&(e.curOp.changeObjs||(e.curOp.changeObjs=[])).push({from:i,to:a,text:t.text,removed:t.removed,origin:t.origin})}(e.cm,t,l):ar(e,t,l),V(e,r,Nl)}}function vt(e,t,r,n,l){if(n||(n=r),jn(n,r)<0){var o=n;n=r,r=o}"string"==typeof t&&(t=Kl(t)),ht(e,{from:r,to:n,text:t,origin:l})}function mt(e,t,r,n,l){var o=e.display,i=we(e.display);r<0&&(r=0);var a=e.curOp&&null!=e.curOp.scrollTop?e.curOp.scrollTop:o.scroller.scrollTop,s=o.scroller.clientHeight-Al,c={},u=e.doc.height+re(o),h=r<i,f=l>u-i;if(r<a)c.scrollTop=h?0:r;else if(l>a+s){var g=Math.min(r,(f?u:l)-s);g!=a&&(c.scrollTop=g)}var d=e.curOp&&null!=e.curOp.scrollLeft?e.curOp.scrollLeft:o.scroller.scrollLeft,p=o.scroller.clientWidth-Al;t+=o.gutters.offsetWidth,n+=o.gutters.offsetWidth;var v=o.gutters.offsetWidth,m=t<v+10;return t<d+v||m?(m&&(t=0),c.scrollLeft=Math.max(0,t-10-v)):n>p+d-3&&(c.scrollLeft=n+10-p),c}function bt(e,t,r){null==t&&null==r||wt(e),null!=t&&(e.curOp.scrollLeft=(null==e.curOp.scrollLeft?e.doc.scrollLeft:e.curOp.scrollLeft)+t),null!=r&&(e.curOp.scrollTop=(null==e.curOp.scrollTop?e.doc.scrollTop:e.curOp.scrollTop)+r)}function yt(e){wt(e);var t=e.getCursor(),r=t,n=t;e.options.lineWrapping||(r=t.ch?Fn(t.line,t.ch-1):t,n=Fn(t.line,t.ch+1)),e.curOp.scrollToPos={from:r,to:n,margin:e.options.cursorScrollMargin,isCursor:!0}}function wt(e){var t=e.curOp.scrollToPos;if(t){e.curOp.scrollToPos=null;var r=me(e,t.from),n=me(e,t.to),l=mt(e,Math.min(r.left,n.left),Math.min(r.top,n.top)-t.margin,Math.max(r.right,n.right),Math.max(r.bottom,n.bottom)+t.margin);e.scrollTo(l.scrollLeft,l.scrollTop)}}function _t(e,t,r,n){var l,o=e.doc;null==r&&(r="add"),"smart"==r&&(e.doc.mode.indent?l=ee(e,t):r="prev");var i=e.options.tabSize,a=fr(o,t),s=Fl(a.text,null,i);a.stateAfter&&(a.stateAfter=null);var c,u=a.text.match(/^\s*/)[0];if(n||/\S/.test(a.text)){if("smart"==r&&(c=e.doc.mode.indent(l,a.text.slice(u.length),a.text))==Dl){if(!n)return;r="prev"}}else c=0,r="not";"prev"==r?c=t>o.first?Fl(fr(o,t-1).text,null,i):0:"add"==r?c=s+e.options.indentUnit:"subtract"==r?c=s-e.options.indentUnit:"number"==typeof r&&(c=s+r),c=Math.max(0,c);var h="",f=0;if(e.options.indentWithTabs)for(g=Math.floor(c/i);g;--g)f+=i,h+="\t";if(f<c&&(h+=Wr(c-f)),h!=u)vt(e.doc,h,Fn(t,0),Fn(t,u.length),"+input");else for(var g=0;g<o.sel.ranges.length;g++){var d=o.sel.ranges[g];if(d.head.line==t&&d.head.ch<u.length){W(o,g,new O(f=Fn(t,u.length),f));break}}a.stateAfter=null}function xt(e,t,r,n){var l=t,o=t,i=e.doc;return"number"==typeof t?o=fr(i,N(i,t)):l=vr(t),null==l?null:n(o,l)?(Re(e,l,r),o):null}function kt(e,t){for(var r=e.doc.sel.ranges,n=[],l=0;l<r.length;l++){for(var o=t(r[l]);n.length&&jn(o.from,zr(n).to)<=0;){var i=n.pop();if(jn(i.from,o.from)<0){o.from=i.from;break}}n.push(o)}Ce(e,function(){for(var t=n.length-1;t>=0;t--)vt(e.doc,"",n[t].from,n[t].to,"+delete");yt(e)})}function Ct(e,t,r,n,l){function o(t){var n=(l?hn:fn)(c,a,r,!0);if(null==n){if(t||!function(){var t=i+r;return t<e.first||t>=e.first+e.size?u=!1:(i=t,c=fr(e,t))}())return u=!1;a=l?(r<0?on:ln)(c):r<0?c.text.length:0}else a=n;return!0}var i=t.line,a=t.ch,s=r,c=fr(e,i),u=!0;if("char"==n)o();else if("column"==n)o(!0);else if("word"==n||"group"==n)for(var h=null,f="group"==n,g=!0;!(r<0)||o(!g);g=!1){var d=c.text.charAt(a)||"\n",p=ql(d)?"w":f&&"\n"==d?"n":!f||/\s/.test(d)?null:"p";if(!f||g||p||(p="s"),h&&h!=p){r<0&&(r=1,o());break}if(p&&(h=p),r>0&&!o(!g))break}var v=K(e,Fn(i,a),s,!0);return u||(v.hitSide=!0),v}function Mt(e,t,r,n){var l,o=e.doc,i=t.left;if("page"==n){var a=Math.min(e.display.wrapper.clientHeight,window.innerHeight||document.documentElement.clientHeight);l=t.top+r*(a-(r<0?1.5:.5)*we(e.display))}else"line"==n&&(l=r>0?t.bottom+3:t.top-3);for(;;){var s=ye(e,i,l);if(!s.outside)break;if(r<0?l<=0:l>=o.height){s.hitSide=!0;break}l+=5*r}return s}function St(e,t){var r=fr(e,t.line).text,n=t.ch,l=t.ch;if(r){(t.xRel<0||l==r.length)&&n?--n:++l;for(var o=r.charAt(n),i=ql(o)?ql:/\s/.test(o)?function(e){return/\s/.test(e)}:function(e){return!/\s/.test(e)&&!ql(e)};n>0&&i(r.charAt(n-1));)--n;for(;l<r.length&&i(r.charAt(l));)++l}return new O(Fn(t.line,n),Fn(t.line,l))}function Et(t,r,n,l){e.defaults[t]=r,n&&($n[t]=l?function(e,t,r){r!=el&&n(e,t,r)}:n)}function Lt(e){return"string"==typeof e?cl[e]:e}function Tt(e,t,r,n,l){if(n&&n.shared)return function(e,t,r,n,l){(n=Ur(n)).shared=!1;var o=[Tt(e,t,r,n,l)],i=o[0],a=n.widgetNode;return ur(e,function(e){a&&(n.widgetNode=a.cloneNode(!0)),o.push(Tt(e,P(e,t),P(e,r),n,l));for(var s=0;s<e.linked.length;++s)if(e.linked[s].isParent)return;i=zr(o)}),new vl(o,i)}(e,t,r,n,l);if(e.cm&&!e.cm.curOp)return Me(e.cm,Tt)(e,t,r,n,l);var o=new dl(e,l),i=jn(t,r);if(n&&Ur(n,o),i>0||0==i&&!1!==o.clearWhenEmpty)return o;if(o.replacedWith&&(o.collapsed=!0,o.widgetNode=Xr("span",[o.replacedWith],"CodeMirror-widget"),n.handleMouseEvents||(o.widgetNode.ignoreEvents=!0),n.insertLeft&&(o.widgetNode.insertLeft=!0)),o.collapsed){if(qt(e,t.line,t,r,o)||t.line!=r.line&&qt(e,r.line,t,r,o))throw new Error("Inserting collapsed marker partially overlapping an existing one");Bn=!0}o.addToHistory&&kr(e,{from:t,to:r,origin:"markText"},e.sel,NaN);var a,s=t.line,c=e.cm;if(e.iter(s,r.line+1,function(e){c&&o.collapsed&&!c.options.lineWrapping&&Gt(e)==c.display.maxLine&&(a=!0),o.collapsed&&s!=t.line&&pr(e,0),function(e,t){e.markedSpans=e.markedSpans?e.markedSpans.concat([t]):[t],t.marker.attachLine(e)}(e,new It(o,s==t.line?t.ch:null,s==r.line?r.ch:null)),++s}),o.collapsed&&e.iter(t.line,r.line+1,function(t){Jt(e,t)&&pr(t,0)}),o.clearOnEnter&&Tl(o,"beforeCursorEnter",function(){o.clear()}),o.readOnly&&(Pn=!0,(e.history.done.length||e.history.undone.length)&&e.clearHistory()),o.collapsed&&(o.id=++pl,o.atomic=!0),c){if(a&&(c.curOp.updateMaxLine=!0),o.collapsed)Ie(c,t.line,r.line+1);else if(o.className||o.title||o.startStyle||o.endStyle)for(var u=t.line;u<=r.line;u++)Re(c,u,"text");o.atomic&&J(c.doc),Dr(c,"markerAdded",c,o)}return o}function It(e,t,r){this.marker=e,this.from=t,this.to=r}function Rt(e,t){if(e)for(var r=0;r<e.length;++r){var n=e[r];if(n.marker==t)return n}}function Ot(e,t){var r=B(e,t.from.line)&&fr(e,t.from.line).markedSpans,n=B(e,t.to.line)&&fr(e,t.to.line).markedSpans;if(!r&&!n)return null;var l=t.from.ch,o=t.to.ch,i=0==jn(t.from,t.to),a=function(e,t,r){if(e)for(var n,l=0;l<e.length;++l){var o=e[l],i=o.marker;if(null==o.from||(i.inclusiveLeft?o.from<=t:o.from<t)||o.from==t&&"bookmark"==i.type&&(!r||!o.marker.insertLeft)){var a=null==o.to||(i.inclusiveRight?o.to>=t:o.to>t);(n||(n=[])).push(new It(i,o.from,a?null:o.to))}}return n}(r,l,i),s=function(e,t,r){if(e)for(var n,l=0;l<e.length;++l){var o=e[l],i=o.marker;if(null==o.to||(i.inclusiveRight?o.to>=t:o.to>t)||o.from==t&&"bookmark"==i.type&&(!r||o.marker.insertLeft)){var a=null==o.from||(i.inclusiveLeft?o.from<=t:o.from<t);(n||(n=[])).push(new It(i,a?null:o.from-t,null==o.to?null:o.to-t))}}return n}(n,o,i),c=1==t.text.length,u=zr(t.text).length+(c?l:0);if(a)for(v=0;v<a.length;++v)null==(h=a[v]).to&&((f=Rt(s,h.marker))?c&&(h.to=null==f.to?null:f.to+u):h.to=l);if(s)for(v=0;v<s.length;++v){var h=s[v];if(null!=h.to&&(h.to+=u),null==h.from){var f=Rt(a,h.marker);f||(h.from=u,c&&(a||(a=[])).push(h))}else h.from+=u,c&&(a||(a=[])).push(h)}a&&(a=At(a)),s&&s!=a&&(s=At(s));var g=[a];if(!c){var d,p=t.text.length-2;if(p>0&&a)for(v=0;v<a.length;++v)null==a[v].to&&(d||(d=[])).push(new It(a[v].marker,null,null));for(var v=0;v<p;++v)g.push(d);g.push(s)}return g}function At(e){for(var t=0;t<e.length;++t){var r=e[t];null!=r.from&&r.from==r.to&&!1!==r.marker.clearWhenEmpty&&e.splice(t--,1)}return e.length?e:null}function Dt(e,t){var r=function(e,t){var r=t["spans_"+e.id];if(!r)return null;for(var n=0,l=[];n<t.text.length;++n)l.push(Sr(r[n]));return l}(e,t),n=Ot(e,t);if(!r)return n;if(!n)return r;for(var l=0;l<r.length;++l){var o=r[l],i=n[l];if(o&&i)e:for(var a=0;a<i.length;++a){for(var s=i[a],c=0;c<o.length;++c)if(o[c].marker==s.marker)continue e;o.push(s)}else i&&(r[l]=i)}return r}function Nt(e){var t=e.markedSpans;if(t){for(var r=0;r<t.length;++r)t[r].marker.detachLine(e);e.markedSpans=null}}function Pt(e,t){if(t){for(var r=0;r<t.length;++r)t[r].marker.attachLine(e);e.markedSpans=t}}function Bt(e){return e.inclusiveLeft?-1:0}function Ft(e){return e.inclusiveRight?1:0}function jt(e,t){var r=e.lines.length-t.lines.length;if(0!=r)return r;var n=e.find(),l=t.find(),o=jn(n.from,l.from)||Bt(e)-Bt(t);if(o)return-o;var i=jn(n.to,l.to)||Ft(e)-Ft(t);return i||t.id-e.id}function Ht(e,t){var r,n=Bn&&e.markedSpans;if(n)for(var l,o=0;o<n.length;++o)(l=n[o]).marker.collapsed&&null==(t?l.from:l.to)&&(!r||jt(r,l.marker)<0)&&(r=l.marker);return r}function Wt(e){return Ht(e,!0)}function zt(e){return Ht(e,!1)}function qt(e,t,r,n,l){var o=fr(e,t),i=Bn&&o.markedSpans;if(i)for(var a=0;a<i.length;++a){var s=i[a];if(s.marker.collapsed){var c=s.marker.find(0),u=jn(c.from,r)||Bt(s.marker)-Bt(l),h=jn(c.to,n)||Ft(s.marker)-Ft(l);if(!(u>=0&&h<=0||u<=0&&h>=0)&&(u<=0&&(jn(c.to,r)||Ft(s.marker)-Bt(l))>0||u>=0&&(jn(c.from,n)||Bt(s.marker)-Ft(l))<0))return!0}}}function Gt(e){for(var t;t=Wt(e);)e=t.find(-1,!0).line;return e}function Vt(e,t){var r=fr(e,t),n=Gt(r);return r==n?t:vr(n)}function Ut(e,t){if(t>e.lastLine())return t;var r,n=fr(e,t);if(!Jt(e,n))return t;for(;r=zt(n);)n=r.find(1,!0).line;return vr(n)+1}function Jt(e,t){var r=Bn&&t.markedSpans;if(r)for(var n,l=0;l<r.length;++l)if((n=r[l]).marker.collapsed){if(null==n.from)return!0;if(!n.marker.widgetNode&&0==n.from&&n.marker.inclusiveLeft&&Yt(e,t,n))return!0}}function Yt(e,t,r){for(var n=!0;n;){var l=e,o=t,i=r;if(n=!1,null!=i.to){if(i.marker.inclusiveRight&&i.to==o.text.length)return!0;for(var a,s=0;s<o.markedSpans.length;++s)if((a=o.markedSpans[s]).marker.collapsed&&!a.marker.widgetNode&&a.from==i.to&&(null==a.to||a.to!=i.from)&&(a.marker.inclusiveLeft||i.marker.inclusiveRight)&&Yt(l,o,a))return!0}else{var c=i.marker.find(1,!0);e=l,t=c.line,r=Rt(c.line.markedSpans,i.marker),n=!0,c=void 0}}}function Kt(e,t,r){br(t)<(e.curOp&&e.curOp.scrollTop||e.doc.scrollTop)&&bt(e,null,r)}function Xt(e){return null!=e.height?e.height:($r(document.body,e.node)||Zr(e.cm.display.measure,Xr("div",[e.node],null,"position: relative")),e.height=e.node.offsetHeight)}function Qt(e){e.parent=null,Nt(e)}function Zt(t,r,n,l,o,i){var a=n.flattenSpans;null==a&&(a=t.options.flattenSpans);var s,c=0,u=null,h=new gl(r,t.options.tabSize);for(""==r&&n.blankLine&&n.blankLine(l);!h.eol();){if(h.pos>t.options.maxHighlightLength?(a=!1,i&&tr(t,r,l,h.pos),h.pos=r.length,s=null):s=n.token(h,l),t.options.addModeClass){var f=e.innerMode(n,l).mode.name;f&&(s="m-"+(s?f+" "+s:f))}a&&u==s||(c<h.start&&o(h.start,u),c=h.start,u=s),h.start=h.pos}for(;c<h.pos;){var g=Math.min(h.pos,c+5e4);o(g,u),c=g}}function $t(e,t,r,n){var l=[e.state.modeGen];Zt(e,t.text,e.doc.mode,r,function(e,t){l.push(e,t)},n);for(var o=0;o<e.state.overlays.length;++o){var i=e.state.overlays[o],a=1,s=0;Zt(e,t.text,i.mode,!0,function(e,t){for(var r=a;s<e;){var n=l[a];n>e&&l.splice(a,1,e,l[a+1],n),a+=2,s=Math.min(e,n)}if(t)if(i.opaque)l.splice(r,a-r,e,t),a=r+2;else for(;r<a;r+=2){var o=l[r+1];l[r+1]=o?o+" "+t:t}})}return l}function er(e,t){return t.styles&&t.styles[0]==e.state.modeGen||(t.styles=$t(e,t,t.stateAfter=ee(e,vr(t)))),t.styles}function tr(e,t,r,n){var l=e.doc.mode,o=new gl(t,e.options.tabSize);for(o.start=o.pos=n||0,""==t&&l.blankLine&&l.blankLine(r);!o.eol()&&o.pos<=e.options.maxHighlightLength;)l.token(o,r),o.start=o.pos}function rr(e,t){if(!e)return null;for(;;){var r=e.match(/(?:^|\s+)line-(background-)?(\S+)/);if(!r)break;e=e.slice(0,r.index)+e.slice(r.index+r[0].length);var n=r[1]?"bgClass":"textClass";null==t[n]?t[n]=r[2]:new RegExp("(?:^|s)"+r[2]+"(?:$|s)").test(t[n])||(t[n]+=" "+r[2])}if(/^\s*$/.test(e))return null;var l=t.cm.options.addModeClass?wl:yl;return l[e]||(l[e]=e.replace(/\S+/g,"cm-$&"))}function nr(e,t){var r=Xr("span",null,null,wn?"padding-right: .1px":null),n={pre:Xr("pre",[r]),content:r,col:0,pos:0,cm:e};t.measure={};for(var l=0;l<=(t.rest?t.rest.length:0);l++){var o,i=l?t.rest[l-1]:t.line;n.pos=0,n.addToken=lr,(yn||wn)&&e.getOption("lineWrapping")&&(n.addToken=function(e){function t(e){for(var t=" ",r=0;r<e.length-2;++r)t+=r%2?" ":"";return t+=" "}return function(r,n,l,o,i,a){e(r,n.replace(/ {3,}/g,t),l,o,i,a)}}(n.addToken)),function(e){if(null!=Jl)return Jl;var t=Zr(e,document.createTextNode("AA")),r=Wl(t,0,1).getBoundingClientRect();if(r.left==r.right)return!1;var n=Wl(t,1,2).getBoundingClientRect();return Jl=n.right-r.right<3}(e.display.measure)&&(o=yr(i))&&(n.addToken=function(e,t){return function(r,n,l,o,i,a){l=l?l+" cm-force-border":"cm-force-border";for(var s=r.pos,c=s+n.length;;){for(var u=0;u<t.length;u++){var h=t[u];if(h.to>s&&h.from<=s)break}if(h.to>=c)return e(r,n,l,o,i,a);e(r,n.slice(0,h.to-s),l,o,null,a),o=null,n=n.slice(h.to-s),s=h.to}}}(n.addToken,o)),n.map=[],function(e,t,r){var n=e.markedSpans,l=e.text,o=0;if(n)for(var i,a,s,c,u,h,f=l.length,g=0,d=1,p="",v=0;;){if(v==g){a=s=c=u="",h=null,v=1/0;for(var m=[],b=0;b<n.length;++b){var y=n[b],w=y.marker;y.from<=g&&(null==y.to||y.to>g)?(null!=y.to&&v>y.to&&(v=y.to,s=""),w.className&&(a+=" "+w.className),w.startStyle&&y.from==g&&(c+=" "+w.startStyle),w.endStyle&&y.to==v&&(s+=" "+w.endStyle),w.title&&!u&&(u=w.title),w.collapsed&&(!h||jt(h.marker,w)<0)&&(h=y)):y.from>g&&v>y.from&&(v=y.from),"bookmark"==w.type&&y.from==g&&w.widgetNode&&m.push(w)}if(h&&(h.from||0)==g&&(or(t,(null==h.to?f+1:h.to)-g,h.marker,null==h.from),null==h.to))return;if(!h&&m.length)for(b=0;b<m.length;++b)or(t,0,m[b])}if(g>=f)break;for(var _=Math.min(f,v);;){if(p){var x=g+p.length;if(!h){var k=x>_?p.slice(0,_-g):p;t.addToken(t,k,i?i+a:a,c,g+k.length==v?s:"",u)}if(x>=_){p=p.slice(_-g),g=_;break}g=x,c=""}p=l.slice(o,o=r[d++]),i=rr(r[d++],t)}}else for(d=1;d<r.length;d+=2)t.addToken(t,l.slice(o,o=r[d]),rr(r[d+1],t))}(i,n,er(e,i)),0==n.map.length&&n.map.push(0,0,n.content.appendChild(function(e){if(null==Ul){var t=Xr("span","");Zr(e,Xr("span",[t,document.createTextNode("x")])),0!=e.firstChild.offsetHeight&&(Ul=t.offsetWidth<=1&&t.offsetHeight>2&&!pn)}return Ul?Xr("span",""):Xr("span","",null,"display: inline-block; width: 1px; margin-right: -1px")}(e.display.measure))),0==l?(t.measure.map=n.map,t.measure.cache={}):((t.measure.maps||(t.measure.maps=[])).push(n.map),(t.measure.caches||(t.measure.caches=[])).push({}))}return Rl(e,"renderLine",e,t.line,n.pre),n}function lr(e,t,r,n,l,o){if(t){var i=e.cm.options.specialChars,a=!1;if(i.test(t))for(var s=document.createDocumentFragment(),c=0;;){i.lastIndex=c;var u=i.exec(t),h=u?u.index-c:t.length-c;if(h&&(d=document.createTextNode(t.slice(c,c+h)),vn?s.appendChild(Xr("span",[d])):s.appendChild(d),e.map.push(e.pos,e.pos+h,d),e.col+=h,e.pos+=h),!u)break;if(c+=h+1,"\t"==u[0]){var f=e.cm.options.tabSize,g=f-e.col%f,d=s.appendChild(Xr("span",Wr(g),"cm-tab"));e.col+=g}else d=e.cm.options.specialCharPlaceholder(u[0]),vn?s.appendChild(Xr("span",[d])):s.appendChild(d),e.col+=1;e.map.push(e.pos,e.pos+1,d),e.pos++}else e.col+=t.length,s=document.createTextNode(t),e.map.push(e.pos,e.pos+t.length,s),vn&&(a=!0),e.pos+=t.length;if(r||n||l||a){var p=r||"";n&&(p+=n),l&&(p+=l);var v=Xr("span",[s],p);return o&&(v.title=o),e.content.appendChild(v)}e.content.appendChild(s)}}function or(e,t,r,n){var l=!n&&r.widgetNode;l&&(e.map.push(e.pos,e.pos+t,l),e.content.appendChild(l)),e.pos+=t}function ir(e,t){return 0==t.from.ch&&0==t.to.ch&&""==zr(t.text)&&(!e.cm||e.cm.options.wholeLineUpdateBefore)}function ar(e,t,r,n){function l(e){return r?r[e]:null}function o(e,r,l){!function(e,t,r,n){e.text=t,e.stateAfter&&(e.stateAfter=null),e.styles&&(e.styles=null),null!=e.order&&(e.order=null),Nt(e),Pt(e,r);var l=n?n(e):1;l!=e.height&&pr(e,l)}(e,r,l,n),Dr(e,"change",e,t)}var i=t.from,a=t.to,s=t.text,c=fr(e,i.line),u=fr(e,a.line),h=zr(s),f=l(s.length-1),g=a.line-i.line;if(ir(e,t)){for(var d=0,p=[];d<s.length-1;++d)p.push(new bl(s[d],l(d),n));o(u,u.text,f),g&&e.remove(i.line,g),p.length&&e.insert(i.line,p)}else if(c==u)if(1==s.length)o(c,c.text.slice(0,i.ch)+h+c.text.slice(a.ch),f);else{for(var p=[],d=1;d<s.length-1;++d)p.push(new bl(s[d],l(d),n));p.push(new bl(h+c.text.slice(a.ch),f,n)),o(c,c.text.slice(0,i.ch)+s[0],l(0)),e.insert(i.line+1,p)}else if(1==s.length)o(c,c.text.slice(0,i.ch)+s[0]+u.text.slice(a.ch),l(0)),e.remove(i.line+1,g);else{o(c,c.text.slice(0,i.ch)+s[0],l(0)),o(u,h+u.text.slice(a.ch),f);for(var d=1,p=[];d<s.length-1;++d)p.push(new bl(s[d],l(d),n));g>1&&e.remove(i.line+1,g-1),e.insert(i.line+1,p)}Dr(e,"change",e,t)}function sr(e){this.lines=e,this.parent=null;for(var t=0,r=0;t<e.length;++t)e[t].parent=this,r+=e[t].height;this.height=r}function cr(e){this.children=e;for(var t=0,r=0,n=0;n<e.length;++n){var l=e[n];t+=l.chunkSize(),r+=l.height,l.parent=this}this.size=t,this.height=r,this.parent=null}function ur(e,t,r){function n(e,l,o){if(e.linked)for(var i=0;i<e.linked.length;++i){var a=e.linked[i];if(a.doc!=l){var s=o&&a.sharedHist;r&&!s||(t(a.doc,s),n(a.doc,e,s))}}}n(e,null,!0)}function hr(e,r){if(r.cm)throw new Error("This document is already in use.");e.doc=r,r.cm=e,l(e),t(e),e.options.lineWrapping||u(e),e.options.mode=r.modeOption,Ie(e)}function fr(e,t){if((t-=e.first)<0||t>=e.size)throw new Error("There is no line "+(t+e.first)+" in the document.");for(var r=e;!r.lines;)for(var n=0;;++n){var l=r.children[n],o=l.chunkSize();if(t<o){r=l;break}t-=o}return r.lines[t]}function gr(e,t,r){var n=[],l=t.line;return e.iter(t.line,r.line+1,function(e){var o=e.text;l==r.line&&(o=o.slice(0,r.ch)),l==t.line&&(o=o.slice(t.ch)),n.push(o),++l}),n}function dr(e,t,r){var n=[];return e.iter(t,r,function(e){n.push(e.text)}),n}function pr(e,t){var r=t-e.height;if(r)for(var n=e;n;n=n.parent)n.height+=r}function vr(e){if(null==e.parent)return null;for(var t=e.parent,r=qr(t.lines,e),n=t.parent;n;t=n,n=n.parent)for(var l=0;n.children[l]!=t;++l)r+=n.children[l].chunkSize();return r+t.first}function mr(e,t){var r=e.first;e:do{for(o=0;o<e.children.length;++o){var n=e.children[o],l=n.height;if(t<l){e=n;continue e}t-=l,r+=n.chunkSize()}return r}while(!e.lines);for(var o=0;o<e.lines.length;++o){var i=e.lines[o].height;if(t<i)break;t-=i}return r+o}function br(e){for(var t=0,r=(e=Gt(e)).parent,n=0;n<r.lines.length;++n){var l=r.lines[n];if(l==e)break;t+=l.height}for(var o=r.parent;o;r=o,o=r.parent)for(n=0;n<o.children.length;++n){var i=o.children[n];if(i==r)break;t+=i.height}return t}function yr(e){var t=e.order;return null==t&&(t=e.order=eo(e.text)),t}function wr(e){this.done=[],this.undone=[],this.undoDepth=1/0,this.lastModTime=this.lastSelTime=0,this.lastOp=null,this.lastOrigin=this.lastSelOrigin=null,this.generation=this.maxGeneration=e||1}function _r(e,t){var r={from:L(t.from),to:Qn(t),text:gr(e,t.from,t.to)};return Mr(e,r,t.from.line,t.to.line+1),ur(e,function(e){Mr(e,r,t.from.line,t.to.line+1)},!0),r}function xr(e){for(;e.length&&zr(e).ranges;)e.pop()}function kr(e,t,r,n){var l=e.history;l.undone.length=0;var o,i=+new Date;if((l.lastOp==n||l.lastOrigin==t.origin&&t.origin&&("+"==t.origin.charAt(0)&&e.cm&&l.lastModTime>i-e.cm.options.historyEventDelay||"*"==t.origin.charAt(0)))&&(o=function(e,t){return t?(xr(e.done),zr(e.done)):e.done.length&&!zr(e.done).ranges?zr(e.done):e.done.length>1&&!e.done[e.done.length-2].ranges?(e.done.pop(),zr(e.done)):void 0}(l,l.lastOp==n))){var a=zr(o.changes);0==jn(t.from,t.to)&&0==jn(t.from,a.to)?a.to=Qn(t):o.changes.push(_r(e,t))}else{var s=zr(l.done);for(s&&s.ranges||Cr(e.sel,l.done),o={changes:[_r(e,t)],generation:l.generation},l.done.push(o);l.done.length>l.undoDepth;)l.done.shift(),l.done[0].ranges||l.done.shift()}l.done.push(r),l.generation=++l.maxGeneration,l.lastModTime=l.lastSelTime=i,l.lastOp=n,l.lastOrigin=l.lastSelOrigin=t.origin,a||Rl(e,"historyAdded")}function Cr(e,t){var r=zr(t);r&&r.ranges&&r.equals(e)||t.push(e)}function Mr(e,t,r,n){var l=t["spans_"+e.id],o=0;e.iter(Math.max(e.first,r),Math.min(e.first+e.size,n),function(r){r.markedSpans&&((l||(l=t["spans_"+e.id]={}))[o]=r.markedSpans),++o})}function Sr(e){if(!e)return null;for(var t,r=0;r<e.length;++r)e[r].marker.explicitlyCleared?t||(t=e.slice(0,r)):t&&t.push(e[r]);return t?t.length?t:null:e}function Er(e,t,r){for(var n=0,l=[];n<e.length;++n){var o=e[n];if(o.ranges)l.push(r?R.prototype.deepCopy.call(o):o);else{var i=o.changes,a=[];l.push({changes:a});for(var s=0;s<i.length;++s){var c,u=i[s];if(a.push({from:u.from,to:u.to,text:u.text}),t)for(var h in u)(c=h.match(/^spans_(\d+)$/))&&qr(t,Number(c[1]))>-1&&(zr(a)[h]=u[h],delete u[h])}}}return l}function Lr(e,t,r,n){r<e.line?e.line+=n:t<e.line&&(e.line=t,e.ch=0)}function Tr(e,t,r,n){for(var l=0;l<e.length;++l){var o=e[l],i=!0;if(o.ranges)for(o.copied||((o=e[l]=o.deepCopy()).copied=!0),a=0;a<o.ranges.length;a++)Lr(o.ranges[a].anchor,t,r,n),Lr(o.ranges[a].head,t,r,n);else{for(var a=0;a<o.changes.length;++a){var s=o.changes[a];if(r<s.from.line)s.from=Fn(s.from.line+n,s.from.ch),s.to=Fn(s.to.line+n,s.to.ch);else if(t<=s.to.line){i=!1;break}}i||(e.splice(0,l+1),l=0)}}}function Ir(e,t){var r=t.from.line,n=t.to.line,l=t.text.length-(n-r)-1;Tr(e.done,r,n,l),Tr(e.undone,r,n,l)}function Rr(e){return null!=e.defaultPrevented?e.defaultPrevented:0==e.returnValue}function Or(e){return e.target||e.srcElement}function Ar(e){var t=e.which;return null==t&&(1&e.button?t=1:2&e.button?t=3:4&e.button&&(t=2)),Rn&&e.ctrlKey&&1==t&&(t=3),t}function Dr(e,t){function r(e){return function(){e.apply(null,l)}}var n=e._handlers&&e._handlers[t];if(n){var l=Array.prototype.slice.call(arguments,2);Ml||(++Ol,Ml=[],setTimeout(Nr,0));for(var o=0;o<n.length;++o)Ml.push(r(n[o]))}}function Nr(){--Ol;var e=Ml;Ml=null;for(var t=0;t<e.length;++t)e[t]()}function Pr(e,t,r){return Rl(e,r||t.type,e,t),Rr(t)||t.codemirrorIgnore}function Br(e,t){var r=e._handlers&&e._handlers[t];return r&&r.length>0}function Fr(e){e.prototype.on=function(e,t){Tl(this,e,t)},e.prototype.off=function(e,t){Il(this,e,t)}}function jr(){this.id=null}function Hr(e,t,r){for(var n=0,l=0;;){var o=e.indexOf("\t",n);-1==o&&(o=e.length);var i=o-n;if(o==e.length||l+i>=t)return n+Math.min(i,t-l);if(l+=o-n,l+=r-l%r,n=o+1,l>=t)return n}}function Wr(e){for(;jl.length<=e;)jl.push(zr(jl)+" ");return jl[e]}function zr(e){return e[e.length-1]}function qr(e,t){for(var r=0;r<e.length;++r)if(e[r]==t)return r;return-1}function Gr(e,t){for(var r=[],n=0;n<e.length;n++)r[n]=t(e[n],n);return r}function Vr(e,t){var r;if(Object.create)r=Object.create(e);else{var n=function(){};n.prototype=e,r=new n}return t&&Ur(t,r),r}function Ur(e,t){t||(t={});for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);return t}function Jr(e){var t=Array.prototype.slice.call(arguments,1);return function(){return e.apply(null,t)}}function Yr(e){for(var t in e)if(e.hasOwnProperty(t)&&e[t])return!1;return!0}function Kr(e){return e.charCodeAt(0)>=768&&Gl.test(e)}function Xr(e,t,r,n){var l=document.createElement(e);if(r&&(l.className=r),n&&(l.style.cssText=n),"string"==typeof t)l.appendChild(document.createTextNode(t));else if(t)for(var o=0;o<t.length;++o)l.appendChild(t[o]);return l}function Qr(e){for(var t=e.childNodes.length;t>0;--t)e.removeChild(e.firstChild);return e}function Zr(e,t){return Qr(e).appendChild(t)}function $r(e,t){if(e.contains)return e.contains(t);for(;t=t.parentNode;)if(t==e)return!0}function en(){return document.activeElement}function tn(e){if(null!=Vl)return Vl;var t=Xr("div",null,null,"width: 50px; height: 50px; overflow-x: scroll");return Zr(e,t),t.offsetWidth&&(Vl=t.offsetHeight-t.clientHeight),Vl||0}function rn(e){return e.level%2?e.to:e.from}function nn(e){return e.level%2?e.from:e.to}function ln(e){var t=yr(e);return t?rn(t[0]):0}function on(e){var t=yr(e);return t?nn(zr(t)):e.text.length}function an(e,t){var r=fr(e.doc,t),n=Gt(r);n!=r&&(t=vr(n));var l=yr(n),o=l?l[0].level%2?on(n):ln(n):0;return Fn(t,o)}function sn(e,t,r){var n=e[0].level;return t==n||r!=n&&t<r}function cn(e,t){$l=null;for(var r,n=0;n<e.length;++n){var l=e[n];if(l.from<t&&l.to>t)return n;if(l.from==t||l.to==t){if(null!=r)return sn(e,l.level,e[r].level)?(l.from!=l.to&&($l=r),n):(l.from!=l.to&&($l=n),r);r=n}}return r}function un(e,t,r,n){if(!n)return t+r;do{t+=r}while(t>0&&Kr(e.text.charAt(t)));return t}function hn(e,t,r,n){var l=yr(e);if(!l)return fn(e,t,r,n);for(var o=cn(l,t),i=l[o],a=un(e,t,i.level%2?-r:r,n);;){if(a>i.from&&a<i.to)return a;if(a==i.from||a==i.to)return cn(l,a)==o?a:(i=l[o+=r],r>0==i.level%2?i.to:i.from);if(!(i=l[o+=r]))return null;a=r>0==i.level%2?un(e,i.to,-1,n):un(e,i.from,1,n)}}function fn(e,t,r,n){var l=t+r;if(n)for(;l>0&&Kr(e.text.charAt(l));)l+=r;return l<0||l>e.text.length?null:l}var gn=/gecko\/\d/i.test(navigator.userAgent),dn=/MSIE \d/.test(navigator.userAgent),pn=dn&&(null==document.documentMode||document.documentMode<8),vn=dn&&(null==document.documentMode||document.documentMode<9),mn=dn&&(null==document.documentMode||document.documentMode<10),bn=/Trident\/([7-9]|\d{2,})\./.test(navigator.userAgent),yn=dn||bn,wn=/WebKit\//.test(navigator.userAgent),_n=wn&&/Qt\/\d+\.\d+/.test(navigator.userAgent),xn=/Chrome\//.test(navigator.userAgent),kn=/Opera\//.test(navigator.userAgent),Cn=/Apple Computer/.test(navigator.vendor),Mn=/KHTML\//.test(navigator.userAgent),Sn=/Mac OS X 1\d\D([7-9]|\d\d)\D/.test(navigator.userAgent),En=/Mac OS X 1\d\D([8-9]|\d\d)\D/.test(navigator.userAgent),Ln=/PhantomJS/.test(navigator.userAgent),Tn=/AppleWebKit/.test(navigator.userAgent)&&/Mobile\/\w+/.test(navigator.userAgent),In=Tn||/Android|webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(navigator.userAgent),Rn=Tn||/Mac/.test(navigator.platform),On=/win/i.test(navigator.platform),An=kn&&navigator.userAgent.match(/Version\/(\d*\.\d*)/);An&&(An=Number(An[1])),An&&An>=15&&(kn=!1,wn=!0);var Dn=Rn&&(_n||kn&&(null==An||An<12.11)),Nn=gn||yn&&!vn,Pn=!1,Bn=!1,Fn=e.Pos=function(e,t){if(!(this instanceof Fn))return new Fn(e,t);this.line=e,this.ch=t},jn=e.cmpPos=function(e,t){return e.line-t.line||e.ch-t.ch};R.prototype={primary:function(){return this.ranges[this.primIndex]},equals:function(e){if(e==this)return!0;if(e.primIndex!=this.primIndex||e.ranges.length!=this.ranges.length)return!1;for(var t=0;t<this.ranges.length;t++){var r=this.ranges[t],n=e.ranges[t];if(0!=jn(r.anchor,n.anchor)||0!=jn(r.head,n.head))return!1}return!0},deepCopy:function(){for(var e=[],t=0;t<this.ranges.length;t++)e[t]=new O(L(this.ranges[t].anchor),L(this.ranges[t].head));return new R(e,this.primIndex)},somethingSelected:function(){for(var e=0;e<this.ranges.length;e++)if(!this.ranges[e].empty())return!0;return!1},contains:function(e,t){t||(t=e);for(var r=0;r<this.ranges.length;r++){var n=this.ranges[r];if(jn(t,n.from())>=0&&jn(e,n.to())<=0)return r}return-1}},O.prototype={from:function(){return I(this.anchor,this.head)},to:function(){return T(this.anchor,this.head)},empty:function(){return this.head.line==this.anchor.line&&this.head.ch==this.anchor.ch}};var Hn,Wn,zn,qn={left:0,right:0,top:0,bottom:0},Gn=0,Vn=0,Un=0,Jn=null;yn?Jn=-.53:gn?Jn=15:xn?Jn=-.7:Cn&&(Jn=-1/3);var Yn,Kn,Xn=null,Qn=e.changeEnd=function(e){return e.text?Fn(e.from.line+e.text.length-1,zr(e.text).length+(1==e.text.length?e.from.ch:0)):e.to};e.prototype={constructor:e,posFromMouse:function(e){return Ge(this,e,!0)},focus:function(){window.focus(),He(this),Be(this)},setOption:function(e,t){var r=this.options,n=r[e];r[e]==t&&"mode"!=e||(r[e]=t,$n.hasOwnProperty(e)&&Me(this,$n[e])(this,t,n))},getOption:function(e){return this.options[e]},getDoc:function(){return this.doc},addKeyMap:function(e,t){this.state.keyMaps[t?"push":"unshift"](e)},removeKeyMap:function(e){for(var t=this.state.keyMaps,r=0;r<t.length;++r)if(t[r]==e||"string"!=typeof t[r]&&t[r].name==e)return t.splice(r,1),!0},addOverlay:Se(function(t,r){var n=t.token?t:e.getMode(this.options,t);if(n.startState)throw new Error("Overlays may not be stateful.");this.state.overlays.push({mode:n,modeSpec:t,opaque:r&&r.opaque}),this.state.modeGen++,Ie(this)}),removeOverlay:Se(function(e){for(var t=this.state.overlays,r=0;r<t.length;++r){var n=t[r].modeSpec;if(n==e||"string"==typeof e&&n.name==e)return t.splice(r,1),this.state.modeGen++,void Ie(this)}}),indentLine:Se(function(e,t,r){"string"!=typeof t&&"number"!=typeof t&&(t=null==t?this.options.smartIndent?"smart":"prev":t?"add":"subtract"),B(this.doc,e)&&_t(this,e,t,r)}),indentSelection:Se(function(e){for(var t=this.doc.sel.ranges,r=-1,n=0;n<t.length;n++){var l=t[n];if(l.empty())l.head.line>r&&(_t(this,l.head.line,e,!0),r=l.head.line,n==this.doc.sel.primIndex&&yt(this));else{var o=Math.max(r,l.from().line),i=l.to();r=Math.min(this.lastLine(),i.line-(i.ch?0:1))+1;for(var a=o;a<r;++a)_t(this,a,e)}}}),getTokenAt:function(e,t){for(var r=this.doc,n=ee(this,(e=P(r,e)).line,t),l=this.doc.mode,o=fr(r,e.line),i=new gl(o.text,this.options.tabSize);i.pos<e.ch&&!i.eol();){i.start=i.pos;var a=l.token(i,n)}return{start:i.start,end:i.pos,string:i.current(),type:a||null,state:n}},getTokenTypeAt:function(e){e=P(this.doc,e);var t=er(this,fr(this.doc,e.line)),r=0,n=(t.length-1)/2,l=e.ch;if(0==l)return t[2];for(;;){var o=r+n>>1;if((o?t[2*o-1]:0)>=l)n=o;else{if(!(t[2*o+1]<l))return t[2*o+2];r=o+1}}},getModeAt:function(t){var r=this.doc.mode;return r.innerMode?e.innerMode(r,this.getTokenAt(t).state).mode:r},getHelper:function(e,t){return this.getHelpers(e,t)[0]},getHelpers:function(e,t){var r=[];if(!ol.hasOwnProperty(t))return ol;var n=ol[t],l=this.getModeAt(e);if("string"==typeof l[t])n[l[t]]&&r.push(n[l[t]]);else if(l[t])for(i=0;i<l[t].length;i++){var o=n[l[t][i]];o&&r.push(o)}else l.helperType&&n[l.helperType]?r.push(n[l.helperType]):n[l.name]&&r.push(n[l.name]);for(var i=0;i<n._global.length;i++){var a=n._global[i];a.pred(l,this)&&-1==qr(r,a.val)&&r.push(a.val)}return r},getStateAfter:function(e,t){var r=this.doc;return e=N(r,null==e?r.first+r.size-1:e),ee(this,e+1,t)},cursorCoords:function(e,t){var r,n=this.doc.sel.primary();return r=null==e?n.head:"object"==typeof e?P(this.doc,e):e?n.from():n.to(),ve(this,r,t||"page")},charCoords:function(e,t){return pe(this,P(this.doc,e),t||"page")},coordsChar:function(e,t){return e=de(this,e,t||"page"),ye(this,e.left,e.top)},lineAtHeight:function(e,t){return e=de(this,{top:e,left:0},t||"page").top,mr(this.doc,e+this.display.viewOffset)},heightAtLine:function(e,t){var r=!1,n=this.doc.first+this.doc.size-1;e<this.doc.first?e=this.doc.first:e>n&&(e=n,r=!0);var l=fr(this.doc,e);return ge(this,l,{top:0,left:0},t||"page").top+(r?this.doc.height-br(l):0)},defaultTextHeight:function(){return we(this.display)},defaultCharWidth:function(){return _e(this.display)},setGutterMarker:Se(function(e,t,r){return xt(this,e,"gutter",function(e){var n=e.gutterMarkers||(e.gutterMarkers={});return n[t]=r,!r&&Yr(n)&&(e.gutterMarkers=null),!0})}),clearGutter:Se(function(e){var t=this,r=t.doc,n=r.first;r.iter(function(r){r.gutterMarkers&&r.gutterMarkers[e]&&(r.gutterMarkers[e]=null,Re(t,n,"gutter"),Yr(r.gutterMarkers)&&(r.gutterMarkers=null)),++n})}),addLineClass:Se(function(e,t,r){return xt(this,e,"class",function(e){var n="text"==t?"textClass":"background"==t?"bgClass":"wrapClass";if(e[n]){if(new RegExp("(?:^|\\s)"+r+"(?:$|\\s)").test(e[n]))return!1;e[n]+=" "+r}else e[n]=r;return!0})}),removeLineClass:Se(function(e,t,r){return xt(this,e,"class",function(e){var n="text"==t?"textClass":"background"==t?"bgClass":"wrapClass",l=e[n];if(!l)return!1;if(null==r)e[n]=null;else{var o=l.match(new RegExp("(?:^|\\s+)"+r+"(?:$|\\s+)"));if(!o)return!1;var i=o.index+o[0].length;e[n]=l.slice(0,o.index)+(o.index&&i!=l.length?" ":"")+l.slice(i)||null}return!0})}),addLineWidget:Se(function(e,t,r){return function(e,t,r,n){var l=new ml(e,r,n);return l.noHScroll&&(e.display.alignWidgets=!0),xt(e,t,"widget",function(t){var r=t.widgets||(t.widgets=[]);if(null==l.insertAt?r.push(l):r.splice(Math.min(r.length-1,Math.max(0,l.insertAt)),0,l),l.line=t,!Jt(e.doc,t)){var n=br(t)<e.doc.scrollTop;pr(t,t.height+Xt(l)),n&&bt(e,null,l.height),e.curOp.forceUpdate=!0}return!0}),l}(this,e,t,r)}),removeLineWidget:function(e){e.clear()},lineInfo:function(e){if("number"==typeof e){if(!B(this.doc,e))return null;if(t=e,!(e=fr(this.doc,e)))return null}else{var t;if(null==(t=vr(e)))return null}return{line:t,handle:e,text:e.text,gutterMarkers:e.gutterMarkers,textClass:e.textClass,bgClass:e.bgClass,wrapClass:e.wrapClass,widgets:e.widgets}},getViewport:function(){return{from:this.display.viewFrom,to:this.display.viewTo}},addWidget:function(e,t,r,n,l){var o=this.display,i=(e=ve(this,P(this.doc,e))).bottom,a=e.left;if(t.style.position="absolute",o.sizer.appendChild(t),"over"==n)i=e.top;else if("above"==n||"near"==n){var s=Math.max(o.wrapper.clientHeight,this.doc.height),c=Math.max(o.sizer.clientWidth,o.lineSpace.clientWidth);("above"==n||e.bottom+t.offsetHeight>s)&&e.top>t.offsetHeight?i=e.top-t.offsetHeight:e.bottom+t.offsetHeight<=s&&(i=e.bottom),a+t.offsetWidth>c&&(a=c-t.offsetWidth)}t.style.top=i+"px",t.style.left=t.style.right="","right"==l?(a=o.sizer.clientWidth-t.offsetWidth,t.style.right="0px"):("left"==l?a=0:"middle"==l&&(a=(o.sizer.clientWidth-t.offsetWidth)/2),t.style.left=a+"px"),r&&function(e,t,r,n,l){var o=mt(e,t,r,n,l);null!=o.scrollTop&&Ke(e,o.scrollTop),null!=o.scrollLeft&&Xe(e,o.scrollLeft)}(this,a,i,a+t.offsetWidth,i+t.offsetHeight)},triggerOnKeyDown:Se(tt),triggerOnKeyPress:Se(nt),triggerOnKeyUp:Se(rt),execCommand:function(e){if(sl.hasOwnProperty(e))return sl[e](this)},findPosH:function(e,t,r,n){var l=1;t<0&&(l=-1,t=-t);for(var o=0,i=P(this.doc,e);o<t&&!(i=Ct(this.doc,i,l,r,n)).hitSide;++o);return i},moveH:Se(function(e,t){var r=this;r.extendSelectionsBy(function(n){return r.display.shift||r.doc.extend||n.empty()?Ct(r.doc,n.head,e,t,r.options.rtlMoveVisually):e<0?n.from():n.to()},Bl)}),deleteH:Se(function(e,t){var r=this.doc.sel,n=this.doc;r.somethingSelected()?n.replaceSelection("",null,"+delete"):kt(this,function(r){var l=Ct(n,r.head,e,t,!1);return e<0?{from:l,to:r.head}:{from:r.head,to:l}})}),findPosV:function(e,t,r,n){var l=1,o=n;t<0&&(l=-1,t=-t);for(var i=0,a=P(this.doc,e);i<t;++i){var s=ve(this,a,"div");if(null==o?o=s.left:s.left=o,(a=Mt(this,s,l,r)).hitSide)break}return a},moveV:Se(function(e,t){var r=this,n=this.doc,l=[],o=!r.display.shift&&!n.extend&&n.sel.somethingSelected();if(n.extendSelectionsBy(function(i){if(o)return e<0?i.from():i.to();var a=ve(r,i.head,"div");null!=i.goalColumn&&(a.left=i.goalColumn),l.push(a.left);var s=Mt(r,a,e,t);return"page"==t&&i==n.sel.primary()&&bt(r,null,pe(r,s,"div").top-a.top),s},Bl),l.length)for(var i=0;i<n.sel.ranges.length;i++)n.sel.ranges[i].goalColumn=l[i]}),toggleOverwrite:function(e){null!=e&&e==this.state.overwrite||((this.state.overwrite=!this.state.overwrite)?this.display.cursorDiv.className+=" CodeMirror-overwrite":this.display.cursorDiv.className=this.display.cursorDiv.className.replace(" CodeMirror-overwrite",""),Rl(this,"overwriteToggle",this,this.state.overwrite))},hasFocus:function(){return en()==this.display.input},scrollTo:Se(function(e,t){null==e&&null==t||wt(this),null!=e&&(this.curOp.scrollLeft=e),null!=t&&(this.curOp.scrollTop=t)}),getScrollInfo:function(){var e=this.display.scroller,t=Al;return{left:e.scrollLeft,top:e.scrollTop,height:e.scrollHeight-t,width:e.scrollWidth-t,clientHeight:e.clientHeight-t,clientWidth:e.clientWidth-t}},scrollIntoView:Se(function(e,t){if(null==e?(e={from:this.doc.sel.primary().head,to:null},null==t&&(t=this.options.cursorScrollMargin)):"number"==typeof e?e={from:Fn(e,0),to:null}:null==e.from&&(e={from:e,to:null}),e.to||(e.to=e.from),e.margin=t||0,null!=e.from.line)wt(this),this.curOp.scrollToPos=e;else{var r=mt(this,Math.min(e.from.left,e.to.left),Math.min(e.from.top,e.to.top)-e.margin,Math.max(e.from.right,e.to.right),Math.max(e.from.bottom,e.to.bottom)+e.margin);this.scrollTo(r.scrollLeft,r.scrollTop)}}),setSize:Se(function(e,t){function r(e){return"number"==typeof e||/^\d+$/.test(String(e))?e+"px":e}null!=e&&(this.display.wrapper.style.width=r(e)),null!=t&&(this.display.wrapper.style.height=r(t)),this.options.lineWrapping&&ce(this),this.curOp.forceUpdate=!0,Rl(this,"refresh",this)}),operation:function(e){return Ce(this,e)},refresh:Se(function(){var e=this.display.cachedTextHeight;Ie(this),ue(this),this.scrollTo(this.doc.scrollLeft,this.doc.scrollTop),(null==e||Math.abs(e-we(this.display))>.5)&&l(this),Rl(this,"refresh",this)}),swapDoc:Se(function(e){var t=this.doc;return t.cm=null,hr(this,e),ue(this),je(this),this.scrollTo(e.scrollLeft,e.scrollTop),Dr(this,"swapDoc",this,t),t}),getInputField:function(){return this.display.input},getWrapperElement:function(){return this.display.wrapper},getScrollerElement:function(){return this.display.scroller},getGutterElement:function(){return this.display.gutters}},Fr(e);var Zn=e.defaults={},$n=e.optionHandlers={},el=e.Init={toString:function(){return"CodeMirror.Init"}};Et("value","",function(e,t){e.setValue(t)},!0),Et("mode",null,function(e,r){e.doc.modeOption=r,t(e)},!0),Et("indentUnit",2,t,!0),Et("indentWithTabs",!1),Et("smartIndent",!0),Et("tabSize",4,function(e){r(e),ue(e),Ie(e)},!0),Et("specialChars",/[\t\u0000-\u0019\u00ad\u200b\u2028\u2029\ufeff]/g,function(e,t){e.options.specialChars=new RegExp(t.source+(t.test("\t")?"":"|\t"),"g"),e.refresh()},!0),Et("specialCharPlaceholder",function(e){var t=Xr("span","","cm-invalidchar");return t.title="\\u"+e.charCodeAt(0).toString(16),t},function(e){e.refresh()},!0),Et("electricChars",!0),Et("rtlMoveVisually",!On),Et("wholeLineUpdateBefore",!0),Et("theme","default",function(e){i(e),a(e)},!0),Et("keyMap","default",o),Et("extraKeys",null),Et("lineWrapping",!1,function(e){e.options.lineWrapping?(e.display.wrapper.className+=" CodeMirror-wrap",e.display.sizer.style.minWidth=""):(e.display.wrapper.className=e.display.wrapper.className.replace(" CodeMirror-wrap",""),u(e)),l(e),Ie(e),ue(e),setTimeout(function(){g(e)},100)},!0),Et("gutters",[],function(e){h(e.options),a(e)},!0),Et("fixedGutter",!0,function(e,t){e.display.gutters.style.left=t?m(e.display)+"px":"0",e.refresh()},!0),Et("coverGutterNextToScrollbar",!1,g,!0),Et("lineNumbers",!1,function(e){h(e.options),a(e)},!0),Et("firstLineNumber",1,a,!0),Et("lineNumberFormatter",function(e){return e},a,!0),Et("showCursorWhenSelecting",!1,X,!0),Et("resetSelectionOnContextMenu",!0),Et("readOnly",!1,function(e,t){"nocursor"==t?(ot(e),e.display.input.blur(),e.display.disabled=!0):(e.display.disabled=!1,t||je(e))}),Et("disableInput",!1,function(e,t){t||je(e)},!0),Et("dragDrop",!0),Et("cursorBlinkRate",530),Et("cursorScrollMargin",0),Et("cursorHeight",1),Et("workTime",100),Et("workDelay",100),Et("flattenSpans",!0,r,!0),Et("addModeClass",!1,r,!0),Et("pollInterval",100),Et("undoDepth",200,function(e,t){e.doc.history.undoDepth=t}),Et("historyEventDelay",1250),Et("viewportMargin",10,function(e){e.refresh()},!0),Et("maxHighlightLength",1e4,r,!0),Et("moveInputWithCursor",!0,function(e,t){t||(e.display.inputDiv.style.top=e.display.inputDiv.style.left=0)}),Et("tabindex",null,function(e,t){e.display.input.tabIndex=t||""}),Et("autofocus",null);var tl=e.modes={},rl=e.mimeModes={};e.defineMode=function(t,r){if(e.defaults.mode||"null"==t||(e.defaults.mode=t),arguments.length>2){r.dependencies=[];for(var n=2;n<arguments.length;++n)r.dependencies.push(arguments[n])}tl[t]=r},e.defineMIME=function(e,t){rl[e]=t},e.resolveMode=function(t){if("string"==typeof t&&rl.hasOwnProperty(t))t=rl[t];else if(t&&"string"==typeof t.name&&rl.hasOwnProperty(t.name)){var r=rl[t.name];"string"==typeof r&&(r={name:r}),(t=Vr(r,t)).name=r.name}else if("string"==typeof t&&/^[\w\-]+\/[\w\-]+\+xml$/.test(t))return e.resolveMode("application/xml");return"string"==typeof t?{name:t}:t||{name:"null"}},e.getMode=function(t,r){var r=e.resolveMode(r),n=tl[r.name];if(!n)return e.getMode(t,"text/plain");var l=n(t,r);if(nl.hasOwnProperty(r.name)){var o=nl[r.name];for(var i in o)o.hasOwnProperty(i)&&(l.hasOwnProperty(i)&&(l["_"+i]=l[i]),l[i]=o[i])}if(l.name=r.name,r.helperType&&(l.helperType=r.helperType),r.modeProps)for(var i in r.modeProps)l[i]=r.modeProps[i];return l},e.defineMode("null",function(){return{token:function(e){e.skipToEnd()}}}),e.defineMIME("text/plain","null");var nl=e.modeExtensions={};e.extendMode=function(e,t){Ur(t,nl.hasOwnProperty(e)?nl[e]:nl[e]={})},e.defineExtension=function(t,r){e.prototype[t]=r},e.defineDocExtension=function(e,t){xl.prototype[e]=t},e.defineOption=Et;var ll=[];e.defineInitHook=function(e){ll.push(e)};var ol=e.helpers={};e.registerHelper=function(t,r,n){ol.hasOwnProperty(t)||(ol[t]=e[t]={_global:[]}),ol[t][r]=n},e.registerGlobalHelper=function(t,r,n,l){e.registerHelper(t,r,l),ol[t]._global.push({pred:n,val:l})};var il=e.copyState=function(e,t){if(!0===t)return t;if(e.copyState)return e.copyState(t);var r={};for(var n in t){var l=t[n];l instanceof Array&&(l=l.concat([])),r[n]=l}return r},al=e.startState=function(e,t,r){return!e.startState||e.startState(t,r)};e.innerMode=function(e,t){for(;e.innerMode;){var r=e.innerMode(t);if(!r||r.mode==e)break;t=r.state,e=r.mode}return r||{mode:e,state:t}};var sl=e.commands={selectAll:function(e){e.setSelection(Fn(e.firstLine(),0),Fn(e.lastLine()),Nl)},singleSelection:function(e){e.setSelection(e.getCursor("anchor"),e.getCursor("head"),Nl)},killLine:function(e){kt(e,function(t){if(t.empty()){var r=fr(e.doc,t.head.line).text.length;return t.head.ch==r&&t.head.line<e.lastLine()?{from:t.head,to:Fn(t.head.line+1,0)}:{from:t.head,to:Fn(t.head.line,r)}}return{from:t.from(),to:t.to()}})},deleteLine:function(e){kt(e,function(t){return{from:Fn(t.from().line,0),to:P(e.doc,Fn(t.to().line+1,0))}})},delLineLeft:function(e){kt(e,function(e){return{from:Fn(e.from().line,0),to:e.from()}})},undo:function(e){e.undo()},redo:function(e){e.redo()},undoSelection:function(e){e.undoSelection()},redoSelection:function(e){e.redoSelection()},goDocStart:function(e){e.extendSelection(Fn(e.firstLine(),0))},goDocEnd:function(e){e.extendSelection(Fn(e.lastLine()))},goLineStart:function(e){e.extendSelectionsBy(function(t){return an(e,t.head.line)},Bl)},goLineStartSmart:function(e){e.extendSelectionsBy(function(t){var r=an(e,t.head.line),n=e.getLineHandle(r.line),l=yr(n);if(!l||0==l[0].level){var o=Math.max(0,n.text.search(/\S/)),i=t.head.line==r.line&&t.head.ch<=o&&t.head.ch;return Fn(r.line,i?0:o)}return r},Bl)},goLineEnd:function(e){e.extendSelectionsBy(function(t){return function(e,t){for(var r,n=fr(e.doc,t);r=zt(n);)n=r.find(1,!0).line,t=null;var l=yr(n),o=l?l[0].level%2?ln(n):on(n):n.text.length;return Fn(null==t?vr(n):t,o)}(e,t.head.line)},Bl)},goLineRight:function(e){e.extendSelectionsBy(function(t){var r=e.charCoords(t.head,"div").top+5;return e.coordsChar({left:e.display.lineDiv.offsetWidth+100,top:r},"div")},Bl)},goLineLeft:function(e){e.extendSelectionsBy(function(t){var r=e.charCoords(t.head,"div").top+5;return e.coordsChar({left:0,top:r},"div")},Bl)},goLineUp:function(e){e.moveV(-1,"line")},goLineDown:function(e){e.moveV(1,"line")},goPageUp:function(e){e.moveV(-1,"page")},goPageDown:function(e){e.moveV(1,"page")},goCharLeft:function(e){e.moveH(-1,"char")},goCharRight:function(e){e.moveH(1,"char")},goColumnLeft:function(e){e.moveH(-1,"column")},goColumnRight:function(e){e.moveH(1,"column")},goWordLeft:function(e){e.moveH(-1,"word")},goGroupRight:function(e){e.moveH(1,"group")},goGroupLeft:function(e){e.moveH(-1,"group")},goWordRight:function(e){e.moveH(1,"word")},delCharBefore:function(e){e.deleteH(-1,"char")},delCharAfter:function(e){e.deleteH(1,"char")},delWordBefore:function(e){e.deleteH(-1,"word")},delWordAfter:function(e){e.deleteH(1,"word")},delGroupBefore:function(e){e.deleteH(-1,"group")},delGroupAfter:function(e){e.deleteH(1,"group")},indentAuto:function(e){e.indentSelection("smart")},indentMore:function(e){e.indentSelection("add")},indentLess:function(e){e.indentSelection("subtract")},insertTab:function(e){e.replaceSelection("\t")},defaultTab:function(e){e.somethingSelected()?e.indentSelection("add"):e.execCommand("insertTab")},transposeChars:function(e){Ce(e,function(){for(var t=e.listSelections(),r=0;r<t.length;r++){var n=t[r].head,l=fr(e.doc,n.line).text;n.ch>0&&n.ch<l.length-1&&e.replaceRange(l.charAt(n.ch)+l.charAt(n.ch-1),Fn(n.line,n.ch-1),Fn(n.line,n.ch+1))}})},newlineAndIndent:function(e){Ce(e,function(){for(var t=e.listSelections().length,r=0;r<t;r++){var n=e.listSelections()[r];e.replaceRange("\n",n.anchor,n.head,"+input"),e.indentLine(n.from().line+1,null,!0),yt(e)}})},toggleOverwrite:function(e){e.toggleOverwrite()}},cl=e.keyMap={};cl.basic={Left:"goCharLeft",Right:"goCharRight",Up:"goLineUp",Down:"goLineDown",End:"goLineEnd",Home:"goLineStartSmart",PageUp:"goPageUp",PageDown:"goPageDown",Delete:"delCharAfter",Backspace:"delCharBefore","Shift-Backspace":"delCharBefore",Tab:"defaultTab","Shift-Tab":"indentAuto",Enter:"newlineAndIndent",Insert:"toggleOverwrite",Esc:"singleSelection"},cl.pcDefault={"Ctrl-A":"selectAll","Ctrl-D":"deleteLine","Ctrl-Z":"undo","Shift-Ctrl-Z":"redo","Ctrl-Y":"redo","Ctrl-Home":"goDocStart","Ctrl-Up":"goDocStart","Ctrl-End":"goDocEnd","Ctrl-Down":"goDocEnd","Ctrl-Left":"goGroupLeft","Ctrl-Right":"goGroupRight","Alt-Left":"goLineStart","Alt-Right":"goLineEnd","Ctrl-Backspace":"delGroupBefore","Ctrl-Delete":"delGroupAfter","Ctrl-S":"save","Ctrl-F":"find","Ctrl-G":"findNext","Shift-Ctrl-G":"findPrev","Shift-Ctrl-F":"replace","Shift-Ctrl-R":"replaceAll","Ctrl-[":"indentLess","Ctrl-]":"indentMore","Ctrl-U":"undoSelection","Shift-Ctrl-U":"redoSelection","Alt-U":"redoSelection",fallthrough:"basic"},cl.macDefault={"Cmd-A":"selectAll","Cmd-D":"deleteLine","Cmd-Z":"undo","Shift-Cmd-Z":"redo","Cmd-Y":"redo","Cmd-Up":"goDocStart","Cmd-End":"goDocEnd","Cmd-Down":"goDocEnd","Alt-Left":"goGroupLeft","Alt-Right":"goGroupRight","Cmd-Left":"goLineStart","Cmd-Right":"goLineEnd","Alt-Backspace":"delGroupBefore","Ctrl-Alt-Backspace":"delGroupAfter","Alt-Delete":"delGroupAfter","Cmd-S":"save","Cmd-F":"find","Cmd-G":"findNext","Shift-Cmd-G":"findPrev","Cmd-Alt-F":"replace","Shift-Cmd-Alt-F":"replaceAll","Cmd-[":"indentLess","Cmd-]":"indentMore","Cmd-Backspace":"delLineLeft","Cmd-U":"undoSelection","Shift-Cmd-U":"redoSelection",fallthrough:["basic","emacsy"]},cl.emacsy={"Ctrl-F":"goCharRight","Ctrl-B":"goCharLeft","Ctrl-P":"goLineUp","Ctrl-N":"goLineDown","Alt-F":"goWordRight","Alt-B":"goWordLeft","Ctrl-A":"goLineStart","Ctrl-E":"goLineEnd","Ctrl-V":"goPageDown","Shift-Ctrl-V":"goPageUp","Ctrl-D":"delCharAfter","Ctrl-H":"delCharBefore","Alt-D":"delWordAfter","Alt-Backspace":"delWordBefore","Ctrl-K":"killLine","Ctrl-T":"transposeChars"},cl.default=Rn?cl.macDefault:cl.pcDefault;var ul=e.lookupKey=function(e,t,r){function n(t){for(var l=!0;l;){var o=t;l=!1;var i=(o=Lt(o))[e];if(!1===i)return"stop";if(null!=i&&r(i))return!0;if(o.nofallthrough)return"stop";var a=o.fallthrough;if(null==a)return!1;if("[object Array]"==Object.prototype.toString.call(a)){for(var s=0;s<a.length;++s){var c=n(a[s]);if(c)return c}return!1}t=a,l=!0,i=a=void 0}}for(var l=0;l<t.length;++l){var o=n(t[l]);if(o)return"stop"!=o}},hl=e.isModifierKey=function(e){var t=Zl[e.keyCode];return"Ctrl"==t||"Alt"==t||"Shift"==t||"Mod"==t},fl=e.keyName=function(e,t){if(kn&&34==e.keyCode&&e.char)return!1;var r=Zl[e.keyCode];return null!=r&&!e.altGraphKey&&(e.altKey&&(r="Alt-"+r),(Dn?e.metaKey:e.ctrlKey)&&(r="Ctrl-"+r),(Dn?e.ctrlKey:e.metaKey)&&(r="Cmd-"+r),!t&&e.shiftKey&&(r="Shift-"+r),r)};e.fromTextArea=function(t,r){function n(){t.value=s.getValue()}if(r||(r={}),r.value=t.value,!r.tabindex&&t.tabindex&&(r.tabindex=t.tabindex),!r.placeholder&&t.placeholder&&(r.placeholder=t.placeholder),null==r.autofocus){var l=en();r.autofocus=l==t||null!=t.getAttribute("autofocus")&&l==document.body}if(t.form&&(Tl(t.form,"submit",n),!r.leaveSubmitMethodAlone)){var o=t.form,i=o.submit;try{var a=o.submit=function(){n(),o.submit=i,o.submit(),o.submit=a}}catch(e){}}t.style.display="none";var s=e(function(e){t.parentNode.insertBefore(e,t.nextSibling)},r);return s.save=n,s.getTextArea=function(){return t},s.toTextArea=function(){n(),t.parentNode.removeChild(s.getWrapperElement()),t.style.display="",t.form&&(Il(t.form,"submit",n),"function"==typeof t.form.submit&&(t.form.submit=i))},s};var gl=e.StringStream=function(e,t){this.pos=this.start=0,this.string=e,this.tabSize=t||8,this.lastColumnPos=this.lastColumnValue=0,this.lineStart=0};gl.prototype={eol:function(){return this.pos>=this.string.length},sol:function(){return this.pos==this.lineStart},peek:function(){return this.string.charAt(this.pos)||void 0},next:function(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)},eat:function(e){var t=this.string.charAt(this.pos);if("string"==typeof e)r=t==e;else var r=t&&(e.test?e.test(t):e(t));if(r)return++this.pos,t},eatWhile:function(e){for(var t=this.pos;this.eat(e););return this.pos>t},eatSpace:function(){for(var e=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++this.pos;return this.pos>e},skipToEnd:function(){this.pos=this.string.length},skipTo:function(e){var t=this.string.indexOf(e,this.pos);if(t>-1)return this.pos=t,!0},backUp:function(e){this.pos-=e},column:function(){return this.lastColumnPos<this.start&&(this.lastColumnValue=Fl(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue-(this.lineStart?Fl(this.string,this.lineStart,this.tabSize):0)},indentation:function(){return Fl(this.string,null,this.tabSize)-(this.lineStart?Fl(this.string,this.lineStart,this.tabSize):0)},match:function(e,t,r){if("string"!=typeof e){var n=this.string.slice(this.pos).match(e);return n&&n.index>0?null:(n&&!1!==t&&(this.pos+=n[0].length),n)}var l=function(e){return r?e.toLowerCase():e};if(l(this.string.substr(this.pos,e.length))==l(e))return!1!==t&&(this.pos+=e.length),!0},current:function(){return this.string.slice(this.start,this.pos)},hideFirstChars:function(e,t){this.lineStart+=e;try{return t()}finally{this.lineStart-=e}}};var dl=e.TextMarker=function(e,t){this.lines=[],this.type=t,this.doc=e};Fr(dl),dl.prototype.clear=function(){if(!this.explicitlyCleared){var e=this.doc.cm,t=e&&!e.curOp;if(t&&xe(e),Br(this,"clear")){var r=this.find();r&&Dr(this,"clear",r.from,r.to)}for(var n=null,l=null,o=0;o<this.lines.length;++o){var i=this.lines[o],a=Rt(i.markedSpans,this);e&&!this.collapsed?Re(e,vr(i),"text"):e&&(null!=a.to&&(l=vr(i)),null!=a.from&&(n=vr(i))),i.markedSpans=function(e,t){for(var r,n=0;n<e.length;++n)e[n]!=t&&(r||(r=[])).push(e[n]);return r}(i.markedSpans,a),null==a.from&&this.collapsed&&!Jt(this.doc,i)&&e&&pr(i,we(e.display))}if(e&&this.collapsed&&!e.options.lineWrapping)for(o=0;o<this.lines.length;++o){var s=Gt(this.lines[o]),u=c(s);u>e.display.maxLineLength&&(e.display.maxLine=s,e.display.maxLineLength=u,e.display.maxLineChanged=!0)}null!=n&&e&&this.collapsed&&Ie(e,n,l+1),this.lines.length=0,this.explicitlyCleared=!0,this.atomic&&this.doc.cantEdit&&(this.doc.cantEdit=!1,e&&J(e.doc)),e&&Dr(e,"markerCleared",e,this),t&&ke(e)}},dl.prototype.find=function(e,t){null==e&&"bookmark"==this.type&&(e=1);for(var r,n,l=0;l<this.lines.length;++l){var o=this.lines[l],i=Rt(o.markedSpans,this);if(null!=i.from&&(r=Fn(t?o:vr(o),i.from),-1==e))return r;if(null!=i.to&&(n=Fn(t?o:vr(o),i.to),1==e))return n}return r&&{from:r,to:n}},dl.prototype.changed=function(){var e=this.find(-1,!0),t=this,r=this.doc.cm;e&&r&&Ce(r,function(){var n=e.line,l=vr(e.line),o=oe(r,l);if(o&&(se(o),r.curOp.selectionChanged=r.curOp.forceUpdate=!0),r.curOp.updateMaxLine=!0,!Jt(t.doc,n)&&null!=t.height){var i=t.height;t.height=null;var a=Xt(t)-i;a&&pr(n,n.height+a)}})},dl.prototype.attachLine=function(e){if(!this.lines.length&&this.doc.cm){var t=this.doc.cm.curOp;t.maybeHiddenMarkers&&-1!=qr(t.maybeHiddenMarkers,this)||(t.maybeUnhiddenMarkers||(t.maybeUnhiddenMarkers=[])).push(this)}this.lines.push(e)},dl.prototype.detachLine=function(e){if(this.lines.splice(qr(this.lines,e),1),!this.lines.length&&this.doc.cm){var t=this.doc.cm.curOp;(t.maybeHiddenMarkers||(t.maybeHiddenMarkers=[])).push(this)}};var pl=0,vl=e.SharedTextMarker=function(e,t){this.markers=e,this.primary=t;for(var r=0,n=this;r<e.length;++r)e[r].parent=this,Tl(e[r],"clear",function(){n.clear()})};Fr(vl),vl.prototype.clear=function(){if(!this.explicitlyCleared){this.explicitlyCleared=!0;for(var e=0;e<this.markers.length;++e)this.markers[e].clear();Dr(this,"clear")}},vl.prototype.find=function(e,t){return this.primary.find(e,t)};var ml=e.LineWidget=function(e,t,r){if(r)for(var n in r)r.hasOwnProperty(n)&&(this[n]=r[n]);this.cm=e,this.node=t};Fr(ml),ml.prototype.clear=function(){var e=this.cm,t=this.line.widgets,r=this.line,n=vr(r);if(null!=n&&t){for(var l=0;l<t.length;++l)t[l]==this&&t.splice(l--,1);t.length||(r.widgets=null);var o=Xt(this);Ce(e,function(){Kt(e,r,-o),Re(e,n,"widget"),pr(r,Math.max(0,r.height-o))})}},ml.prototype.changed=function(){var e=this.height,t=this.cm,r=this.line;this.height=null;var n=Xt(this)-e;n&&Ce(t,function(){t.curOp.forceUpdate=!0,Kt(t,r,n),pr(r,r.height+n)})};var bl=e.Line=function(e,t,r){this.text=e,Pt(this,t),this.height=r?r(this):1};Fr(bl),bl.prototype.lineNo=function(){return vr(this)};var yl={},wl={};sr.prototype={chunkSize:function(){return this.lines.length},removeInner:function(e,t){for(var r=e,n=e+t;r<n;++r){var l=this.lines[r];this.height-=l.height,Qt(l),Dr(l,"delete")}this.lines.splice(e,t)},collapse:function(e){e.push.apply(e,this.lines)},insertInner:function(e,t,r){this.height+=r,this.lines=this.lines.slice(0,e).concat(t).concat(this.lines.slice(e));for(var n=0;n<t.length;++n)t[n].parent=this},iterN:function(e,t,r){for(var n=e+t;e<n;++e)if(r(this.lines[e]))return!0}},cr.prototype={chunkSize:function(){return this.size},removeInner:function(e,t){this.size-=t;for(var r=0;r<this.children.length;++r){var n=this.children[r],l=n.chunkSize();if(e<l){var o=Math.min(t,l-e),i=n.height;if(n.removeInner(e,o),this.height-=i-n.height,l==o&&(this.children.splice(r--,1),n.parent=null),0==(t-=o))break;e=0}else e-=l}if(this.size-t<25&&(this.children.length>1||!(this.children[0]instanceof sr))){var a=[];this.collapse(a),this.children=[new sr(a)],this.children[0].parent=this}},collapse:function(e){for(var t=0;t<this.children.length;++t)this.children[t].collapse(e)},insertInner:function(e,t,r){this.size+=t.length,this.height+=r;for(var n=0;n<this.children.length;++n){var l=this.children[n],o=l.chunkSize();if(e<=o){if(l.insertInner(e,t,r),l.lines&&l.lines.length>50){for(;l.lines.length>50;){var i=new sr(l.lines.splice(l.lines.length-25,25));l.height-=i.height,this.children.splice(n+1,0,i),i.parent=this}this.maybeSpill()}break}e-=o}},maybeSpill:function(){if(!(this.children.length<=10)){var e=this;do{var t=new cr(e.children.splice(e.children.length-5,5));if(e.parent){e.size-=t.size,e.height-=t.height;var r=qr(e.parent.children,e);e.parent.children.splice(r+1,0,t)}else{var n=new cr(e.children);n.parent=e,e.children=[n,t],e=n}t.parent=e.parent}while(e.children.length>10);e.parent.maybeSpill()}},iterN:function(e,t,r){for(var n=0;n<this.children.length;++n){var l=this.children[n],o=l.chunkSize();if(e<o){var i=Math.min(t,o-e);if(l.iterN(e,i,r))return!0;if(0==(t-=i))break;e=0}else e-=o}}};var _l=0,xl=e.Doc=function(e,t,r){if(!(this instanceof xl))return new xl(e,t,r);null==r&&(r=0),cr.call(this,[new sr([new bl("",null)])]),this.first=r,this.scrollTop=this.scrollLeft=0,this.cantEdit=!1,this.cleanGeneration=1,this.frontier=r;var n=Fn(r,0);this.sel=D(n),this.history=new wr(null),this.id=++_l,this.modeOption=t,"string"==typeof e&&(e=Kl(e)),ar(this,{from:n,to:n,text:e}),G(this,D(n),Nl)};xl.prototype=Vr(cr.prototype,{constructor:xl,iter:function(e,t,r){r?this.iterN(e-this.first,t-e,r):this.iterN(this.first,this.first+this.size,e)},insert:function(e,t){for(var r=0,n=0;n<t.length;++n)r+=t[n].height;this.insertInner(e-this.first,t,r)},remove:function(e,t){this.removeInner(e-this.first,t)},getValue:function(e){var t=dr(this,this.first,this.first+this.size);return!1===e?t:t.join(e||"\n")},setValue:Ee(function(e){var t=Fn(this.first,0),r=this.first+this.size-1;ht(this,{from:t,to:Fn(r,fr(this,r).text.length),text:Kl(e),origin:"setValue"},!0),G(this,D(t))}),replaceRange:function(e,t,r,n){vt(this,e,t=P(this,t),r=r?P(this,r):t,n)},getRange:function(e,t,r){var n=gr(this,P(this,e),P(this,t));return!1===r?n:n.join(r||"\n")},getLine:function(e){var t=this.getLineHandle(e);return t&&t.text},getLineHandle:function(e){if(B(this,e))return fr(this,e)},getLineNumber:function(e){return vr(e)},getLineHandleVisualStart:function(e){return"number"==typeof e&&(e=fr(this,e)),Gt(e)},lineCount:function(){return this.size},firstLine:function(){return this.first},lastLine:function(){return this.first+this.size-1},clipPos:function(e){return P(this,e)},getCursor:function(e){var t=this.sel.primary();return null==e||"head"==e?t.head:"anchor"==e?t.anchor:"end"==e||"to"==e||!1===e?t.to():t.from()},listSelections:function(){return this.sel.ranges},somethingSelected:function(){return this.sel.somethingSelected()},setCursor:Ee(function(e,t,r){z(this,P(this,"number"==typeof e?Fn(e,t||0):e),null,r)}),setSelection:Ee(function(e,t,r){z(this,P(this,e),P(this,t||e),r)}),extendSelection:Ee(function(e,t,r){j(this,P(this,e),t&&P(this,t),r)}),extendSelections:Ee(function(e,t){H(this,function(e,t){for(var r=[],n=0;n<t.length;n++)r[n]=P(e,t[n]);return r}(this,e))}),extendSelectionsBy:Ee(function(e,t){H(this,Gr(this.sel.ranges,e),t)}),setSelections:Ee(function(e,t,r){if(e.length){for(var n=0,l=[];n<e.length;n++)l[n]=new O(P(this,e[n].anchor),P(this,e[n].head));null==t&&(t=Math.min(e.length-1,this.sel.primIndex)),G(this,A(l,t),r)}}),addSelection:Ee(function(e,t,r){var n=this.sel.ranges.slice(0);n.push(new O(P(this,e),P(this,t||e))),G(this,A(n,n.length-1),r)}),getSelection:function(e){for(var t,r=this.sel.ranges,n=0;n<r.length;n++){var l=gr(this,r[n].from(),r[n].to());t=t?t.concat(l):l}return!1===e?t:t.join(e||"\n")},getSelections:function(e){for(var t=[],r=this.sel.ranges,n=0;n<r.length;n++){var l=gr(this,r[n].from(),r[n].to());!1!==e&&(l=l.join(e||"\n")),t[n]=l}return t},replaceSelection:Ee(function(e,t,r){for(var n=[],l=0;l<this.sel.ranges.length;l++)n[l]=e;this.replaceSelections(n,t,r||"+input")}),replaceSelections:function(e,t,r){for(var n=[],l=this.sel,o=0;o<l.ranges.length;o++){var i=l.ranges[o];n[o]={from:i.from(),to:i.to(),text:Kl(e[o]),origin:r}}for(var a=t&&"end"!=t&&function(e,t,r){for(var n=[],l=Fn(e.first,0),o=l,i=0;i<t.length;i++){var a=t[i],s=ct(a.from,l,o),c=ct(Qn(a),l,o);if(l=a.to,o=c,"around"==r){var u=e.sel.ranges[i],h=jn(u.head,u.anchor)<0;n[i]=new O(h?c:s,h?s:c)}else n[i]=new O(s,s)}return new R(n,e.sel.primIndex)}(this,n,t),o=n.length-1;o>=0;o--)ht(this,n[o]);a?q(this,a):this.cm&&yt(this.cm)},undo:Ee(function(){gt(this,"undo")}),redo:Ee(function(){gt(this,"redo")}),undoSelection:Ee(function(){gt(this,"undo",!0)}),redoSelection:Ee(function(){gt(this,"redo",!0)}),setExtending:function(e){this.extend=e},getExtending:function(){return this.extend},historySize:function(){for(var e=this.history,t=0,r=0,n=0;n<e.done.length;n++)e.done[n].ranges||++t;for(n=0;n<e.undone.length;n++)e.undone[n].ranges||++r;return{undo:t,redo:r}},clearHistory:function(){this.history=new wr(this.history.maxGeneration)},markClean:function(){this.cleanGeneration=this.changeGeneration(!0)},changeGeneration:function(e){return e&&(this.history.lastOp=this.history.lastOrigin=null),this.history.generation},isClean:function(e){return this.history.generation==(e||this.cleanGeneration)},getHistory:function(){return{done:Er(this.history.done),undone:Er(this.history.undone)}},setHistory:function(e){var t=this.history=new wr(this.history.maxGeneration);t.done=Er(e.done.slice(0),null,!0),t.undone=Er(e.undone.slice(0),null,!0)},markText:function(e,t,r){return Tt(this,P(this,e),P(this,t),r,"range")},setBookmark:function(e,t){var r={replacedWith:t&&(null==t.nodeType?t.widget:t),insertLeft:t&&t.insertLeft,clearWhenEmpty:!1,shared:t&&t.shared};return e=P(this,e),Tt(this,e,e,r,"bookmark")},findMarksAt:function(e){var t=[],r=fr(this,(e=P(this,e)).line).markedSpans;if(r)for(var n=0;n<r.length;++n){var l=r[n];(null==l.from||l.from<=e.ch)&&(null==l.to||l.to>=e.ch)&&t.push(l.marker.parent||l.marker)}return t},findMarks:function(e,t){e=P(this,e),t=P(this,t);var r=[],n=e.line;return this.iter(e.line,t.line+1,function(l){var o=l.markedSpans;if(o)for(var i=0;i<o.length;i++){var a=o[i];n==e.line&&e.ch>a.to||null==a.from&&n!=e.line||n==t.line&&a.from>t.ch||r.push(a.marker.parent||a.marker)}++n}),r},getAllMarks:function(){var e=[];return this.iter(function(t){var r=t.markedSpans;if(r)for(var n=0;n<r.length;++n)null!=r[n].from&&e.push(r[n].marker)}),e},posFromIndex:function(e){var t,r=this.first;return this.iter(function(n){var l=n.text.length+1;if(l>e)return t=e,!0;e-=l,++r}),P(this,Fn(r,t))},indexFromPos:function(e){var t=(e=P(this,e)).ch;return e.line<this.first||e.ch<0?0:(this.iter(this.first,e.line,function(e){t+=e.text.length+1}),t)},copy:function(e){var t=new xl(dr(this,this.first,this.first+this.size),this.modeOption,this.first);return t.scrollTop=this.scrollTop,t.scrollLeft=this.scrollLeft,t.sel=this.sel,t.extend=!1,e&&(t.history.undoDepth=this.history.undoDepth,t.setHistory(this.getHistory())),t},linkedDoc:function(e){e||(e={});var t=this.first,r=this.first+this.size;null!=e.from&&e.from>t&&(t=e.from),null!=e.to&&e.to<r&&(r=e.to);var n=new xl(dr(this,t,r),e.mode||this.modeOption,t);return e.sharedHist&&(n.history=this.history),(this.linked||(this.linked=[])).push({doc:n,sharedHist:e.sharedHist}),n.linked=[{doc:this,isParent:!0,sharedHist:e.sharedHist}],n},unlinkDoc:function(t){if(t instanceof e&&(t=t.doc),this.linked)for(var r=0;r<this.linked.length;++r)if(this.linked[r].doc==t){this.linked.splice(r,1),t.unlinkDoc(this);break}if(t.history==this.history){var n=[t.id];ur(t,function(e){n.push(e.id)},!0),t.history=new wr(null),t.history.done=Er(this.history.done,n),t.history.undone=Er(this.history.undone,n)}},iterLinkedDocs:function(e){ur(this,e)},getMode:function(){return this.mode},getEditor:function(){return this.cm}}),xl.prototype.eachLine=xl.prototype.iter;var kl="iter insert remove copy getEditor".split(" ");for(var Cl in xl.prototype)xl.prototype.hasOwnProperty(Cl)&&qr(kl,Cl)<0&&(e.prototype[Cl]=function(e){return function(){return e.apply(this.doc,arguments)}}(xl.prototype[Cl]));Fr(xl);var Ml,Sl=e.e_preventDefault=function(e){e.preventDefault?e.preventDefault():e.returnValue=!1},El=e.e_stopPropagation=function(e){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0},Ll=e.e_stop=function(e){Sl(e),El(e)},Tl=e.on=function(e,t,r){if(e.addEventListener)e.addEventListener(t,r,!1);else if(e.attachEvent)e.attachEvent("on"+t,r);else{var n=e._handlers||(e._handlers={});(n[t]||(n[t]=[])).push(r)}},Il=e.off=function(e,t,r){if(e.removeEventListener)e.removeEventListener(t,r,!1);else if(e.detachEvent)e.detachEvent("on"+t,r);else{var n=e._handlers&&e._handlers[t];if(!n)return;for(var l=0;l<n.length;++l)if(n[l]==r){n.splice(l,1);break}}},Rl=e.signal=function(e,t){var r=e._handlers&&e._handlers[t];if(r)for(var n=Array.prototype.slice.call(arguments,2),l=0;l<r.length;++l)r[l].apply(null,n)},Ol=0,Al=30,Dl=e.Pass={toString:function(){return"CodeMirror.Pass"}},Nl={scroll:!1},Pl={origin:"*mouse"},Bl={origin:"+move"};jr.prototype.set=function(e,t){clearTimeout(this.id),this.id=setTimeout(t,e)};var Fl=e.countColumn=function(e,t,r,n,l){null==t&&-1==(t=e.search(/[^\s\u00a0]/))&&(t=e.length);for(var o=n||0,i=l||0;;){var a=e.indexOf("\t",o);if(a<0||a>=t)return i+(t-o);i+=a-o,i+=r-i%r,o=a+1}},jl=[""],Hl=function(e){e.select()};Tn?Hl=function(e){e.selectionStart=0,e.selectionEnd=e.value.length}:yn&&(Hl=function(e){try{e.select()}catch(e){}}),[].indexOf&&(qr=function(e,t){return e.indexOf(t)}),[].map&&(Gr=function(e,t){return e.map(t)});var Wl,zl=/[\u00df\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/,ql=e.isWordChar=function(e){return/\w/.test(e)||e>""&&(e.toUpperCase()!=e.toLowerCase()||zl.test(e))},Gl=/[\u0300-\u036f\u0483-\u0489\u0591-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u0610-\u061a\u064b-\u065e\u0670\u06d6-\u06dc\u06de-\u06e4\u06e7\u06e8\u06ea-\u06ed\u0711\u0730-\u074a\u07a6-\u07b0\u07eb-\u07f3\u0816-\u0819\u081b-\u0823\u0825-\u0827\u0829-\u082d\u0900-\u0902\u093c\u0941-\u0948\u094d\u0951-\u0955\u0962\u0963\u0981\u09bc\u09be\u09c1-\u09c4\u09cd\u09d7\u09e2\u09e3\u0a01\u0a02\u0a3c\u0a41\u0a42\u0a47\u0a48\u0a4b-\u0a4d\u0a51\u0a70\u0a71\u0a75\u0a81\u0a82\u0abc\u0ac1-\u0ac5\u0ac7\u0ac8\u0acd\u0ae2\u0ae3\u0b01\u0b3c\u0b3e\u0b3f\u0b41-\u0b44\u0b4d\u0b56\u0b57\u0b62\u0b63\u0b82\u0bbe\u0bc0\u0bcd\u0bd7\u0c3e-\u0c40\u0c46-\u0c48\u0c4a-\u0c4d\u0c55\u0c56\u0c62\u0c63\u0cbc\u0cbf\u0cc2\u0cc6\u0ccc\u0ccd\u0cd5\u0cd6\u0ce2\u0ce3\u0d3e\u0d41-\u0d44\u0d4d\u0d57\u0d62\u0d63\u0dca\u0dcf\u0dd2-\u0dd4\u0dd6\u0ddf\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0eb1\u0eb4-\u0eb9\u0ebb\u0ebc\u0ec8-\u0ecd\u0f18\u0f19\u0f35\u0f37\u0f39\u0f71-\u0f7e\u0f80-\u0f84\u0f86\u0f87\u0f90-\u0f97\u0f99-\u0fbc\u0fc6\u102d-\u1030\u1032-\u1037\u1039\u103a\u103d\u103e\u1058\u1059\u105e-\u1060\u1071-\u1074\u1082\u1085\u1086\u108d\u109d\u135f\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17b7-\u17bd\u17c6\u17c9-\u17d3\u17dd\u180b-\u180d\u18a9\u1920-\u1922\u1927\u1928\u1932\u1939-\u193b\u1a17\u1a18\u1a56\u1a58-\u1a5e\u1a60\u1a62\u1a65-\u1a6c\u1a73-\u1a7c\u1a7f\u1b00-\u1b03\u1b34\u1b36-\u1b3a\u1b3c\u1b42\u1b6b-\u1b73\u1b80\u1b81\u1ba2-\u1ba5\u1ba8\u1ba9\u1c2c-\u1c33\u1c36\u1c37\u1cd0-\u1cd2\u1cd4-\u1ce0\u1ce2-\u1ce8\u1ced\u1dc0-\u1de6\u1dfd-\u1dff\u200c\u200d\u20d0-\u20f0\u2cef-\u2cf1\u2de0-\u2dff\u302a-\u302f\u3099\u309a\ua66f-\ua672\ua67c\ua67d\ua6f0\ua6f1\ua802\ua806\ua80b\ua825\ua826\ua8c4\ua8e0-\ua8f1\ua926-\ua92d\ua947-\ua951\ua980-\ua982\ua9b3\ua9b6-\ua9b9\ua9bc\uaa29-\uaa2e\uaa31\uaa32\uaa35\uaa36\uaa43\uaa4c\uaab0\uaab2-\uaab4\uaab7\uaab8\uaabe\uaabf\uaac1\uabe5\uabe8\uabed\udc00-\udfff\ufb1e\ufe00-\ufe0f\ufe20-\ufe26\uff9e\uff9f]/;Wl=document.createRange?function(e,t,r){var n=document.createRange();return n.setEnd(e,r),n.setStart(e,t),n}:function(e,t,r){var n=document.body.createTextRange();return n.moveToElementText(e.parentNode),n.collapse(!0),n.moveEnd("character",r),n.moveStart("character",t),n},dn&&(en=function(){try{return document.activeElement}catch(e){return document.body}});var Vl,Ul,Jl,Yl=function(){if(vn)return!1;var e=Xr("div");return"draggable"in e||"dragDrop"in e}(),Kl=e.splitLines=3!="\n\nb".split(/\n/).length?function(e){for(var t=0,r=[],n=e.length;t<=n;){var l=e.indexOf("\n",t);-1==l&&(l=e.length);var o=e.slice(t,"\r"==e.charAt(l-1)?l-1:l),i=o.indexOf("\r");-1!=i?(r.push(o.slice(0,i)),t+=i+1):(r.push(o),t=l+1)}return r}:function(e){return e.split(/\r\n?|\n/)},Xl=window.getSelection?function(e){try{return e.selectionStart!=e.selectionEnd}catch(e){return!1}}:function(e){try{var t=e.ownerDocument.selection.createRange()}catch(e){}return!(!t||t.parentElement()!=e)&&0!=t.compareEndPoints("StartToEnd",t)},Ql=function(){var e=Xr("div");return"oncopy"in e||(e.setAttribute("oncopy","return;"),"function"==typeof e.oncopy)}(),Zl={3:"Enter",8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",44:"PrintScrn",45:"Insert",46:"Delete",59:";",61:"=",91:"Mod",92:"Mod",93:"Mod",107:"=",109:"-",127:"Delete",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",63232:"Up",63233:"Down",63234:"Left",63235:"Right",63272:"Delete",63273:"Home",63275:"End",63276:"PageUp",63277:"PageDown",63302:"Insert"};e.keyNames=Zl,function(){for(e=0;e<10;e++)Zl[e+48]=Zl[e+96]=String(e);for(e=65;e<=90;e++)Zl[e]=String.fromCharCode(e);for(var e=1;e<=12;e++)Zl[e+111]=Zl[e+63235]="F"+e}();var $l,eo=function(){function e(e){return e<=247?r.charAt(e):1424<=e&&e<=1524?"R":1536<=e&&e<=1773?n.charAt(e-1536):1774<=e&&e<=2220?"r":8192<=e&&e<=8203?"w":8204==e?"b":"L"}function t(e,t,r){this.level=e,this.from=t,this.to=r}var r="bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLN",n="rrrrrrrrrrrr,rNNmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmrrrrrrrnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmNmmmm",l=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/,o=/[stwN]/,i=/[LRr]/,a=/[Lb1n]/,s=/[1n]/;return function(r){if(!l.test(r))return!1;for(var n=r.length,c=[],u=0;u<n;++u)c.push(p=e(r.charCodeAt(u)));for(var u=0,h="L";u<n;++u)"m"==(p=c[u])?c[u]=h:h=p;for(var u=0,f="L";u<n;++u)"1"==(p=c[u])&&"r"==f?c[u]="n":i.test(p)&&(f=p,"r"==p&&(c[u]="R"));for(var u=1,h=c[0];u<n-1;++u)"+"==(p=c[u])&&"1"==h&&"1"==c[u+1]?c[u]="1":","!=p||h!=c[u+1]||"1"!=h&&"n"!=h||(c[u]=h),h=p;for(u=0;u<n;++u)if(","==(p=c[u]))c[u]="N";else if("%"==p){for(v=u+1;v<n&&"%"==c[v];++v);for(var g=u&&"!"==c[u-1]||v<n&&"1"==c[v]?"1":"N",d=u;d<v;++d)c[d]=g;u=v-1}for(var u=0,f="L";u<n;++u){var p=c[u];"L"==f&&"1"==p?c[u]="L":i.test(p)&&(f=p)}for(u=0;u<n;++u)if(o.test(c[u])){for(var v=u+1;v<n&&o.test(c[v]);++v);for(var m="L"==(u?c[u-1]:"L"),b="L"==(v<n?c[v]:"L"),g=m||b?"L":"R",d=u;d<v;++d)c[d]=g;u=v-1}for(var y,w=[],u=0;u<n;)if(a.test(c[u])){var _=u;for(++u;u<n&&a.test(c[u]);++u);w.push(new t(0,_,u))}else{var x=u,k=w.length;for(++u;u<n&&"L"!=c[u];++u);for(d=x;d<u;)if(s.test(c[d])){x<d&&w.splice(k,0,new t(1,x,d));var C=d;for(++d;d<u&&s.test(c[d]);++d);w.splice(k,0,new t(2,C,d)),x=d}else++d;x<u&&w.splice(k,0,new t(1,x,u))}return 1==w[0].level&&(y=r.match(/^\s+/))&&(w[0].from=y[0].length,w.unshift(new t(0,0,y[0].length))),1==zr(w).level&&(y=r.match(/\s+$/))&&(zr(w).to-=y[0].length,w.push(new t(0,n-y[0].length,n))),w[0].level!=zr(w).level&&w.push(new t(w[0].level,n,n)),w}}();return e.version="4.0.3",e}(),e.exports=t.default},function(e,t){Object.defineProperty(t,"__esModule",{value:!0});t.colorPalettesAliases={1:"mastersystem",2:"gameboycolour",3:"amiga",4:"arnecolors",5:"famicom",6:"atari",7:"pastel",8:"ega",9:"amstrad",10:"proteus_mellow",11:"proteus_rich",12:"proteus_night",13:"c64",14:"whitingjp"};t.reg_color=/(black|white|gray|darkgray|lightgray|grey|darkgrey|lightgrey|red|darkred|lightred|brown|darkbrown|lightbrown|orange|yellow|green|darkgreen|lightgreen|blue|lightblue|darkblue|purple|pink|transparent|#(?:[0-9a-f]{3}){1,2})\s*/,t.colorPalettes={mastersystem:{black:"#000000",white:"#FFFFFF",grey:"#555555",darkgrey:"#555500",lightgrey:"#AAAAAA",gray:"#555555",darkgray:"#555500",lightgray:"#AAAAAA",red:"#FF0000",darkred:"#AA0000",lightred:"#FF5555",brown:"#AA5500",darkbrown:"#550000",lightbrown:"#FFAA00",orange:"#FF5500",yellow:"#FFFF55",green:"#55AA00",darkgreen:"#005500",lightgreen:"#AAFF00",blue:"#5555AA",lightblue:"#AAFFFF",darkblue:"#000055",purple:"#550055",pink:"#FFAAFF"},gameboycolour:{black:"#000000",white:"#FFFFFF",grey:"#7F7F7C",darkgrey:"#3E3E44",lightgrey:"#BAA7A7",gray:"#7F7F7C",darkgray:"#3E3E44",lightgray:"#BAA7A7",red:"#A7120C",darkred:"#880606",lightred:"#BA381F",brown:"#57381F",darkbrown:"#3E2519",lightbrown:"#8E634B",orange:"#BA4B32",yellow:"#C0BA6F",green:"#517525",darkgreen:"#385D12",lightgreen:"#6F8E44",blue:"#5D6FA7",lightblue:"#8EA7A7",darkblue:"#4B575D",purple:"#3E3E44",pink:"#BA381F"},amiga:{black:"#000000",white:"#FFFFFF",grey:"#BBBBBB",darkgrey:"#333333",lightgrey:"#FFEEDD",gray:"#BBBBBB",darkgray:"#333333",lightgray:"#FFEEDD",red:"#DD1111",darkred:"#990000",lightred:"#FF4422",brown:"#663311",darkbrown:"#331100",lightbrown:"#AA6644",orange:"#FF6644",yellow:"#FFDD66",green:"#448811",darkgreen:"#335500",lightgreen:"#88BB77",blue:"#8899DD",lightblue:"#BBDDEE",darkblue:"#666688",purple:"#665555",pink:"#997788"},arnecolors:{black:"#000000",white:"#FFFFFF",grey:"#9d9d9d",darkgrey:"#697175",lightgrey:"#cccccc",gray:"#9d9d9d",darkgray:"#697175",lightgray:"#cccccc",red:"#be2633",darkred:"#732930",lightred:"#e06f8b",brown:"#a46422",darkbrown:"#493c2b",lightbrown:"#eeb62f",orange:"#eb8931",yellow:"#f7e26b",green:"#44891a",darkgreen:"#2f484e",lightgreen:"#a3ce27",blue:"#1d57f7",lightblue:"#B2DCEF",darkblue:"#1B2632",purple:"#342a97",pink:"#de65e2"},famicom:{black:"#000000",white:"#ffffff",grey:"#7c7c7c",darkgrey:"#080808",lightgrey:"#bcbcbc",gray:"#7c7c7c",darkgray:"#080808",lightgray:"#bcbcbc",red:"#f83800",darkred:"#881400",lightred:"#f87858",brown:"#AC7C00",darkbrown:"#503000",lightbrown:"#FCE0A8",orange:"#FCA044",yellow:"#F8B800",green:"#00B800",darkgreen:"#005800",lightgreen:"#B8F8B8",blue:"#0058F8",lightblue:"#3CBCFC",darkblue:"#0000BC",purple:"#6644FC",pink:"#F878F8"},atari:{black:"#000000",white:"#FFFFFF",grey:"#909090",darkgrey:"#404040",lightgrey:"#b0b0b0",gray:"#909090",darkgray:"#404040",lightgray:"#b0b0b0",red:"#A03C50",darkred:"#700014",lightred:"#DC849C",brown:"#805020",darkbrown:"#703400",lightbrown:"#CB9870",orange:"#CCAC70",yellow:"#ECD09C",green:"#58B06C",darkgreen:"#006414",lightgreen:"#70C484",blue:"#1C3C88",lightblue:"#6888C8",darkblue:"#000088",purple:"#3C0080",pink:"#B484DC"},pastel:{black:"#000000",white:"#FFFFFF",grey:"#3e3e3e",darkgrey:"#313131",lightgrey:"#9cbcbc",gray:"#3e3e3e",darkgray:"#313131",lightgray:"#9cbcbc",red:"#f56ca2",darkred:"#a63577",lightred:"#ffa9cf",brown:"#b58c53",darkbrown:"#787562",lightbrown:"#B58C53",orange:"#EB792D",yellow:"#FFe15F",green:"#00FF4F",darkgreen:"#2b732c",lightgreen:"#97c04f",blue:"#0f88d3",lightblue:"#00fffe",darkblue:"#293a7b",purple:"#ff6554",pink:"#eb792d"},ega:{black:"#000000",white:"#ffffff",grey:"#555555",darkgrey:"#555555",lightgrey:"#aaaaaa",gray:"#555555",darkgray:"#555555",lightgray:"#aaaaaa",red:"#ff5555",darkred:"#aa0000",lightred:"#ff55ff",brown:"#aa5500",darkbrown:"#aa5500",lightbrown:"#ffff55",orange:"#ff5555",yellow:"#ffff55",green:"#00aa00",darkgreen:"#00aaaa",lightgreen:"#55ff55",blue:"#5555ff",lightblue:"#55ffff",darkblue:"#0000aa",purple:"#aa00aa",pink:"#ff55ff"},proteus_mellow:{black:"#3d2d2e",white:"#ddf1fc",grey:"#9fb2d4",darkgrey:"#7b8272",lightgrey:"#a4bfda",gray:"#9fb2d4",darkgray:"#7b8272",lightgray:"#a4bfda",red:"#9d5443",darkred:"#8c5b4a",lightred:"#94614c",brown:"#89a78d",darkbrown:"#829e88",lightbrown:"#aaae97",orange:"#d1ba86",yellow:"#d6cda2",green:"#75ac8d",darkgreen:"#8fa67f",lightgreen:"#8eb682",blue:"#88a3ce",lightblue:"#a5adb0",darkblue:"#5c6b8c",purple:"#d39fac",pink:"#c8ac9e"},proteus_night:{black:"#010912",white:"#fdeeec",grey:"#051d40",darkgrey:"#091842",lightgrey:"#062151",gray:"#051d40",darkgray:"#091842",lightgray:"#062151",red:"#ad4576",darkred:"#934765",lightred:"#ab6290",brown:"#61646b",darkbrown:"#3d2d2d",lightbrown:"#8393a0",orange:"#0a2227",yellow:"#0a2541",green:"#75ac8d",darkgreen:"#0a2434",lightgreen:"#061f2e",blue:"#0b2c79",lightblue:"#809ccb",darkblue:"#08153b",purple:"#666a87",pink:"#754b4d"},proteus_rich:{black:"#6f686f",white:"#d1b1e2",grey:"#b9aac1",darkgrey:"#8e8b84",lightgrey:"#c7b5cd",gray:"#b9aac1",darkgray:"#8e8b84",lightgray:"#c7b5cd",red:"#a11f4f",darkred:"#934765",lightred:"#c998ad",brown:"#89867d",darkbrown:"#797f75",lightbrown:"#ab9997",orange:"#ce8c5c",yellow:"#f0d959",green:"#75bc54",darkgreen:"#599d79",lightgreen:"#90cf5c",blue:"#8fd0ec",lightblue:"#bcdce7",darkblue:"#0b2c70",purple:"#9b377f",pink:"#cd88e5"},amstrad:{black:"#000000",white:"#ffffff",grey:"#7f7f7f",darkgrey:"#636363",lightgrey:"#afafaf",gray:"#7f7f7f",darkgray:"#636363",lightgray:"#afafaf",red:"#ff0000",darkred:"#7f0000",lightred:"#ff7f7f",brown:"#ff7f00",darkbrown:"#7f7f00",lightbrown:"#ffff00",orange:"#ff007f",yellow:"#ffff7f",green:"#01ff00",darkgreen:"#007f00",lightgreen:"#7fff7f",blue:"#0000ff",lightblue:"#7f7fff",darkblue:"#00007f",purple:"#7f007f",pink:"#ff7fff"},c64:{black:"#000000",white:"#ffffff",grey:"#6C6C6C",darkgrey:"#444444",lightgrey:"#959595",gray:"#6C6C6C",darkgray:"#444444",lightgray:"#959595",red:"#68372B",darkred:"#3f1e17",lightred:"#9A6759",brown:"#433900",darkbrown:"#221c02",lightbrown:"#6d5c0d",orange:"#6F4F25",yellow:"#B8C76F",green:"#588D43",darkgreen:"#345129",lightgreen:"#9AD284",blue:"#6C5EB5",lightblue:"#70A4B2",darkblue:"#352879",purple:"#6F3D86",pink:"#b044ac"},whitingjp:{black:"#202527",white:"#eff8fd",grey:"#7b7680",darkgrey:"#3c3b44",lightgrey:"#bed0d7",gray:"#7b7680",darkgray:"#3c3b44",lightgray:"#bed0d7",red:"#bd194b",darkred:"#6b1334",lightred:"#ef2358",brown:"#b52e1c",darkbrown:"#681c12",lightbrown:"#e87b45",orange:"#ff8c10",yellow:"#fbd524",green:"#36bc3c",darkgreen:"#317610",lightgreen:"#8ce062",blue:"#3f62c6",lightblue:"#57bbe0",darkblue:"#2c2fa0",purple:"#7037d9",pink:"#ec2b8f"}}},function(e,t,r){function n(){var e={};return e.wave_type=g,e.p_env_attack=0,e.p_env_sustain=.3,e.p_env_punch=0,e.p_env_decay=.4,e.p_base_freq=.3,e.p_freq_limit=0,e.p_freq_ramp=0,e.p_freq_dramp=0,e.p_vib_strength=0,e.p_vib_speed=0,e.p_arp_mod=0,e.p_arp_speed=0,e.p_duty=0,e.p_duty_ramp=0,e.p_repeat_speed=0,e.p_pha_offset=0,e.p_pha_ramp=0,e.p_lpf_freq=1,e.p_lpf_ramp=0,e.p_lpf_resonance=0,e.p_hpf_freq=0,e.p_hpf_ramp=0,e.sound_vol=.5,e.sample_rate=44100,e.bit_depth=8,e}function l(e){return v?p.uniform()*e:Math.random()*e}function o(e){return v?Math.floor(p.uniform()*(e+1)):Math.floor(Math.random()*(e+1))}function i(e,t){this._buffer=a.createBuffer(1,e,t)}Object.defineProperty(t,"__esModule",{value:!0}),t.playSound=function(e){c.globals.unitTesting||function(e){if(e in y)return y[e];var t=b(e);t.sound_vol=u,t.sample_rate=h,t.bit_depth=f;var r=i.generate(t);for(y[e]=r,w.push(e);w.length>_;){var n=w[0];w=w.slice(1),delete y[n]}return r}(e).play()};var a,s=r(7),c=r(4),u=.25,h=5512,f=8,g=0,d=["square","sawtooth","sine","noise","triangle","breaker"];"undefined"!=typeof AudioContext?a=new AudioContext:"undefined"!=typeof webkitAudioContext&&(a=new webkitAudioContext);var p,v=!1,m=[function(){var e=n();if(e.wave_type=Math.floor(l(d.length)),3===e.wave_type&&(e.wave_type=0),e.p_base_freq=.4+l(.5),e.p_env_attack=0,e.p_env_sustain=l(.1),e.p_env_decay=.1+l(.4),e.p_env_punch=.3+l(.3),o(1)){e.p_arp_speed=.5+l(.2);var t=1+(1|l(7)),r=t+(1|l(7))+2;e.p_arp_mod=+t/+r}return e},function(){var e=n();return e.wave_type=o(2),2===e.wave_type&&o(1)&&(e.wave_type=o(1)),e.wave_type=Math.floor(l(d.length)),3===e.wave_type&&(e.wave_type=g),e.p_base_freq=.5+l(.5),e.p_freq_limit=e.p_base_freq-.2-l(.6),e.p_freq_limit<.2&&(e.p_freq_limit=.2),e.p_freq_ramp=-.15-l(.2),0===o(2)&&(e.p_base_freq=.3+l(.6),e.p_freq_limit=l(.1),e.p_freq_ramp=-.35-l(.3)),o(1)?(e.p_duty=l(.5),e.p_duty_ramp=l(.2)):(e.p_duty=.4+l(.5),e.p_duty_ramp=-l(.7)),e.p_env_attack=0,e.p_env_sustain=.1+l(.2),e.p_env_decay=l(.4),o(1)&&(e.p_env_punch=l(.3)),0===o(2)&&(e.p_pha_offset=l(.2),e.p_pha_ramp=-l(.2)),o(1)&&(e.p_hpf_freq=l(.3)),e},function(){var e=n();return o(1)?(e.p_base_freq=.1+l(.4),e.p_freq_ramp=-.1+l(.4)):(e.p_base_freq=.2+l(.7),e.p_freq_ramp=-.2-l(.2)),e.p_base_freq*=e.p_base_freq,0===o(4)&&(e.p_freq_ramp=0),0===o(2)&&(e.p_repeat_speed=.3+l(.5)),e.p_env_attack=0,e.p_env_sustain=.1+l(.3),e.p_env_decay=l(.5),0===o(1)&&(e.p_pha_offset=-.3+l(.9),e.p_pha_ramp=-l(.3)),e.p_env_punch=.2+l(.6),o(1)&&(e.p_vib_strength=l(.7),e.p_vib_speed=l(.6)),0===o(2)&&(e.p_arp_speed=.6+l(.3),e.p_arp_mod=.8-l(1.6)),e},function(){var e=n();return o(1)?e.wave_type=1:e.p_duty=l(.6),e.wave_type=Math.floor(l(d.length)),3===e.wave_type&&(e.wave_type=g),o(1)?(e.p_base_freq=.2+l(.3),e.p_freq_ramp=.1+l(.4),e.p_repeat_speed=.4+l(.4)):(e.p_base_freq=.2+l(.3),e.p_freq_ramp=.05+l(.2),o(1)&&(e.p_vib_strength=l(.7),e.p_vib_speed=l(.6))),e.p_env_attack=0,e.p_env_sustain=l(.4),e.p_env_decay=.1+l(.4),e},function(){var e=n();return e.wave_type=o(2),2===e.wave_type&&(e.wave_type=3),e.wave_type===g&&(e.p_duty=l(.6)),e.wave_type=Math.floor(l(d.length)),e.p_base_freq=.2+l(.6),e.p_freq_ramp=-.3-l(.4),e.p_env_attack=0,e.p_env_sustain=l(.1),e.p_env_decay=.1+l(.2),o(1)&&(e.p_hpf_freq=l(.3)),e},function(){var e=n();return e.wave_type=g,e.wave_type=Math.floor(l(d.length)),3===e.wave_type&&(e.wave_type=g),e.p_duty=l(.6),e.p_base_freq=.3+l(.3),e.p_freq_ramp=.1+l(.2),e.p_env_attack=0,e.p_env_sustain=.1+l(.3),e.p_env_decay=.1+l(.2),o(1)&&(e.p_hpf_freq=l(.3)),o(1)&&(e.p_lpf_freq=1-l(.6)),e},function(){var e=n();return e.wave_type=o(1),e.wave_type=Math.floor(l(d.length)),3===e.wave_type&&(e.wave_type=o(1)),e.wave_type===g&&(e.p_duty=l(.6)),e.p_base_freq=.2+l(.4),e.p_env_attack=0,e.p_env_sustain=.1+l(.1),e.p_env_decay=l(.2),e.p_hpf_freq=.1,e},function(){var e=n();return e.wave_type=Math.floor(l(d.length)),2===e.wave_type&&e.wave_type++,0===e.wave_type&&(e.wave_type=3),e.p_base_freq=.1+l(.4),e.p_freq_ramp=.05+l(.2),e.p_env_attack=.01+l(.09),e.p_env_sustain=.01+l(.09),e.p_env_decay=.01+l(.09),e.p_repeat_speed=.3+l(.5),e.p_pha_offset=-.3+l(.9),e.p_pha_ramp=-l(.3),e.p_arp_speed=.6+l(.3),e.p_arp_mod=.8-l(1.6),e},function(){var e=n();return e.wave_type=Math.floor(l(d.length)),e.p_base_freq=Math.pow(l(2)-1,2),o(1)&&(e.p_base_freq=Math.pow(l(2)-1,3)+.5),e.p_freq_limit=0,e.p_freq_ramp=Math.pow(l(2)-1,5),e.p_base_freq>.7&&e.p_freq_ramp>.2&&(e.p_freq_ramp=-e.p_freq_ramp),e.p_base_freq<.2&&e.p_freq_ramp<-.05&&(e.p_freq_ramp=-e.p_freq_ramp),e.p_freq_dramp=Math.pow(l(2)-1,3),e.p_duty=l(2)-1,e.p_duty_ramp=Math.pow(l(2)-1,3),e.p_vib_strength=Math.pow(l(2)-1,3),e.p_vib_speed=l(2)-1,e.p_env_attack=Math.pow(l(2)-1,3),e.p_env_sustain=Math.pow(l(2)-1,2),e.p_env_decay=l(2)-1,e.p_env_punch=Math.pow(l(.8),2),e.p_env_attack+e.p_env_sustain+e.p_env_decay<.2&&(e.p_env_sustain+=.2+l(.3),e.p_env_decay+=.2+l(.3)),e.p_lpf_resonance=l(2)-1,e.p_lpf_freq=1-Math.pow(l(1),3),e.p_lpf_ramp=Math.pow(l(2)-1,3),e.p_lpf_freq<.1&&e.p_lpf_ramp<-.05&&(e.p_lpf_ramp=-e.p_lpf_ramp),e.p_hpf_freq=Math.pow(l(1),5),e.p_hpf_ramp=Math.pow(l(2)-1,5),e.p_pha_offset=Math.pow(l(2)-1,3),e.p_pha_ramp=Math.pow(l(2)-1,3),e.p_repeat_speed=l(2)-1,e.p_arp_speed=l(2)-1,e.p_arp_mod=l(2)-1,e},function(){var e=n();return l(10)<1?(e.wave_type=Math.floor(l(d.length)),3===e.wave_type&&(e.wave_type=g),e.p_env_attack=.4304400932967592+l(.2)-.1,e.p_env_sustain=.15739346034252394+l(.2)-.1,e.p_env_punch=.004488201744871758+l(.2)-.1,e.p_env_decay=.07478075528212291+l(.2)-.1,e.p_base_freq=.9865265720147687+l(.2)-.1,e.p_freq_limit=0+l(.2)-.1,e.p_freq_ramp=-.2995018224359539+l(.2)-.1,l(1)<.5&&(e.p_freq_ramp=.1+l(.15)),e.p_freq_dramp=.004598608156964473+l(.1)-.05,e.p_vib_strength=-.2202799497929496+l(.2)-.1,e.p_vib_speed=.8084998703158364+l(.2)-.1,e.p_arp_mod=0,e.p_arp_speed=0,e.p_duty=-.9031808754347107+l(.2)-.1,e.p_duty_ramp=-.8128699999808343+l(.2)-.1,e.p_repeat_speed=.601486018931999+l(.2)-.1,e.p_pha_offset=-.9424902314367765+l(.2)-.1,e.p_pha_ramp=-.1055482222272056+l(.2)-.1,e.p_lpf_freq=.9989765717851521+l(.2)-.1,e.p_lpf_ramp=-.25051720626043017+l(.2)-.1,e.p_lpf_resonance=.32777871505494693+l(.2)-.1,e.p_hpf_freq=.0023548750981756753+l(.2)-.1,e.p_hpf_ramp=-.002375673204842568+l(.2)-.1,e):l(10)<1?(e.wave_type=Math.floor(l(d.length)),3===e.wave_type&&(e.wave_type=g),e.p_env_attack=.5277795946672003+l(.2)-.1,e.p_env_sustain=.18243733568468432+l(.2)-.1,e.p_env_punch=-.020159754546840117+l(.2)-.1,e.p_env_decay=.1561353422051903+l(.2)-.1,e.p_base_freq=.9028855606533718+l(.2)-.1,e.p_freq_limit=-.008842787837148716,e.p_freq_ramp=-.1,e.p_freq_dramp=-.012891241489551925,e.p_vib_strength=-.17923136138403065+l(.2)-.1,e.p_vib_speed=.908263385610142+l(.2)-.1,e.p_arp_mod=.41690153355414894+l(.2)-.1,e.p_arp_speed=.0010766233195860704+l(.2)-.1,e.p_duty=-.8735363011184684+l(.2)-.1,e.p_duty_ramp=-.7397985366747507+l(.2)-.1,e.p_repeat_speed=.0591789344172107+l(.2)-.1,e.p_pha_offset=-.9961184222777699+l(.2)-.1,e.p_pha_ramp=-.08234769395850523+l(.2)-.1,e.p_lpf_freq=.9412475115697335+l(.2)-.1,e.p_lpf_ramp=-.18261358925834958+l(.2)-.1,e.p_lpf_resonance=.24541438107389477+l(.2)-.1,e.p_hpf_freq=-.01831940280978611+l(.2)-.1,e.p_hpf_ramp=-.03857383633171346+l(.2)-.1,e):l(10)<1?(e.wave_type=Math.floor(l(d.length)),3===e.wave_type&&(e.wave_type=g),e.p_env_attack=.4304400932967592+l(.2)-.1,e.p_env_sustain=.15739346034252394+l(.2)-.1,e.p_env_punch=.004488201744871758+l(.2)-.1,e.p_env_decay=.07478075528212291+l(.2)-.1,e.p_base_freq=.9865265720147687+l(.2)-.1,e.p_freq_limit=0+l(.2)-.1,e.p_freq_ramp=-.2995018224359539+l(.2)-.1,e.p_freq_dramp=.004598608156964473+l(.2)-.1,e.p_vib_strength=-.2202799497929496+l(.2)-.1,e.p_vib_speed=.8084998703158364+l(.2)-.1,e.p_arp_mod=-.46410459213693644+l(.2)-.1,e.p_arp_speed=-.10955361249587248+l(.2)-.1,e.p_duty=-.9031808754347107+l(.2)-.1,e.p_duty_ramp=-.8128699999808343+l(.2)-.1,e.p_repeat_speed=.7014860189319991+l(.2)-.1,e.p_pha_offset=-.9424902314367765+l(.2)-.1,e.p_pha_ramp=-.1055482222272056+l(.2)-.1,e.p_lpf_freq=.9989765717851521+l(.2)-.1,e.p_lpf_ramp=-.25051720626043017+l(.2)-.1,e.p_lpf_resonance=.32777871505494693+l(.2)-.1,e.p_hpf_freq=.0023548750981756753+l(.2)-.1,e.p_hpf_ramp=-.002375673204842568+l(.2)-.1,e):l(5)>1?(e.wave_type=Math.floor(l(d.length)),3===e.wave_type&&(e.wave_type=g),o(1)?(e.p_arp_mod=.2697849293151393+l(.2)-.1,e.p_arp_speed=-.3131172257760948+l(.2)-.1,e.p_base_freq=.8090588299313949+l(.2)-.1,e.p_duty=-.6210022920964955+l(.2)-.1,e.p_duty_ramp=-.00043441813553182567+l(.2)-.1,e.p_env_attack=.004321877246874195+l(.2)-.1,e.p_env_decay=.1+l(.2)-.1,e.p_env_punch=.061737781504416146+l(.2)-.1,e.p_env_sustain=.4987252564798832+l(.2)-.1,e.p_freq_dramp=.31700340314222614+l(.2)-.1,e.p_freq_limit=0+l(.2)-.1,e.p_freq_ramp=-.163380391341416+l(.2)-.1,e.p_hpf_freq=.4709005021145149+l(.2)-.1,e.p_hpf_ramp=.6924667290539194+l(.2)-.1,e.p_lpf_freq=.8351398631384511+l(.2)-.1,e.p_lpf_ramp=.36616557192873134+l(.2)-.1,e.p_lpf_resonance=-.08685777111664439+l(.2)-.1,e.p_pha_offset=-.036084571580025544+l(.2)-.1,e.p_pha_ramp=-.014806445085568108+l(.2)-.1,e.p_repeat_speed=-.8094368475518489+l(.2)-.1,e.p_vib_speed=.4496665457171294+l(.2)-.1,e.p_vib_strength=.23413762515532424+l(.2)-.1):(e.p_arp_mod=-.35697118026766184+l(.2)-.1,e.p_arp_speed=.3581140690559588+l(.2)-.1,e.p_base_freq=1.3260897696157528+l(.2)-.1,e.p_duty=-.30984900436710694+l(.2)-.1,e.p_duty_ramp=-.0014374759133411626+l(.2)-.1,e.p_env_attack=.3160357835682254+l(.2)-.1,e.p_env_decay=.1+l(.2)-.1,e.p_env_punch=.24323114016870148+l(.2)-.1,e.p_env_sustain=.4+l(.2)-.1,e.p_freq_dramp=.2866475886237244+l(.2)-.1,e.p_freq_limit=0+l(.2)-.1,e.p_freq_ramp=-.10956352368742976+l(.2)-.1,e.p_hpf_freq=.20772718017889846+l(.2)-.1,e.p_hpf_ramp=.1564090637378835+l(.2)-.1,e.p_lpf_freq=.6021372770637031+l(.2)-.1,e.p_lpf_ramp=.24016227139979027+l(.2)-.1,e.p_lpf_resonance=-.08787383821160144+l(.2)-.1,e.p_pha_offset=-.381597686151701+l(.2)-.1,e.p_pha_ramp=-.0002481687661373495+l(.2)-.1,e.p_repeat_speed=.07812112809425686+l(.2)-.1,e.p_vib_speed=-.13648848579133943+l(.2)-.1,e.p_vib_strength=.0018874158972302657+l(.2)-.1),e):(e.wave_type=Math.floor(l(d.length)),1!==e.wave_type&&3!==e.wave_type||(e.wave_type=2),e.p_base_freq=.85+l(.15),e.p_freq_ramp=.3+l(.15),e.p_env_attack=0+l(.09),e.p_env_sustain=.2+l(.3),e.p_env_decay=0+l(.1),e.p_duty=l(2)-1,e.p_duty_ramp=Math.pow(l(2)-1,3),e.p_repeat_speed=.5+l(.1),e.p_pha_offset=-.3+l(.9),e.p_pha_ramp=-l(.3),e.p_arp_speed=.4+l(.6),e.p_arp_mod=.8+l(.1),e.p_lpf_resonance=l(2)-1,e.p_lpf_freq=1-Math.pow(l(1),3),e.p_lpf_ramp=Math.pow(l(2)-1,3),e.p_lpf_freq<.1&&e.p_lpf_ramp<-.05&&(e.p_lpf_ramp=-e.p_lpf_ramp),e.p_hpf_freq=Math.pow(l(1),5),e.p_hpf_ramp=Math.pow(l(2)-1,5),e)}],b=function(e){p=new s.RNG(e/100|0);v=!0;var t=(0,m[e%100%m.length])();return t.seed=e,v=!1,t};i.prototype.getBuffer=function(){return this._buffer.getChannelData(0)},i.prototype.play=function(){var e=a.createBufferSource(),t=a.createBiquadFilter(),r=a.createBiquadFilter(),n=a.createBiquadFilter();e.buffer=this._buffer,e.connect(t),t.frequency.value=1600,r.frequency.value=1600,n.frequency.value=1600,t.connect(r),r.connect(n),n.connect(a.destination);var l=a.currentTime;void 0!==e.start?e.start(l):e.noteOn(l)},i.MIN_SAMPLE_RATE=22050,void 0===a&&((i=function(e,t){this._sample_rate=t,this._buffer=new Array(e),this._audioElement=null}).prototype.getBuffer=function(){return this._audioElement=null,this._buffer},i.prototype.play=function(){if(this._audioElement)this._audioElement.cloneNode(!1).play();else{for(var e=0;e<this._buffer.length;e++)this._buffer[e]=255&Math.floor(128*Math.max(0,Math.min(this._buffer[e]+1,2)));var t=MakeRiff(this._sample_rate,f,this._buffer);this._audioElement=new Audio,this._audioElement.src=t.dataURI,this._audioElement.play()}},i.MIN_SAMPLE_RATE=1),i.generate=function(e){function t(){r=0,n=100/(e.p_base_freq*e.p_base_freq+.001),l=Math.floor(n),o=100/(e.p_freq_limit*e.p_freq_limit+.001),a=1-.01*Math.pow(e.p_freq_ramp,3),s=1e-6*-Math.pow(e.p_freq_dramp,3),c=.5-.5*e.p_duty,u=5e-5*-e.p_duty_ramp,h=e.p_arp_mod>=0?1-.9*Math.pow(e.p_arp_mod,2):1+10*Math.pow(e.p_arp_mod,2),f=0,d=Math.floor(2e4*Math.pow(1-e.p_arp_speed,2)+32),1==e.p_arp_speed&&(d=0)}var r,n,l,o,a,s,c,u,h,f,d;t();var p=0,v=0,m=.1*Math.pow(e.p_lpf_freq,3),b=1+1e-4*e.p_lpf_ramp,y=5/(1+20*Math.pow(e.p_lpf_resonance,2))*(.01+m);y>.8&&(y=.8);var w=0,_=.1*Math.pow(e.p_hpf_freq,2),x=1+3e-4*e.p_hpf_ramp,k=0,C=.01*Math.pow(e.p_vib_speed,2),M=.5*e.p_vib_strength,S=0,E=0,L=0,T=[Math.floor(e.p_env_attack*e.p_env_attack*1e5),Math.floor(e.p_env_sustain*e.p_env_sustain*1e5),Math.floor(e.p_env_decay*e.p_env_decay*1e5)],I=T[0]+T[1]+T[2],R=0,O=1020*Math.pow(e.p_pha_offset,2);e.p_pha_offset<0&&(O=-O);var A=1*Math.pow(e.p_pha_ramp,2);e.p_pha_ramp<0&&(A=-A);for(var D=Math.abs(Math.floor(O)),N=0,P=[],B=0;B<1024;++B)P[B]=0;for(var F=[],B=0;B<32;++B)F[B]=2*Math.random()-1;var j=Math.floor(2e4*Math.pow(1-e.p_repeat_speed,2)+32);0==e.p_repeat_speed&&(j=0);for(var H,W=2*e.sound_vol,W=Math.exp(e.sound_vol)-1,z=0,q=0,G=Math.floor(44100/e.sample_rate),V=0,U=Math.ceil(I/G),J=!1,Y=(H=e.sample_rate<i.MIN_SAMPLE_RATE?new i(4*U,i.MIN_SAMPLE_RATE):new i(U,e.sample_rate)).getBuffer(),K=0;;++K){0!=j&&++r>=j&&t(),0!=d&&K>=d&&(d=0,n*=h),(n*=a+=s)>o&&(n=o,e.p_freq_limit>0&&(J=!0));var X=n;M>0&&(k+=C,X=n*(1+Math.sin(k)*M)),(l=Math.floor(X))<8&&(l=8),(c+=u)<0&&(c=0),c>.5&&(c=.5),++L>T[E]&&(L=0,3===++E&&(J=!0)),S=0===E?L/T[0]:1===E?1+2*Math.pow(1-L/T[1],1)*e.p_env_punch:1-L/T[2],O+=A,(D=Math.abs(Math.floor(O)))>1023&&(D=1023),0!=x&&((_*=x)<1e-5&&(_=1e-5),_>.1&&(_=.1));for(var Q=0,Z=0;Z<8;++Z){var $=0;if(++R>=l&&(R%=l,3===e.wave_type))for(B=0;B<32;++B)F[B]=2*Math.random()-1;var ee=R/l;if(e.wave_type===g)$=ee<c?.5:-.5;else if(1===e.wave_type)$=1-2*ee;else if(2===e.wave_type)$=Math.sin(2*ee*Math.PI);else if(3===e.wave_type)$=F[Math.floor(32*R/l)];else if(4===e.wave_type)$=Math.abs(1-2*ee)-1;else{if(5!==e.wave_type)throw new Exception("bad wave type! "+e.wave_type);$=Math.abs(1-ee*ee*2)-1}var te=p;(m*=b)<0&&(m=0),m>.1&&(m=.1),1!=e.p_lpf_freq?(v+=($-p)*m,v-=v*y):(p=$,v=0),w+=(p+=v)-te,$=w-=w*_,P[1023&N]=$,$+=P[N-D+1024&1023],N=N+1&1023,Q+=$*S}if(z+=Q,++q>=G&&(q=0,Q=z/G,z=0,Q=Q/8*1,Q*=W,Y[V++]=Q,e.sample_rate<i.MIN_SAMPLE_RATE&&(Y[V++]=Q,Y[V++]=Q,Y[V++]=Q),J)){for(;V<U;V++)e.sample_rate<i.MIN_SAMPLE_RATE&&(Y[V++]=0,Y[V++]=0,Y[V++]=0),Y[V]=0;break}}return H};var y={},w=[],_=50},function(e,t,r){function n(e){return(e=e.trim())in ne.colorPalettes.arnecolors||!!/^#([0-9A-F]{3}){1,2}$/i.test(e)||"transparent"===e}function l(e,t){return(t=t.trim())in e?e[t]:t}function o(e){for(var t=[],r=0;r<e.length;r++){for(var n=[],l=0;l<e.length;l++){var o=e[r].charAt(l);"."==o?n.push(-1):n.push(o)}t.push(n)}return t}function i(e){0===e.collisionLayers.length&&logError("No collision layers defined.  All objects need to be in collision layers."),e.idDict={};for(var t=0,r=0;r<e.collisionLayers.length;r++)for(b=0;b<e.collisionLayers[r].length;b++){if((h=e.collisionLayers[r][b])in e.objects){(O=e.objects[h]).layer=r,O.id=t,e.idDict[t]=h,t++}}e.objectCount=t;for(var i=e.collisionLayers.length,a=[],s=0;s<i;s++)a.push(-1);Q.globals.STRIDE_OBJ=0|Math.ceil(e.objectCount/32),Q.globals.STRIDE_MOV=0|Math.ceil(i/5),e.STRIDE_OBJ=Q.globals.STRIDE_OBJ,e.STRIDE_MOV=Q.globals.STRIDE_MOV,K=!1,re.globals.verbose_logging=!1,re.globals.throttle_movement=!1,X=ne.colorPalettes.arnecolors;for(s=0;s<e.metadata.length;s+=2){var c=e.metadata[s],u=e.metadata[s+1];"color_palette"===c?(u in ne.colorPalettesAliases&&(u=ne.colorPalettesAliases[u]),void 0===ne.colorPalettes[u]?logError('Palette "'+u+'" not found, defaulting to arnecolors.',0):X=ne.colorPalettes[u]):"debug"===c?(K=!0,re.globals.cache_console_messages=!0):"GAME.verbose_logging"===c?(re.globals.verbose_logging=!0,re.globals.cache_console_messages=!0):"GAME.throttle_movement"===c&&(re.globals.throttle_movement=!0)}for(var h in e.objects)if(e.objects.hasOwnProperty(h)){(O=e.objects[h]).colors.length>10&&logError("a sprite cannot have more than 10 colors.  Why you would want more than 10 is beyond me.",O.lineNumber+1);for(s=0;s<O.colors.length;s++){var f=O.colors[s];n(f)?(f=l(X,f),O.colors[s]=f):(logError('Invalid color specified for object "'+h+'", namely "'+O.colors[s]+'".',O.lineNumber+1),O.colors[s]="#ff00ff")}}for(var h in e.objects)if(e.objects.hasOwnProperty(h)){0==(O=e.objects[h]).colors.length&&(logError('color not specified for object "'+h+'".',O.lineNumber),O.colors=["#ff00ff"]),0===O.spritematrix.length?O.spritematrix=[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]]:O.spritematrix=o(O.spritematrix)}var g={};for(var h in e.objects)if(e.objects.hasOwnProperty(h)){O=e.objects[h];(y=a.concat([]))[O.layer]=O.id,g[h]=y}for(var d=!0;d;){d=!1;for(s=0;s<e.legend_synonyms.length;s++){var c=(p=e.legend_synonyms[s])[0],u=p[1];c in g&&void 0!==g[c]||void 0===g[u]||(d=!0,g[c]=g[u])}for(s=0;s<e.legend_aggregates.length;s++){for(var p=e.legend_aggregates[s],c=p[0],v=p.slice(1),m=!0,b=0;b<v.length;b++){if(void 0===g[v[b]]){m=!1;break}}if((!(c in g)||void 0===g[c])&&m){for(var y=a.concat([]),b=1;b<p.length;b++){h=p[b];void 0==(O=e.objects[h])&&logError("Object not found with name "+h,e.lineNumber),-1==y[O.layer]?y[O.layer]=O.id:void 0===O.layer?logError('Object "'+h.toUpperCase()+'" has been defined, but not assigned to a layer.',p.lineNumber):logError('Trying to create an aggregate object (defined in the legend) with both "'+h.toUpperCase()+'" and "'+e.idDict[y[O.layer]].toUpperCase()+"\", which are on the same layer and therefore can't coexist.",p.lineNumber)}d=!0,g[p[0]]=y}}}e.glyphDict=g;for(var w={},s=0;s<e.legend_aggregates.length;s++){w[(k=e.legend_aggregates[s])[0]]=k.slice(1)}e.aggregatesDict=w;for(var _={},s=0;s<e.legend_properties.length;s++){_[(k=e.legend_properties[s])[0]]=k.slice(1)}e.propertiesDict=_;for(var x={},s=0;s<e.legend_synonyms.length;s++){var k=e.legend_synonyms[s],c=k[0];(E=k[1])in w?w[c]=w[E]:E in _?_[c]=_[E]:c!==E&&(x[c]=E)}e.synonymsDict=x;for(var C=!0;C;){C=!1;for(var h in x)if(x.hasOwnProperty(h)){(E=x[h])in _?(delete x[h],_[h]=_[E],C=!0):E in w?(delete w[h],w[h]=w[E],C=!0):E in x&&(x[h]=x[E])}for(var h in _)if(_.hasOwnProperty(h))for(var M=_[h],s=0;s<M.length;s++){if((E=M[s])in x)M[s]=x[E],C=!0;else if(E in _){M.splice(s,1);for(var S=_[E],b=0;b<S.length;b++){L=S[b];-1===M.indexOf(L)&&M.push(L)}C=!0}E in w&&logError('Trying to define property "'+h.toUpperCase()+'" in terms of aggregate "'+E.toUpperCase()+'".')}for(var h in w)if(w.hasOwnProperty(h))for(var M=w[h],s=0;s<M.length;s++){var E=M[s];if(E in x)M[s]=x[E],C=!0;else if(E in w){M.splice(s,1);for(var S=w[E],b=0;b<S.length;b++){var L=S[b];-1===M.indexOf(L)&&M.push(L)}C=!0}E in _&&logError('Trying to define aggregate "'+h.toUpperCase()+'" in terms of property "'+E.toUpperCase()+'".')}}e.propertiesSingleLayer={};for(var c in _)if(_.hasOwnProperty(c)){for(var M=_[c],T=!0,s=1;s<M.length;s++)if(e.objects[M[s-1]].layer!==e.objects[M[s]].layer){T=!1;break}T&&(e.propertiesSingleLayer[c]=e.objects[M[0]].layer)}void 0===e.idDict[0]&&e.collisionLayers.length>0&&logError("You need to have some objects defined");var I,R;if(void 0===e.objects.background)if("background"in e.synonymsDict){h=e.synonymsDict.background;I=(O=e.objects[h]).id,R=O.layer}else if("background"in e.propertiesDict){h=e.propertiesDict.background[0];I=(O=e.objects[h]).id,R=O.layer}else if("background"in e.aggregatesDict){I=(O=e.idDict[0]).id,R=O.layer,logError("background cannot be an aggregate (declared with 'and'), it has to be a simple type, or property (declared in terms of others using 'or').")}else{var O;I=(O=e.idDict[0]).id,R=O.layer,logError("you have to define something to be the background")}else I=e.objects.background.id,R=e.objects.background.layer;e.backgroundid=I,e.backgroundlayer=R}function a(e,t){var r=e.backgroundlayer,n=(e.backgroundid,e.layerMasks[r]),l=new Z.Level(t[0],t[1].length,t.length-1,e.collisionLayers.length,null);l.objects=new Int32Array(l.width*l.height*Q.globals.STRIDE_OBJ);for(f=0;f<l.width;f++)for(var o=0;o<l.height;o++){var i=t[o+1].charAt(f);0==i.length&&(i=t[o+1].charAt(t[o+1].length-1));var a=e.glyphDict[i];void 0==a&&(void 0===e.propertiesDict[i]?logError('Error, symbol "'+i+'", used in map, not found.',t[0]+o):logError('Error, symbol "'+i+"\" is defined using 'or', and therefore ambiguous - it cannot be used in a map. Did you mean to define it in terms of 'and'?",re.globals.level[0]+o));var s=new Z.BitVec(Q.globals.STRIDE_OBJ);a=a.concat([]);for(var c=0;c<l.layerCount;c++)a[c]>=0&&s.ibitset(a[c]);for(var u=0;u<Q.globals.STRIDE_OBJ;++u)l.objects[Q.globals.STRIDE_OBJ*(f*l.height+o)+u]=s.data[u]}for(var h=l.calcBackgroundMask(e),f=0;f<l.n_tiles;f++){var g=l.getCell(f);n.anyBitsInCommon(g)||g.ior(h),l.setCell(f,g)}return l}function s(e){for(var t=e.levels,r=[],n=0;n<t.length;n++){var l=t[n];if(0!=l.length)if("\n"==l[0]){o={message:l[1]};r.push(o)}else{var o=a(e,l);r.push(o)}}e.levels=r}function c(e){for(n=0;n<e.lhs.length;n++){if((l=e.lhs[n]).length>1)return!0;for(o=0;o<l.length;o++)for(var t=l[o],r=0;r<t.length;r+=2)if(ie.indexOf(t[r])>=0)return!0}for(var n=0;n<e.rhs.length;n++){var l=e.rhs[n];if(l.length>1)return!0;for(var o=0;o<l.length;o++)for(var t=l[o],r=0;r<t.length;r+=2)if(ie.indexOf(t[r])>=0)return!0}return!1}function u(e,t,r){var n=e[0],l=e[1],o=e[2],i=(n=n.replace(/\[/g," [ ").replace(/\]/g," ] ").replace(/\|/g," | ").replace(/\-\>/g," -> ")).split(/\s/).filter(function(e){return""!==e});0==i.length&&logError("Spooky error!  Empty line passed to rule function.",l);var a=0,s=[],u=null,h=[],f=!1,g=[],d=[],p=!1,v=!1,m=l,b=[],y=!1;if(1===i.length){if("startloop"===i[0])return x={bracket:1};if("endloop"===i[0])return x={bracket:-1}}-1==i.indexOf("->")&&logError("A rule has to have an arrow in it.  There's no arrow here! Consider reading up about rules - you're clearly doing something weird",l);for(k=0;k<i.length;k++){var w=i[k];switch(a){case 0:"+"===w?m===l?(0==r.length&&logError('The "+" symbol, for joining a rule with the group of the previous rule, needs a previous rule to be applied to.'),0!==k&&logError('The "+" symbol, for joining a rule with the group of the previous rule, must be the first symbol on the line '),m=r[r.length-1].groupNumber):logError('Two "+"s ("append to previous rule group" symbol)applied to the same rule.',l):w in oe?s=s.concat(oe[w]):"late"===w?p=!0:"rigid"===w?v=!0:"random"===w?y=!0:ae.indexOf(w)>=0?s.push(w):se.indexOf(w)>=0?logError('You cannot use relative directions ("^v<>") to indicate in which direction(s) a rule applies.  Use absolute directions indicators (Up, Down, Left, Right, Horizontal, or Vertical, for instance), or, if you want the rule to apply in all four directions, do not specify directions',l):"["==w?(0==s.length&&(s=s.concat(oe.orthogonal)),a=1,k--):logError("The start of a rule must consist of some number of directions (possibly 0), before the first bracket, specifying in what directions to look (with no direction specified, it applies in all four directions).  It seems you've just entered \""+w.toUpperCase()+'".',l);break;case 1:if("["==w)h.length>0&&logError('Error, malformed cell rule - encountered a "["" before previous bracket was closed',l),u=[];else if(ce.exec(w))u.length%2==1?logError("Error, an item can't move in multiple directions.",l):u.push(w);else if("|"==w)u.length%2==1?logError("In a rule, if you specify a force, it has to act on an object.",l):(h.push(u),u=[]);else if("]"===w)u.length%2==1?"..."===u[0]?logError("Cannot end a rule with ellipses.",l):logError("In a rule, if you specify a force, it has to act on an object.",l):(h.push(u),u=[]),f?d.push(h):g.push(h),h=[];else if("->"===w)f&&logError('Error, you can only use "->" once in a rule; it\'s used to separate before and after states.',l),h.length>0?logError('Encountered an unexpected "->" inside square brackets.  It\'s used to separate states, it has no place inside them >:| .',l):f=!0;else if(t.names.indexOf(w)>=0)u.length%2==0?(u.push(""),u.push(w)):u.length%2==1&&u.push(w);else if("..."===w)u.push(w),u.push(w);else if(ue.indexOf(w)>=0)if(!1===f&&logError("Commands cannot appear on the left-hand side of the arrow.",l),"message"===w){var _=o.match(/message (.*)/i);null===_?logError("invalid message string",l):(b.push([w,_[1].trim()]),k=i.length)}else b.push([w]);else logError('Error, malformed cell rule - was looking for cell contents, but found "'+w+'".  What am I supposed to do with this, eh, please tell me that.',l)}}if(g.length!=d.length)b.length>0&&0==d.length||logError("Error, when specifying a rule, the number of matches (square bracketed bits) on the left hand side of the arrow must equal the number on the right",l);else for(k=0;k<g.length;k++)g[k].length!=d[k].length&&logError("In a rule, each pattern to match on the left must have a corresponding pattern on the right of equal length (number of cells).",l),0==g[k].length&&logError("You have an totally empty pattern on the left-hand side.  This will match *everything*.  You certianly don't want this.");0==g.length&&logError("This rule refers to nothing.  What the heck? :O",l);var x={directions:s,lhs:g,rhs:d,lineNumber:l,late:p,rigid:v,groupNumber:m,commands:b,randomRule:y};!1===c(x)&&(x.directions=["up"]);for(var k=0;k<b.length;k++){var C=b[k][0];"restart"===C?(b.length>1||d.length>0)&&logError("The RESTART command can only appear by itself on the right hand side of the arrow.",l):"cancel"===C&&(b.length>1||d.length>0)&&logError("The CANCEL command can only appear by itself on the right hand side of the arrow.",l)}return x}function h(e){return e.map(function(e){return e.map(function(e){return e.slice()})})}function f(e){return{direction:e.direction,lhs:h(e.lhs),rhs:h(e.rhs),lineNumber:e.lineNumber,late:e.late,rigid:e.rigid,groupNumber:e.groupNumber,commands:e.commands,randomRule:e.randomRule}}function g(e){for(var t=e.rules,r=[],n=[],l=0;l<t.length;l++){var o=t[l][1],i=u(t[l],e,r);void 0===i.bracket?r.push(i):n.push([o,i.bracket])}e.loops=n;for(var a=[],l=0;l<r.length;l++)for(var s=(w=r[l]).directions,h=0;h<s.length;h++){var g=s[h];if(g in oe&&c(w))for(var d=oe[g],v=0;v<d.length;v++){(m=f(w)).direction=d[v],a.push(m)}else{var m=f(w);m.direction=g,a.push(m)}}for(l=0;l<a.length;l++){E(w=a[l]),p(w),M(e,w),C(e,w)}for(var b=[],l=0;l<a.length;l++){w=a[l];b=b.concat(k(e,w,w.lineNumber))}for(var y=[],l=0;l<b.length;l++){var w=b[l];y=y.concat(x(e,w,w.lineNumber))}e.rules=y}function d(e){for(var t=0;t<e.lhs.length;t++)for(var r=0;r<e.lhs[t].length;r++)if("..."===e.lhs[t][r][1])return!0;return!1}function p(e){if(!d(e)){if("up"==e.direction)e.direction="down";else{if("left"!=e.direction)return;e.direction="right"}for(var t=0;t<e.lhs.length;t++)e.lhs[t].reverse(),e.rhs.length>0&&e.rhs[t].reverse()}}function v(e,t){for(var r=[],n=0;n<t.length;n+=2){var l=t[n],o=t[n+1];"random"!=l&&(o in e.propertiesDict&&r.push(o))}return r}function m(e,t){for(var r=[],n=0;n<t.length;n+=2){var l=t[n],o=t[n+1];l in oe&&r.push([o,l])}return r}function b(e,t,r){for(var n=0;n<e.length;n+=2)e[n+1]===t&&"random"!==e[n]&&(e[n+1]=r)}function y(e,t,r,n){for(var l=0;l<e.length;l+=2)e[l]===t&&e[l+1]===r&&(e[l]=n)}function w(e,t,r){for(var n=0;n<e.length;n+=2)e[n]===t&&(e[n]=r)}function _(e,t){for(var r=[],n=0;n<t.length;n+=2){var l=t[n],o=t[n+1];if("no"===l&&o in e.propertiesDict)for(var i=e.propertiesDict[o],a=0;a<i.length;a++){var s=i[a];r.push(l),r.push(s)}else r.push(l),r.push(o)}return r}function x(e,t,r){for(R=0;R<t.lhs.length;R++)for(var n=t.lhs[R],l=0;l<n.length;l++)n[l]=_(e,n[l]),t.rhs.length>0&&(t.rhs[R][l]=_(e,t.rhs[R][l]));for(var o={},l=0;l<t.rhs.length;l++)for(var i=t.lhs[l],a=t.rhs[l],s=0;s<a.length;s++)for(var c=v(e,i[s]),u=v(e,a[s]),h=0;h<u.length;h++){E=u[h];-1==c.indexOf(E)&&(o[E]=!0)}for(var g,d=[t],p=!0;p;){p=!1;for(R=0;R<d.length;R++){O=d[R];g=!1;for(l=0;l<O.lhs.length&&!g;l++)for(var m=O.lhs[l],s=0;s<m.length&&!g;s++)for(var y=v(e,A=m[s]),h=0;h<y.length;++h){E=y[h];if(!e.propertiesSingleLayer.hasOwnProperty(E)||!0===o[E]){var w=e.propertiesDict[E];g=!0,p=!0;for(var x=0;x<w.length;x++){var k=w[x],C=f(O);C.propertyReplacement={};for(var M in O.propertyReplacement)if(O.propertyReplacement.hasOwnProperty(M)){var S=O.propertyReplacement[M];C.propertyReplacement[M]=[S[0],S[1]]}b(C.lhs[l][s],E,k),C.rhs.length>0&&b(C.rhs[l][s],E,k),void 0===C.propertyReplacement[E]?C.propertyReplacement[E]=[k,1]:C.propertyReplacement[E][1]=C.propertyReplacement[E][1]+1,d.push(C)}break}}g&&(d.splice(R,1),R--)}}for(R=0;R<d.length;R++){if(void 0!==(O=d[R]).propertyReplacement)for(var E in O.propertyReplacement)if(O.propertyReplacement.hasOwnProperty(E)){var L=O.propertyReplacement[E],k=L[0];if(1===L[1])for(l=0;l<O.rhs.length;l++)for(var T=O.rhs[l],s=0;s<T.length;s++){b(T[s],E,k)}}}for(var I="",R=0;R<d.length;R++){var O=d[R];delete d.propertyReplacement;for(l=0;l<O.rhs.length;l++)for(var m=O.rhs[l],s=0;s<m.length;s++)for(var A=m[s],y=v(e,A),h=0;h<y.length;h++)o.hasOwnProperty(y[h])&&(I=y[h])}return I.length>0&&logError('This rule has a property on the right-hand side, "'+I+"\", that can't be inferred from the left-hand side.  (either for every property on the right there has to be a corresponding one on the left in the same cell, OR, if there's a single occurrence of a particular property name on the left, all properties of the same name on the right are assumed to be the same).",r),d}function k(e,t,r){for(var n,l=[t],o=!0;o;){o=!1;for(L=0;L<l.length;L++){T=l[L];n=!1;for(I=0;I<T.lhs.length;I++)for(var i=T.lhs[I],a=0;a<i.length;a++){if((O=m(0,R=i[a])).length>0){n=!0,o=!0;for(var s=O[0][0],c=O[0][1],u=oe[c],h=0;h<u.length;h++){var g=u[h],d=f(T);d.movingReplacement={};for(var p in T.movingReplacement)if(T.movingReplacement.hasOwnProperty(p)){var v=T.movingReplacement[p];d.movingReplacement[p]=[v[0],v[1],v[3]]}y(d.lhs[I][a],c,s,g),d.rhs.length>0&&y(d.rhs[I][a],c,s,g),void 0===d.movingReplacement[s]?d.movingReplacement[s]=[g,1,c]:d.movingReplacement[s][1]=d.movingReplacement[s][1]+1,l.push(d)}}}n&&(l.splice(L,1),L--)}}for(L=0;L<l.length;L++){if(void 0!==(T=l[L]).movingReplacement){var b={};for(var s in T.movingReplacement)if(T.movingReplacement.hasOwnProperty(s)){var _=T.movingReplacement[s],x=_[0],k=_[1];if(b[M=_[2]]=M in b||1!==k?"INVALID":x,1===k)for(I=0;I<T.rhs.length;I++)for(var C=T.rhs[I],a=0;a<C.length;a++){y(S=C[a],M,s,x)}}for(var M in b)if(b.hasOwnProperty(M)&&"INVALID"!==M){x=b[M];for(I=0;I<T.rhs.length;I++)for(var C=T.rhs[I],a=0;a<C.length;a++){var S=C[a];w(S,M,x)}}}}for(var E="",L=0;L<l.length;L++){var T=l[L];delete l.movingReplacement;for(var I=0;I<T.rhs.length;I++)for(var i=T.rhs[I],a=0;a<i.length;a++){var R=i[a],O=m(0,R);O.length>0&&(E=O[0][1])}}return E.length>0&&logError('This rule has an ambiguous movement on the right-hand side, "'+E+"\", that can't be inferred from the left-hand side.  (either for every ambiguous movement associated to an entity on the right there has to be a corresponding one on the left attached to the same entity, OR, if there's a single occurrence of a particular ambiguous movement on the left, all properties of the same movement attached to the same object on the right are assumed to be the same (or something like that)).",r),l}function C(e,t){for(var r=0;r<t.lhs.length;r++)for(var n=t.lhs[r],l=t.rhs[r],o=0;o<n.length;o++){for(var i=n[o],a=1;a<i.length;a+=2){(c=i[a])in e.synonymsDict&&(i[a]=e.synonymsDict[i[a]])}if(t.rhs.length>0)for(var s=l[o],a=1;a<s.length;a+=2){var c=s[a];c in e.synonymsDict&&(s[a]=e.synonymsDict[s[a]])}}}function M(e,t){for(l=0;l<t.lhs.length;l++)for(var r=t.lhs[l],n=0;n<r.length;n++){S(e,o=r[n],t.lineNumber)}for(var l=0;l<t.rhs.length;l++)for(var r=t.rhs[l],n=0;n<r.length;n++){var o=r[n];S(e,o,t.lineNumber)}}function S(e,t,r){for(var n=0;n<t.length;n+=2){var l=t[n],o=t[n+1];if(o in e.aggregatesDict){"no"===l&&logError("You cannot use 'no' to exclude the aggregate object "+o.toUpperCase()+" (defined using 'AND'), only regular objects, or properties (objects defined using 'OR').  If you want to do this, you'll have to write it out yourself the long way.",r);var i=e.aggregatesDict[o];t[n+1]=i[0];for(var a=1;a<i.length;a++)t.push(t[n]),t.push(i[a])}}}function E(e){for(var t=e.direction,r=0;r<e.lhs.length;r++)for(var n=e.lhs[r],l=0;l<n.length;l++){L(t,o=n[l])}for(r=0;r<e.rhs.length;r++)for(var n=e.rhs[r],l=0;l<n.length;l++){var o=n[l];L(t,o)}}function L(e,t){for(var r=0;r<t.length;r+=2){var n=t[r],l=he.indexOf(n);l>=0&&(t[r]=fe[e][l])}}function T(e){for(var t=e.collisionLayers.length,r=[],n=0;n<t;n++)r.push(null);for(n=0;n<e.rules.length;n++)for(var l=e.rules[n],o=0;o<l.lhs.length;o++)for(var i=l.lhs[o],a=l.rhs[o],s=0;s<i.length;s++){for(var c=i[s],u=r.concat([]),h=new Z.BitVec(Q.globals.STRIDE_OBJ),f=new Z.BitVec(Q.globals.STRIDE_OBJ),g=[],d=new Z.BitVec(Q.globals.STRIDE_MOV),p=new Z.BitVec(Q.globals.STRIDE_MOV),v=new Z.BitVec(Q.globals.STRIDE_MOV),m=0;m<c.length;m+=2){if("..."===(A=c[m])){if(h=Z.ellipsisPattern,2!==c.length)logError("You can't have anything in with an ellipsis. Sorry.",l.lineNumber);else if(0===s||s===i.length-1)logError("There's no point in putting an ellipsis at the very start or the end of a rule",l.lineNumber);else if(l.rhs.length>0){2===(_=a[s]).length&&"..."===_[0]||logError("An ellipsis on the left must be matched by one in the corresponding place on the right.",l.lineNumber)}break}if("random"!==A){var b=c[m+1],y=e.objects[b],w=e.objectMasks[b];if(y)D=0|y.layer;else D=e.propertiesSingleLayer[b];if(void 0===D&&logError("Oops!  "+b.toUpperCase()+" not assigned to a layer.",l.lineNumber),"no"===A)f.ior(w);else{null!==(N=u[D])&&logError("Rule matches object types that can't overlap: \""+b.toUpperCase()+'" and "'+N.toUpperCase()+'".',l.lineNumber),u[D]=b,y?(h.ior(w),v.ishiftor(31,5*D)):g.push(w),"stationary"===A?p.ishiftor(31,5*D):d.ishiftor(ge[A],5*D)}}else logError("'random' cannot be matched on the left-hand side, it can only appear on the right",l.lineNumber)}if(l.rhs.length>0){var _=a[s],x=i[s];"..."===_[0]&&"..."!==x[0]&&logError("An ellipsis on the right must be matched by one in the corresponding place on the left.",l.lineNumber);for(m=0;m<_.length;m+=2){"..."===_[m]&&2!==_.length&&logError("You can't have anything in with an ellipsis. Sorry.",l.lineNumber)}}if(h!==Z.ellipsisPattern){if(i[s]=new Z.CellPattern([h,f,g,d,p,null]),0!==l.rhs.length){for(var k=a[s],C=r.concat([]),M=new Z.BitVec(Q.globals.STRIDE_OBJ),S=new Z.BitVec(Q.globals.STRIDE_OBJ),E=new Z.BitVec(Q.globals.STRIDE_MOV),L=new Z.BitVec(Q.globals.STRIDE_MOV),T=new Z.BitVec(Q.globals.STRIDE_MOV),I=new Z.BitVec(Q.globals.STRIDE_OBJ),R=new Z.BitVec(Q.globals.STRIDE_MOV),O=new Z.BitVec(Q.globals.STRIDE_MOV),m=0;m<k.length;m+=2){var A=k[m],b=k[m+1];if("..."===A){logError("spooky ellipsis found! (should never hit this)");break}if("random"!==A){var y=e.objects[b],w=e.objectMasks[b];if(y)D=0|y.layer;else var D=e.propertiesSingleLayer[b];if("no"==A)M.ior(w);else{var N=C[D];null!==N&&logError("Rule matches object types that can't overlap: \""+b.toUpperCase()+'" and "'+N.toUpperCase()+'".',l.lineNumber),C[D]=b,A.length>0&&R.ishiftor(31,5*D);var P=e.layerMasks[D];y&&(S.ibitset(y.id),M.ior(P),T.ishiftor(31,5*D)),"stationary"===A&&E.ishiftor(31,5*D),"randomdir"===A?O.ishiftor(ge[A],5*D):L.ishiftor(ge[A],5*D)}}else if(b in e.objectMasks){var B=e.objectMasks[b];I.ior(B)}else logError('You want to spawn a random "'+b.toUpperCase()+"\", but I don't know how to do that",l.lineNumber)}h.bitsSetInArray(S.data)||M.ior(h),d.bitsSetInArray(L.data)||E.ior(d);for(m=0;m<t;m++)null!==u[m]&&null===C[m]&&(M.ior(e.layerMasks[m]),R.ishiftor(31,5*m));v.iclear(T),R.ior(v),(M||S||E||L||R)&&(i[s].replacement=new Z.CellReplacement([M,S,E,L,R,I,O]))}}else i[s]=Z.ellipsisPattern}}function I(e){for(var t=[],r=e[1],n=0;n<r.length;n++){for(var l=r[n],o=new Z.BitVec(Q.globals.STRIDE_OBJ),i=0;i<l.length;i++)l[i]!==Z.ellipsisPattern&&o.ior(l[i].objectsPresent);t.push(o)}return t}function R(e){for(var t=0;t<e.length;t++)for(var r=e[t],n=0;n<r.length;n++){for(var l=r[n],o=[0,[],l.rhs.length>0,l.lineNumber],i=[],a=0;a<l.lhs.length;a++)i.push(!1);o[0]=ge[l.direction];for(a=0;a<l.lhs.length;a++){for(var s=l.lhs[a],c=0;c<s.length;c++)s[c]===Z.ellipsisPattern&&(i[a]&&logError("You can't use two ellipses in a single cell match pattern.  If you really want to, please implement it yourself and send me a patch :) ",l.lineNumber),i[a]=!0);o[1][a]=s}o.push(i),o.push(l.groupNumber),o.push(l.rigid),o.push(l.commands),o.push(l.randomRule),o.push(I(o)),r[n]=new Z.Rule(o)}Q.globals.matchCache={}}function O(e){if(0!==e.length)for(var t=e[0].lineNumber,r=1;r<e.length;r++){var n=e[r];n.lineNumber!==t&&(n.randomRule&&logError("A rule-group can only be marked random by the first rule",n.lineNumber))}}function A(e){for(var t={},r={},n=0;n<e.rules.length;n++){var l=e.rules[n],o=t;l.late&&(o=r),void 0==o[l.groupNumber]&&(o[l.groupNumber]=[]),o[l.groupNumber].push(l)}var i=[];for(var a in t)if(t.hasOwnProperty(a)){O(c=t[a]),i.push(c)}var s=[];for(var a in r)if(r.hasOwnProperty(a)){var c=r[a];O(c),s.push(c)}e.rules=i,e.lateRules=s}function D(e){for(var t=0;t<e.lateRules.length;t++)for(var r=e.lateRules[t],n=0;n<r.length;n++)for(var l=r[n],o=0;o<l.patterns.length;o++)for(var i=l.patterns[o],a=0;a<i.length;a++){var s=i[a];if(s!==Z.ellipsisPattern){var c=s.movementsMissing,u=s.movementsPresent;if(!c.iszero()||!u.iszero())return void logError("Movements cannot appear in late rules.",l.lineNumber);if(null!=s.replacement){var h=s.replacement.movementsClear,f=s.replacement.movementsSet;if(!h.iszero()||!f.iszero())return void logError("Movements cannot appear in late rules.",l.lineNumber)}}}}function N(e){for(var t=[],r=[],n=[],l=[],o=[],i=0;i<e.rules.length;i++){for(var a=e.rules[i],s=!1,c=0;c<a.length;c++){a[c].isRigid&&(s=!0)}if(o[i]=s,s){var u=a[0].groupNumber;n[u]=i;var h=t.length;r[i]=h,l[u]=h,t.push(i)}}t.length>30&&logError("There can't be more than 30 rigid groups (rule groups containing rigid members).",rules[0][0][3]),e.rigidGroups=o,e.rigidGroupIndex_to_GroupIndex=t,e.groupNumber_to_RigidGroupIndex=l,e.groupIndex_to_RigidGroupIndex=r}function P(e,t){var r=new Z.BitVec(Q.globals.STRIDE_OBJ);if(t in e.objects){i=e.objects[t];r.ibitset(i.id)}if(t in e.aggregatesDict)for(var n=e.aggregatesDict[t],l=0;l<n.length;l++){var o=n[l],i=e.objects[o];r.ibitset(i.id)}if(t in e.propertiesDict)for(var n=e.propertiesDict[t],l=0;l<n.length;l++){var o=n[l],i=e.objects[o];r.ibitset(i.id)}if(t in e.synonymsDict){var o=e.synonymsDict[t],i=e.objects[o];r.ibitset(i.id)}return r.iszero()&&logErrorNoLine("error, didn't find any object called player, either in the objects section, or the legends section. there must be a player!"),r}function B(e){e.playerMask=P(e,"player");for(var t=[],r=e.collisionLayers.length,n=0;n<r;n++){for(var l=new Z.BitVec(Q.globals.STRIDE_OBJ),o=0;o<e.objectCount;o++){a=e.idDict[o];(s=e.objects[a]).layer==n&&l.ibitset(s.id)}t.push(l)}e.layerMasks=t;var i={};for(var a in e.objects)if(e.objects.hasOwnProperty(a)){var s=e.objects[a];i[a]=new Z.BitVec(Q.globals.STRIDE_OBJ),i[a].ibitset(s.id)}var c=e.legend_synonyms.concat(e.legend_properties);c.sort(function(e,t){return e.lineNumber-t.lineNumber});for(var u=0;u<c.length;u++){var h=c[u];if(2==h.length)i[h[0]]=i[h[1]];else{for(var f=new Z.BitVec(Q.globals.STRIDE_OBJ),o=1;o<h.length;o++){a=h[o];f.ior(i[a])}i[h[0]]=f}}e.objectMasks=i}function F(e){for(var t in e.objects)if(e.objects.hasOwnProperty(t)){for(var r=!1,n=0;n<e.collisionLayers.length;n++){for(var l=e.collisionLayers[n],o=0;o<l.length;o++)if(l[o]===t){r=!0;break}if(r)break}if(!1===r){var i=e.objects[t];logError('Object "'+t.toUpperCase()+'" has been defined, but not assigned to a layer.',i.lineNumber)}}}function j(e){for(var t={},r=0;r<e.metadata.length;r+=2){var n=e.metadata[r],l=e.metadata[r+1];t[n]=l}if(void 0!==t.flickscreen){var o=(l=t.flickscreen).split("x"),i=[parseInt(o[0]),parseInt(o[1])];t.flickscreen=i}if(void 0!==t.zoomscreen){var o=(l=t.zoomscreen).split("x"),i=[parseInt(o[0]),parseInt(o[1])];t.zoomscreen=i}e.metadata=t}function H(e){for(var t=[],r=0;r<e.winconditions.length;r++){var n=e.winconditions[r];if(0==n.length)return;var l=0;switch(n[0]){case"no":l=-1;break;case"all":l=1}var o,i=n[n.length-1],a=n[1];o=5==n.length?n[3]:"background";var s=0,c=0;a in e.objectMasks?s=e.objectMasks[a]:logError('unwelcome term "'+a+'" found in win condition. Win conditions objects have to be objects or properties (defined using "or", in terms of other properties)',i),o in e.objectMasks?c=e.objectMasks[o]:logError('unwelcome term "'+o+'" found in win condition. Win conditions objects have to be objects or properties (defined using "or", in terms of other properties)',i);var u=[l,s,c,i];t.push(u)}e.winconditions=t}function W(e){for(var t="[ ",r=0;r<e.length;r++){r>0&&(t+="| ");for(var n=e[r],l=0;l<n.length;l+=2){var o=n[l],i=n[l+1];t+="..."===o?o+" ":o+" "+i+" "}}return t+="] "}function z(e){var t="(<a onclick=\"jumpToLine('"+e.lineNumber.toString()+'\');"  href="javascript:void(0);">'+e.groupNumber+"</a>) "+e.direction.toString().toUpperCase()+" ";e.rigid&&(t="RIGID "+t+" "),e.randomRule&&(t="RANDOM "+t+" "),e.late&&(t="LATE "+t+" ");for(n=0;n<e.lhs.length;n++){t+=W(r=e.lhs[n])}t+="-> ";for(n=0;n<e.rhs.length;n++){var r=e.rhs[n];t+=W(r)}for(var n=0;n<e.commands.length;n++){var l=e.commands[n];1===l.length?t+=l[0].toString():t=t+"("+l[0].toString()+", "+l[1].toString()+") "}return t}function q(e){console.log("rule count before = "+e.rules.length);for(var t={},r=-1,n=e.rules.length-1;n>=0;n--){var l=e.rules[n],o=l.groupNumber;o!==r&&(t={});var i=z(l);t.hasOwnProperty(i)?e.rules.splice(n,1):t[i]=!0,r=o}console.log("rule count after = "+e.rules.length)}function G(e){var t={},r=!0,n=0;e.loops.length%2==1&&logErrorNoLine("have to have matching number of  'startLoop' and 'endLoop' loop points.");for(c=0;c<e.loops.length;c++)for(var l=e.loops[c],o=0;o<e.rules.length;o++){var i=(u=e.rules[o])[0],a=u[u.length-1],s=i.lineNumber;a.lineNumber;if(r){if(s>=l[0]){n=o,r=!1,-1===l[1]&&logErrorNoLine("Need have to have matching number of  'startLoop' and 'endLoop' loop points.");break}}else if(s>=l[0]){t[o-1]=n,r=!0,1===l[1]&&logErrorNoLine("Need have to have matching number of  'startLoop' and 'endLoop' loop points.");break}}if(!1===r){t[e.rules.length]=n}e.loopPoint=t,t={},r=!0;for(var c=0;c<e.loops.length;c++)for(var l=e.loops[c],o=0;o<e.lateRules.length;o++){var u=e.lateRules[o],i=u[0],a=u[u.length-1],s=i.lineNumber;a.lineNumber;if(r){if(s>=l[0]){n=o,r=!1,-1===l[1]&&logErrorNoLine("Need have to have matching number of  'startLoop' and 'endLoop' loop points.");break}}else if(s>=l[0]){t[o-1]=n,r=!0,1===l[1]&&logErrorNoLine("Need have to have matching number of  'startLoop' and 'endLoop' loop points.");break}}if(!1===r){t[e.lateRules.length]=n}e.lateLoopPoint=t}function V(e){return null!==/^\s*\d+\s*$/.exec(e)}function U(e){for(var t={},r=[],n=[],l=[],o=[],i=0;i<e.sounds.length;i++){var a=e.sounds[i];if(!(a.length<=1)){var s=a[a.length-1];if(2!==a.length)if(de.indexOf(a[0])>=0){a.length>4&&logError("too much stuff to define a sound event",s);V(f=a[1])?(void 0!==t[a[0]]&&logError(a[0].toUpperCase()+" already declared.",s),t[a[0]]=a[1]):logError('Expecting sfx data, instead found "'+a[1]+'".',s)}else{var c=a[0].trim(),u=a[1].trim(),h=a.slice(2,a.length-2);h.length>0&&"move"!==u&&"cantmove"!==u&&logError("incorrect sound declaration.",s),"action"===u&&(u="move",h=["___action____"]),0==h.length&&(h=["orthogonal"]);var f=a[a.length-2];c in e.aggregatesDict?logError('cannot assign sound fevents to aggregate objects (declared with "and"), only to regular objects, or properties, things defined in terms of "or" ("'+c+'").',s):c in e.objectMasks||logError('Object "'+c+'" not found.',s);for(var g=e.objectMasks[c],d=0,p=0;p<h.length;p++){h[p]=h[p].trim();var v=h[p];if(-1===ve.indexOf(v))logError('Was expecting a direction, instead found "'+v+'".',s);else{d|=pe[v]}}for(var m=[c],b=!0;b;){b=!1;for(var y=0;y<m.length;y++){var w=m[y];if(w in e.synonymsDict)m[y]=e.synonymsDict[w],b=!0;else if(w in e.propertiesDict){b=!0;var _=e.propertiesDict[w];m.splice(y,1),y--;for(var x=0;x<_.length;x++)m.push(_[x])}}}if("move"===u||"cantmove"===u)for(p=0;p<m.length;p++){var k=m[p],C=e.objects[k].layer,M=new Z.BitVec(Q.globals.STRIDE_MOV);M.ishiftor(d,5*C);S={objectMask:g,directionMask:M,seed:f};"move"===u?l.push(S):o.push(S)}V(f)||logError('Expecting sfx data, instead found "'+f+'".',s);switch(u){case"create":S={objectMask:g,seed:f};r.push(S);break;case"destroy":var S={objectMask:g,seed:f};n.push(S)}}else logError("incorrect sound declaration.",s)}}e.sfx_Events=t,e.sfx_CreationMasks=r,e.sfx_DestructionMasks=n,e.sfx_MovementMasks=l,e.sfx_MovementFailureMasks=o}function J(e){if("background_color"in e.metadata?e.bgcolor=l(X,e.metadata.background_color):e.bgcolor="#000000","text_color"in e.metadata?e.fgcolor=l(X,e.metadata.text_color):e.fgcolor="#FFFFFF",!1===n(e.fgcolor)&&logError("text_color in incorrect format - found "+e.fgcolor+", but I expect a color name (like 'pink') or hex-formatted color (like '#1412FA')."),!1===n(e.bgcolor)&&logError("background_color in incorrect format - found "+e.bgcolor+", but I expect a color name (like 'pink') or hex-formatted color (like '#1412FA')."),$.globals.canSetHTMLColors&&("background_color"in e.metadata&&(document.body.style.backgroundColor=e.bgcolor),"text_color"in e.metadata)){var t=document.getElementById("separator");null!=t&&(t.style.color=e.fgcolor);for(var r=document.getElementsByTagName("a"),o=0;o<r.length;o++)r[o].style.color=e.fgcolor;for(var r=document.getElementsByTagName("h1"),o=0;o<r.length;o++)r[o].style.color=e.fgcolor}if("homepage"in e.metadata){var i=e.metadata.homepage;i=(i=i.replace("http://","")).replace("https://",""),e.metadata.homepage=i}}function Y(e){for(var t=new ee.codeMirrorFn,r=t.startState(),n=e.split("\n"),l=0;l<n.length;l++){var o=n[l];r.lineNumber=l+1;var a=new le.default.StringStream(o,4);do{if(t.token(a,r),ee.errorCount[0]>me)return void(0,$.consolePrint)("too many errors, aborting compilation")}while(!1===a.eol())}return delete r.lineNumber,i(r),B(r),s(r),g(r),q(r),T(r),A(r),R(r.rules),R(r.lateRules),D(r),N(r),H(r),F(r),j(r),G(r),U(r),J(r),delete r.commentLevel,delete r.names,delete r.abbrevNames,delete r.objects_candname,delete r.objects_section,delete r.objects_spritematrix,delete r.section,delete r.subsection,delete r.tokenIndex,delete r.visitedSections,delete r.loops,r}Object.defineProperty(t,"__esModule",{value:!0}),t.isColor=n,t.colorToHex=l,t.generateSpriteMatrix=o,t.generateExtraMembers=i,t.levelFromString=a,t.levelsToArray=s,t.directionalRule=c,t.processRuleString=u,t.deepCloneHS=h,t.deepCloneRule=f,t.rulesToArray=g,t.containsEllipsis=d,t.rewriteUpLeftRules=p,t.getPropertiesFromCell=v,t.getMovings=m,t.concretizePropertyInCell=b,t.concretizeMovingInCell=y,t.concretizeMovingInCellByAmbiguousMovementName=w,t.expandNoPrefixedProperties=_,t.concretizePropertyRule=x,t.concretizeMovingRule=k,t.rephraseSynonyms=C,t.atomizeAggregates=M,t.atomizeCellAggregates=S,t.convertRelativeDirsToAbsolute=E,t.absolutifyRuleCell=L,t.rulesToMask=T,t.cellRowMasks=I,t.collapseRules=R,t.ruleGroupRandomnessTest=O,t.arrangeRulesByGroupNumber=A,t.checkNoLateRulesHaveMoves=D,t.generateRigidGroupList=N,t.getMaskFromName=P,t.generateMasks=B,t.checkObjectsAreLayered=F,t.twiddleMetaData=j,t.processWinConditions=H,t.printCellRow=W,t.printRule=z,t.printRules=function(e){for(var t="<br>Rule Assembly : ("+e.rules.length+" rules )<br>===========<br>",r=0,n=-1,l=0;l<e.rules.length;l++){var o=e.rules[l];r<e.loops.length&&e.loops[r][0]<o.lineNumber&&(t+="STARTLOOP<br>",++r<e.loops.length&&(n=e.loops[r][0],r++)),-1!==n&&n<o.lineNumber&&(t+="ENDLOOP<br>",n=-1),t+=z(o)+"<br>"}-1!==n&&(t+="ENDLOOP<br>"),t+="===========<br>",(0,$.consolePrint)(t)},t.removeDuplicateRules=q,t.generateLoopPoints=G,t.validSeed=V,t.generateSoundData=U,t.formatHomePage=J,t.loadFile=Y,t.compile=function(e,t,r){Q.globals.matchCache={},te.globals.forceRegenImages=!0,void 0===e&&(e=["restart"]),void 0===r&&(r=null),te.globals.lastDownTarget=te.globals.canvas,!0===$.globals.canDump&&(compiledText=t),ee.errorCount[0]=0,ee.compiling[0]=!0,ee.errorStrings.splice(0,ee.errorStrings.length),(0,$.consolePrint)("=================================");try{var n=Y(t)}finally{ee.compiling[0]=!1}if(!(ee.errorCount[0]>me)){if(ee.errorCount[0]>0){(0,$.consoleError)('<span class="systemMessage">Errors detected during compilation, the game may not work correctly.</span>');for(var l in ee.errorStrings)(0,$.consoleError)(ee.errorStrings[l])}else{for(var o=0,i=0;i<n.rules.length;i++)o+=n.rules[i].length;for(i=0;i<n.lateRules.length;i++)o+=n.lateRules[i].length;"restart"==e[0]?(0,$.consolePrint)('<span class="systemMessage">Successful Compilation, generated '+o+" instructions.</span>"):(0,$.consolePrint)('<span class="systemMessage">Successful live recompilation, generated '+o+" instructions.</span>")}(0,Z.setGameState)(n,e,r),(0,$.clearInputHistory)(),(0,$.consoleCacheDump)()}},t.qualifyURL=function(e){var t=document.createElement("a");return t.href=e,t.href};var K,X,Q=r(5),Z=r(6),$=r(3),ee=r(10),te=r(2),re=r(4),ne=r(12),le=function(e){return e&&e.__esModule?e:{default:e}}(r(11));Z.Level.prototype.calcBackgroundMask=function(e){void 0===e.backgroundlayer&&logError("you have to have a background layer");for(var t=e.layerMasks[e.backgroundlayer],r=0;r<this.n_tiles;r++){var n=this.getCell(r);if(n.iand(t),!n.iszero())return n}return(n=new Z.BitVec(Q.globals.STRIDE_OBJ)).ibitset(e.backgroundid),n};var oe={horizontal:["left","right"],vertical:["up","down"],moving:["up","down","left","right","action"],orthogonal:["up","down","left","right"],perpendicular:["^","v"],parallel:["<",">"]},ie=["^","v","<",">","horizontal","vertical"],ae=["up","down","left","right"],se=["^","v","<",">"],ce=/^(\>|\<|\^|v|up|down|left|right|moving|stationary|no|randomdir|random|horizontal|vertical|orthogonal|perpendicular|parallel|action)$/,ue=["sfx0","sfx1","sfx2","sfx3","sfx4","sfx5","sfx6","sfx7","sfx8","sfx9","sfx10","cancel","checkpoint","restart","win","message","again"],he=["^","v","<",">","parallel","perpendicular"],fe={right:["up","down","left","right","horizontal","vertical"],up:["left","right","down","up","vertical","horizontal"],down:["right","left","up","down","vertical","horizontal"],left:["down","up","right","left","horizontal","vertical"]},ge={up:parseInt("00001",2),down:parseInt("00010",2),left:parseInt("00100",2),right:parseInt("01000",2),moving:parseInt("01111",2),no:parseInt("00011",2),randomdir:parseInt("00101",2),random:parseInt("10010",2),action:parseInt("10000",2),"":parseInt("00000",2)},de=["titlescreen","startgame","endgame","startlevel","undo","restart","endlevel","showmessage","closemessage","sfx0","sfx1","sfx2","sfx3","sfx4","sfx5","sfx6","sfx7","sfx8","sfx9","sfx10"],pe=(de.concat(["create","destroy","move","cantmove","action"]),{up:parseInt("00001",2),down:parseInt("00010",2),left:parseInt("00100",2),right:parseInt("01000",2),horizontal:parseInt("01100",2),vertical:parseInt("00011",2),orthogonal:parseInt("01111",2),___action____:parseInt("10000",2)}),ve=["up","down","left","right","horizontal","vertical","orthogonal","___action____"],me=5},function(e,t){function r(e,t,r){function n(){var e;return(i+=t)>=1&&(e=!0,i=1),r(i),e}function o(){var e;return(i-=t)<=0&&(e=!0,i=0),r(i),e}var i,a;return a={animateUp:function(){l.getInstance().animate(e,n)},animateDown:function(){l.getInstance().animate(e,o)}},i=0,a}Object.defineProperty(t,"__esModule",{value:!0});var n={};n.hasTouch=function(){var e;return("ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch)&&(e=!0),e},n.enable=function(e){return(e||n.hasTouch()&&!n._instance)&&(n._instance=new n.GestureHandler,n._instance.bindEvents(),n._instance.bootstrap()),n._instance},n.GestureHandler=function(){this.initialize.apply(this,arguments)},n.log=function(e){document.getElementsByTagName("h1")[0].innerHTML=Math.random().toString().substring(4,1)+"-"+e},n.debugDot=function(e){var t,r;r="border-radius: 50px;width: 5px;height: 5px;background: red;position: absolute;left: "+e.touches[0].clientX+"px;top: "+e.touches[0].clientY+"px;",(t=document.createElement("div")).setAttribute("style",r),document.getElementsByTagName("body")[0].appendChild(t)},function(e){"use strict";var t={action:88,left:37,right:39,up:38,down:40,undo:85,restart:82,quit:27},n=['<div class="tab">','  <div class="tab-affordance"></div>','  <div class="tab-icon">','    <div class="slice"></div>','    <div class="slice"></div>',"  </div>","</div>"].join("\n");e.initialize=function(){this.firstPos={x:0,y:0},this.setTabAnimationRatio=this.setTabAnimationRatio.bind(this),this.setMenuAnimationRatio=this.setMenuAnimationRatio.bind(this),this.repeatTick=this.repeatTick.bind(this),this.isFocused=!0},e.setFocusElement=function(e){this.focusElement=e,this.isFocused=!1,this.buildFocusIndicator()},e.bindEvents=function(){window.addEventListener("touchstart",this.onTouchStart.bind(this)),window.addEventListener("touchend",this.onTouchEnd.bind(this)),window.addEventListener("touchmove",this.onTouchMove.bind(this))},e.bootstrap=function(){this.showTab(),this.isAudioSupported()||this.disableAudio(),this.disableSelection()},e.onTouchStart=function(e){this.isTouching||(this.handleFocusChange(e),this.isFocused&&"A"!==e.target.tagName.toUpperCase()&&(this.isTouching=!0,this.mayBeSwiping=!0,this.gestured=!1,this.swipeDirection=void 0,this.swipeDistance=0,this.startTime=(new Date).getTime(),this.firstPos.x=e.touches[0].clientX,this.firstPos.y=e.touches[0].clientY))},e.onTouchEnd=function(e){this.isFocused&&this.isTouching&&(this.gestured||0===e.touches.length&&this.handleTap(),0===e.touches.length&&(this.isTouching=!1,this.endRepeatWatcher()))},e.onTouchMove=function(e){if(this.isFocused)return this.isSuccessfulSwipe()?(this.handleSwipe(this.swipeDirection,this.touchCount),this.gestured=!0,this.mayBeSwiping=!1,this.beginRepeatWatcher(e)):this.mayBeSwiping?this.swipeStep(e):this.isRepeating&&this.repeatStep(e),prevent(e),!1},e.handleFocusChange=function(e){this.focusElement&&(this.isFocused=this.isTouchInsideFocusElement(e),this.setFocusIndicatorVisibility(this.isFocused))},e.isTouchInsideFocusElement=function(e){var t;return!(!e.touches||!e.touches[0])&&(t=this.absoluteElementPosition(this.focusElement),!(e.touches[0].clientX<t.left||e.touches[0].clientY<t.top)&&!(e.touches[0].clientX>t.left+this.focusElement.clientWidth||e.touches[0].clientY>t.top+this.focusElement.clientHeight))},e.setFocusIndicatorVisibility=function(e){var t;t="visible",e||(t="hidden"),this.focusIndicator.setAttribute("style","visibility: "+t+";")},e.absoluteElementPosition=function(e){var t,r;for(t={top:e.offsetTop||0,left:e.offsetLeft||0},r=document.getElementsByTagName("body")[0],t.top-=r.scrollTop||0;;){if(!(e=e.offsetParent))break;t.top+=e.offsetTop||0,t.left+=e.offsetLeft||0}return t},e.beginRepeatWatcher=function(e){var t;this.repeatInterval||(this.isRepeating=!0,t=1e3*state.metadata.key_repeat_interval,!isNaN(t)&&t||(t=150),this.repeatInterval=setInterval(this.repeatTick,t),this.recenter(e))},e.endRepeatWatcher=function(){this.repeatInterval&&(clearInterval(this.repeatInterval),delete this.repeatInterval,this.isRepeating=!1)},e.repeatTick=function(){this.isTouching&&this.handleSwipe(this.direction,this.touchCount)},e.recenter=function(e){this.firstPos.x=e.touches[0].clientX,this.firstPos.y=e.touches[0].clientY},e.isSuccessfulSwipe=function(){var e;return this.mayBeSwiping&&void 0!==this.swipeDirection&&this.swipeDistance>=50&&(e=!0),e},e.swipeStep=function(e){var t,r,n;this.mayBeSwiping&&(t={x:e.touches[0].clientX,y:e.touches[0].clientY},r=(new Date).getTime(),n=e.touches.length,this.swipeDistance=this.cardinalDistance(this.firstPos,t),this.swipeDirection?r-this.startTime>1e3&&(this.mayBeSwiping=!1):this.swipeDistance>10&&(this.swipeDirection=this.dominantDirection(this.firstPos,t),this.touchCount=n))},e.repeatStep=function(e){var t;t={x:e.touches[0].clientX,y:e.touches[0].clientY},this.cardinalDistance(this.firstPos,t)>=50&&(this.swipeDirection=this.dominantDirection(this.firstPos,t),this.recenter(e))},e.cardinalDistance=function(e,t){var r,n;return r=Math.abs(e.x-t.x),n=Math.abs(e.y-t.y),Math.max(r,n)},e.dominantDirection=function(e,t){var r,n,l;return r=t.x-e.x,n=t.y-e.y,l="x",Math.abs(n)>Math.abs(r)&&(l="y"),"x"===l?r>0?"right":"left":n>0?"down":"up"},e.handleSwipe=function(e,t){1===t?this.emitKeydown(this.swipeDirection):t>1&&this.toggleMenu()},e.handleTap=function(){this.emitKeydown("action")},e.emitKeydown=function(e){var r;r={keyCode:t[e]},this.fakeCanvasFocus(),onKeyDown(r),onKeyUp(r)},e.fakeCanvasFocus=function(){var e;e=document.getElementById("gameCanvas"),onMouseDown({button:0,target:e})},e.toggleMenu=function(){this.isMenuVisible?this.hideMenu():this.showMenu()},e.showMenu=function(){this.menuElem||this.buildMenu(),this.getAnimatables().menu.animateUp(),this.isMenuVisible=!0,this.hideTab()},e.hideMenu=function(){this.menuElem&&this.getAnimatables().menu.animateDown(),this.isMenuVisible=!1,this.showTab()},e.getAnimatables=function(){var e=this;return this._animatables||(this._animatables={tab:r("tab",.1,e.setTabAnimationRatio),menu:r("menu",.1,e.setMenuAnimationRatio)}),this._animatables},e.showTab=function(){this.tabElem||this.buildTab(),this.getAnimatables().tab.animateDown()},e.hideTab=function(){this.tabElem&&this.tabElem.setAttribute("style","display: none;"),this.getAnimatables().tab.animateUp()},e.buildTab=function(){var e,t,r,l=this;(e=document.createElement("div")).innerHTML=n,r=e.children[0],t=function(e){e.stopPropagation(),l.showMenu()},this.tabAffordance=r.getElementsByClassName("tab-affordance")[0],this.tabElem=r.getElementsByClassName("tab-icon")[0],this.tabAffordance.addEventListener("touchstart",t),this.tabElem.addEventListener("touchstart",t),document.getElementsByTagName("body")[0].appendChild(r)},e.buildMenu=function(){var e,t,r,n,l,o=this;(e=document.createElement("div")).innerHTML=this.buildMenuString(state),this.menuElem=e.children[0],this.closeElem=this.menuElem.getElementsByClassName("close")[0],l=function(e){e.stopPropagation(),o.hideMenu()},this.closeAffordance=this.menuElem.getElementsByClassName("close-affordance")[0],n=this.menuElem.getElementsByClassName("close")[0],this.closeAffordance.addEventListener("touchstart",l),n.addEventListener("touchstart",l),(t=this.menuElem.getElementsByClassName("undo")[0])&&t.addEventListener("touchstart",function(e){e.stopPropagation(),o.emitKeydown("undo")}),(r=this.menuElem.getElementsByClassName("restart")[0])&&r.addEventListener("touchstart",function(e){e.stopPropagation(),o.emitKeydown("restart")}),this.menuElem.getElementsByClassName("quit")[0].addEventListener("touchstart",function(e){e.stopPropagation(),o.emitKeydown("quit")}),document.getElementsByTagName("body")[0].appendChild(this.menuElem)},e.buildMenuString=function(e){var t,r,n,l;return n=e.metadata.noundo,l=e.metadata.norestart,t=3,n&&(t-=1),l&&(t-=1),r=['<div class="mobile-menu item-count-'+t+'">','  <div class="close-affordance"></div>','  <div class="close">','    <div class="slice"></div>','    <div class="slice"></div>',"  </div>"],n||r.push('  <div class="undo button">Undo</div>'),l||r.push('  <div class="restart button">Restart</div>'),(r=r.concat(['  <div class="quit button">Quit to Menu</div>','  <div class="clear"></div>',"</div>"])).join("\n")},e.buildFocusIndicator=function(){this.focusIndicator=document.createElement("DIV"),this.focusIndicator.setAttribute("class","tapFocusIndicator"),this.focusIndicator.setAttribute("style","visibility: hidden;"),this.focusElement.parentNode.appendChild(this.focusIndicator)},e.setTabAnimationRatio=function(e){var t;(e=Math.round(1e3*e)/1e3)>=.999?this.tabAffordance.setAttribute("style","display: none;"):this.tabAffordance.setAttribute("style","display: block;"),t="opacity: "+(1-e)+";"+" width: "+(66*e+18*(1-e))+"px;",this.tabElem.setAttribute("style",t)},e.setMenuAnimationRatio=function(e){var t,r,n;(e=Math.round(1e3*e)/1e3)<=.001?this.closeAffordance.setAttribute("style","display: none;"):this.closeAffordance.setAttribute("style","display: block;"),n="left: "+((t=-18*e+-66*(1-e))-4)+"px; "+(r="opacity: "+e+";")+" width: "+-t+"px;",this.closeElem.setAttribute("style",n),this.menuElem.setAttribute("style",r)},e.disableAudio=function(){window.playSeed=function(){}},e.isAudioSupported=function(){var e=!0;return webkitAudioContext&&(e=!1),e},e.disableSelection=function(){var e;(e=document.getElementsByTagName("body")[0]).setAttribute("class",e.getAttribute("class")+" disable-select")}}(n.GestureHandler.prototype);var l=function(){this.initialize.apply(this,arguments)};!function(e){e.initialize=function(){this._animations={},this.tick=this.tick.bind(this)},e.animate=function(e,t){this._animations[e]=t,this.wakeup()},e.wakeup=function(){this._isAnimating||(this._isAnimating=!0,this.tick())},e.tick=function(){var e,t,r,n;r=[],t=!0;for(e in this._animations){if(!this._animations.hasOwnProperty(e))return;this._animations[e]()?r.push(e):t=!1}if(t){for(n=0;n<r.length;r++)delete this._isAnimating[r[n]];this._isAnimating=!1}else requestAnimationFrame(this.tick)}}(l.prototype),l.getInstance=function(){return l._instance||(window.Animator._instance=new window.Animator),window.Animator._instance},function(){"use strict";var e,t,r=["ms","moz","webkit","o"];for(e=0;e<r.length&&!window.requestAnimationFrame;e++)window.requestAnimationFrame=window[r[e]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[r[e]+"CancelAnimationFrame"],window.cancelAnimationFrame||(window.cancelAnimationFrame=window[r[e]+"CancelRequestAnimationFrame"]);window.requestAnimationFrame||(t=0,window.requestAnimationFrame=function(e,r){var n,l,o;return n=(new Date).getTime(),l=Math.max(0,16-(n-t)),o=window.setTimeout(function(){e(n+l)},l),t=n+l,o}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),t.default=n,e.exports=t.default},function(e,t,r){function n(e,t,r){backups.push(backupLevel());var n=e.clone();e.width+=t,e.height+=r,e.n_tiles=e.width*e.height,e.objects=new Int32Array(e.n_tiles*x.globals.STRIDE_OBJ);var l=new BitVec(x.globals.STRIDE_OBJ);l.ibitset(x.globals.state.backgroundid);for(var o=0;o<e.n_tiles;++o)e.setCell(o,l);return e.movements=new Int32Array(e.objects.length),I=!0,RebuildLevelArrays(),n}function l(e,t){for(var r,n=-1,l=0;l<t.length;++l){var o=t[l][0],i=t[l][1];if(i.bitsSetInArray(e.data)){for(var a=0,s=0;s<32*x.globals.STRIDE_OBJ;++s)i.get(s)&&e.get(s)&&a++;a>n&&(n=a,r=o)}}return n>0?r:(logErrorNoLine("Wasn't able to approximate a glyph value for some tiles, using '.' as a placeholder.",!0),".")}function o(){var e=[];for(var t in x.globals.state.glyphDict)if(x.globals.state.glyphDict.hasOwnProperty(t)&&1===t.length){for(var r=x.globals.state.glyphDict[t],n=new BitVec(x.globals.STRIDE_OBJ),o=0;o<r.length;o++){var i=r[o];i>=0&&n.ibitset(i)}e.push([t,n.clone()]);var a=x.globals.state.layerMasks[x.globals.state.backgroundlayer];n.iclear(a),e.push([t,n.clone()]);for(o=0;o<32;o++){a.get(o)&&(n.ibitset(o),e.push([t,n.clone()]),n.ibitclear(o))}}var s="selectable"+ ++O,c='Printing GAME.level contents:<br><br><span id="'+s+'" onclick="selectText(\''+s+"',event)\">";k.globals.cache_console_messages=!1;for(var u=0;u<k.globals.level.height;u++){for(o=0;o<k.globals.level.width;o++){var h=u+o*k.globals.level.height;(r=l(k.globals.level.getCell(h),e))in R&&(r=R[r]),c+=r}u<k.globals.level.height-1&&(c+="<br>")}c+="</span><br>",consolePrint(c,!0)}function i(e,t){if(N<=-2){var r=editorRowCount-(-N-2)-1,l=D+(x.globals.screenwidth-1)*r;-1===D?o():D>=0&&l<glyphImages.length&&(glyphSelectedIndex=l,(0,y.redraw)())}else if(D>-1&&N>-1&&D<x.globals.screenwidth-2&&N<x.globals.screenheight-2-editorRowCount){for(var i=glyphImagesCorrespondance[glyphSelectedIndex],a=x.globals.state.glyphDict[i],s=new BitVec(x.globals.STRIDE_OBJ),c=0;c<a.length;c++){var u=a[c];u>=0&&s.ibitset(u)}var h=x.globals.state.layerMasks[x.globals.state.backgroundlayer];s.bitsClearInArray(h)&&s.ibitset(state.backgroundid);var f=N+D*k.globals.level.height;if(k.globals.level.getCell(f).equals(s))return;!1===A&&(A=!0,backups.push(backupLevel())),k.globals.level.setCell(f,s),(0,y.redraw)()}else t&&(-1===D?(!function(){for(var e=n(k.globals.level,1,0),t=1;t<k.globals.level.width;++t)for(var r=0;r<k.globals.level.height;++r){var l=t*k.globals.level.height+r;k.globals.level.setCell(l,e.getCell(l-k.globals.level.height))}}(),(0,y.canvasResize)()):D===x.globals.screenwidth-2&&(!function(){for(var e=n(k.globals.level,1,0),t=0;t<k.globals.level.width-1;++t)for(var r=0;r<k.globals.level.height;++r){var l=t*k.globals.level.height+r;k.globals.level.setCell(l,e.getCell(l))}}(),(0,y.canvasResize)()),-1===N?(!function(){for(var e=n(k.globals.level,0,1),t=0;t<k.globals.level.width;++t)for(var r=1;r<k.globals.level.height;++r){var l=t*k.globals.level.height+r;k.globals.level.setCell(l,e.getCell(l-t-1))}}(),(0,y.canvasResize)()):N===x.globals.screenheight-2-editorRowCount&&(!function(){for(var e=n(k.globals.level,0,1),t=0;t<k.globals.level.width;++t)for(var r=0;r<k.globals.level.height-1;++r){var l=t*k.globals.level.height+r;k.globals.level.setCell(l,e.getCell(l-t))}}(),(0,y.canvasResize)()))}function a(e,t){if(-2===N)D<=glyphImages.length&&(glyphSelectedIndex=D,(0,y.redraw)());else if(D>-1&&N>-1&&D<x.globals.screenwidth-2&&N<x.globals.screenheight-2-editorRowCount){var r=N+D*k.globals.level.height,l=new BitVec(x.globals.STRIDE_OBJ);l.ibitset(state.backgroundid),k.globals.level.setCell(r,l),(0,y.redraw)()}else t&&(-1===D?(!function(){if(!(k.globals.level.width<=1))for(var e=n(k.globals.level,-1,0),t=0;t<k.globals.level.width;++t)for(var r=0;r<k.globals.level.height;++r){var l=t*k.globals.level.height+r;k.globals.level.setCell(l,e.getCell(l+k.globals.level.height))}}(),(0,y.canvasResize)()):D===x.globals.screenwidth-2&&(!function(){if(!(k.globals.level.width<=1))for(var e=n(k.globals.level,-1,0),t=0;t<k.globals.level.width;++t)for(var r=0;r<k.globals.level.height;++r){var l=t*k.globals.level.height+r;k.globals.level.setCell(l,e.getCell(l))}}(),(0,y.canvasResize)()),-1===N?(!function(){if(!(k.globals.level.height<=1))for(var e=n(k.globals.level,0,-1),t=0;t<k.globals.level.width;++t)for(var r=0;r<k.globals.level.height;++r){var l=t*k.globals.level.height+r;k.globals.level.setCell(l,e.getCell(l+t+1))}}(),(0,y.canvasResize)()):N===x.globals.screenheight-2-editorRowCount&&(!function(){if(!(k.globals.level.height<=1))for(var e=n(k.globals.level,0,-1),t=0;t<k.globals.level.width;++t)for(var r=0;r<k.globals.level.height;++r){var l=t*k.globals.level.height+r;k.globals.level.setCell(l,e.getCell(l+t))}}(),(0,y.canvasResize)()))}function s(e){if(0!==e.button||e.ctrlKey||e.metaKey){if((2===e.button||0===e.button&&(e.ctrlKey||e.metaKey))&&"gameCanvas"===e.target.id&&(L=!1,T=!0,k.globals.levelEditorOpened))return a(0,!0)}else{if(_.globals.lastDownTarget=e.target,k.globals.keybuffer=[],e.target===_.globals.canvas&&(p(e),L=!0,T=!1,k.globals.levelEditorOpened))return A=!1,i(0,!0);L=!1,T=!1}}function c(e){L=!1,T=!1}function u(e){e=e||window.event,!w.globals.IDE&&[32,37,38,39,40].indexOf(e.keyCode)>-1&&v(e),k.globals.keybuffer.indexOf(e.keyCode)>=0||(_.globals.lastDownTarget===_.globals.canvas&&-1===k.globals.keybuffer.indexOf(e.keyCode)&&(k.globals.keybuffer.splice(M,0,e.keyCode),C=0,m(e,!0)),!0===w.globals.canDump&&(74===e.keyCode&&(e.ctrlKey||e.metaKey)?(dumpTestCase(),v(e)):75===e.keyCode&&(e.ctrlKey||e.metaKey)&&(makeGIF(),v(e))))}function h(e){var t=0,r=0,n=0,l=0,o=this;do{t+=o.offsetLeft-o.scrollLeft,r+=o.offsetTop-o.scrollTop}while(o=o.offsetParent);return n=e.pageX-t,l=e.pageY-r,{x:n,y:l}}function f(e){e=e||window.event;var t=k.globals.keybuffer.indexOf(e.keyCode);t>=0&&(k.globals.keybuffer.splice(t,1),M>=t&&M--)}function g(e){k.globals.keybuffer=[],M=0,C=0}function d(e){k.globals.keybuffer=[],M=0,C=0}function p(e){var t=_.globals.canvas.relMouseCoords(e);D=t.x-x.globals.xoffset,N=t.y-x.globals.yoffset,D=Math.floor(D/x.globals.cellwidth),N=Math.floor(N/x.globals.cellheight)}function v(e){return e.preventDefault&&e.preventDefault(),e.stopImmediatePropagation&&e.stopImmediatePropagation(),e.stopPropagation&&e.stopPropagation(),e.returnValue=!1,!1}function m(e,t){if(!k.globals.winning){var r=-1;switch(e.keyCode){case 65:case 37:r=1;break;case 38:case 87:r=0;break;case 68:case 39:r=3;break;case 83:case 40:r=2;break;case 13:case 32:case 67:case 88:if(!1!==k.globals.norepeat_action&&!t)return;r=4;break;case 85:case 90:if(!1===x.globals.textMode)return(0,w.pushInput)("undo"),(0,b.DoUndo)(),(0,y.canvasResize)(),v(e);break;case 82:if(!1===x.globals.textMode&&t)return(0,w.pushInput)("restart"),(0,b.DoRestart)(),(0,y.canvasResize)(),v(e);break;case 27:if(!1===x.globals.titleScreen)return x.globals.goToTitleScreen(),tryPlayTitleSound(),(0,y.canvasResize)(),v(e);break;case 69:if(canOpenEditor)return t&&(k.globals.levelEditorOpened=!k.globals.levelEditorOpened,restartTarget=backupLevel(),(0,y.canvasResize)()),v(e);break;case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:if(k.globals.levelEditorOpened&&t){var n=9;return e.keyCode>=49&&(n=e.keyCode-49),n<glyphImages.length?glyphSelectedIndex=n:consolePrint("Trying to select tile outside of range in GAME.level editor.",!0),(0,y.canvasResize)(),v(e)}}if(k.globals.throttle_movement&&r>=0&&r<=3){if(E==r&&S<k.globals.repeatinterval)return;E=r,S=0}if(x.globals.textMode){if(0===x.globals.state.levels.length);else if(x.globals.titleScreen)0===x.globals.titleMode?4===r&&t&&!1===x.globals.titleSelected&&((0,b.tryPlayStartGameSound)(),x.globals.titleSelected=!0,k.globals.messageselected=!1,k.globals.timer=0,k.globals.quittingTitleScreen=!0,(0,b.generateTitleScreen)(),(0,y.canvasResize)()):4==r&&t?!1===x.globals.titleSelected&&((0,b.tryPlayStartGameSound)(),x.globals.titleSelected=!0,k.globals.messageselected=!1,k.globals.timer=0,k.globals.quittingTitleScreen=!0,(0,b.generateTitleScreen)(),(0,y.redraw)()):0!==r&&2!==r||(x.globals.titleSelection=1-x.globals.titleSelection,(0,b.generateTitleScreen)(),(0,y.redraw)());else if(4==r&&t){if(k.globals.unitTesting)return void(0,b.nextLevel)();!1===k.globals.messageselected&&(k.globals.messageselected=!0,k.globals.timer=0,k.globals.quittingMessageScreen=!0,(0,b.tryPlayCloseMessageSound)(),x.globals.titleScreen=!1,(0,b.drawMessageScreen)())}}else if(!k.globals.againing&&r>=0)return 4===r&&"noaction"in x.globals.state.metadata||((0,w.pushInput)(r),(0,b.processInput)(r)&&(0,y.redraw)()),v(e)}}Object.defineProperty(t,"__esModule",{value:!0}),t.relMouseCoords=h,t.startGameLoop=function(){P=setInterval(function(){!function(){if(k.globals.timer+=k.globals.deltatime,S+=k.globals.deltatime,k.globals.quittingTitleScreen&&k.globals.timer/1e3>.3&&(k.globals.quittingTitleScreen=!1,(0,b.nextLevel)()),k.globals.againing&&k.globals.timer>k.globals.againinterval&&0==x.globals.messagetext.length&&(0,b.processInput)(-1)&&((0,y.redraw)(),C=0,k.globals.autotick=0),k.globals.quittingMessageScreen&&k.globals.timer/1e3>.15&&(k.globals.quittingMessageScreen=!1,""===x.globals.messagetext?(0,b.nextLevel)():(x.globals.messagetext="",x.globals.textMode=!1,x.globals.titleScreen=!1,x.globals.titleMode=k.globals.curlevel>0||null!==k.globals.curlevelTarget?1:0,x.globals.titleSelected=!1,x.globals.titleSelection=0,(0,y.canvasResize)(),(0,b.checkWin)())),k.globals.winning&&k.globals.timer/1e3>.5&&(k.globals.winning=!1,(0,b.nextLevel)()),k.globals.keybuffer.length>0){C+=k.globals.deltatime;var e=k.globals.throttle_movement?k.globals.repeatinterval:k.globals.repeatinterval/Math.sqrt(k.globals.keybuffer.length);C>e&&(C=0,M=(M+1)%k.globals.keybuffer.length,m({keyCode:k.globals.keybuffer[M]},!1))}!(k.globals.autotickinterval>0)||x.globals.textMode||k.globals.levelEditorOpened||k.globals.againing||k.globals.winning||(k.globals.autotick+=k.globals.deltatime,k.globals.autotick>k.globals.autotickinterval&&(k.globals.autotick=0,(0,w.pushInput)("tick"),(0,b.processInput)(-1)&&(0,y.redraw)()))}()},k.globals.deltatime)},t.stopGameLoop=function(){clearInterval(P)},t.addListeners=function(e){document.addEventListener("mousedown",s,!1),document.addEventListener("mouseup",c,!1),document.addEventListener("keydown",u,!1),document.addEventListener("keyup",f,!1),e.addEventListener("focus",g,!1),e.addEventListener("blur",d,!1)},t.removeListeners=function(e){document.removeEventListener("mousedown",s),document.removeEventListener("mouseup",c),document.removeEventListener("keydown",u),document.removeEventListener("keyup",f),e.removeEventListener("focus",g),e.removeEventListener("blur",d)};var b=r(6),y=r(8),w=r(3),_=r(2),x=r(5),k=r(4),C=0,M=0,S=0,E=-100,L=!1,T=!1,I=!1,R={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"},O=0,A=!1;HTMLCanvasElement.prototype.relMouseCoords=h;var D=0,N=0,P=null}])})},667:function(e,t,r){var n=r(2053);e.exports=n}});